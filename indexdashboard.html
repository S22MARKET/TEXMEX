<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEXMEX - لوحة التحكم</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f0f2f5; }
        .hidden { display: none; }
        .active-tab { background-color: #ea580c; color: white; }
        .dashboard-panel { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 40; display: flex; align-items: center; justify-content: center; }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 700px; z-index: 50; max-height: 90vh; overflow-y: auto; }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 100; }
        .toast { background-color: #2d3748; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-top: 10px; display: flex; align-items: center; gap: 10px; animation: slideInUp 0.3s ease, fadeOut 0.5s ease 2.5s forwards; }
        .toast.success { background-color: #2f855a; }
        .toast.error { background-color: #c53030; }
        @keyframes slideInUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #48bb78; }
        input:checked + .slider:before { transform: translateX(24px); }
        .spinner { width: 24px; height: 24px; border: 4px solid rgba(255, 255, 255, 0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; }
        .spinner-dark { width: 24px; height: 24px; border: 4px solid rgba(0,0,0, 0.1); border-top-color: #333; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 768px) { .responsive-table thead { display: none; } .responsive-table tr { display: block; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; } .responsive-table td { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6; } .responsive-table td:last-child { border-bottom: none; } .responsive-table td::before { content: attr(data-label); font-weight: 600; margin-left: 0.5rem; } }
        .filter-btn { padding: 8px 16px; border-radius: 8px; border: 1px solid #ddd; background-color: white; transition: all 0.2s; }
        .filter-btn.active { background-color: #f97316; color: white; border-color: #f97316; }
    </style>
</head>
<body>

    <div id="dashboard-page">
        <div class="relative min-h-screen md:flex">
            <aside id="sidebar" class="bg-gray-800 text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 right-0 transform translate-x-full md:relative md:translate-x-0 transition duration-300 ease-in-out z-30">
                <div class="p-3 text-center border-b border-gray-700">
                    <h2 class="text-2xl font-bold">TEX<span class="text-orange-400">MEX</span></h2>
                </div>
                <nav class="flex-1 p-2 space-y-2">
                    <a href="#dashboard" class="dashboard-tab active-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-tachometer-alt fa-fw ml-3"></i> اللوحة الرئيسية</a>
                    <a href="#orders" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-clipboard-list fa-fw ml-3"></i> الطلبات الواردة</a>
                    <a href="#menu-items" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-utensils fa-fw ml-3"></i> قائمة الطعام</a>
                    <a href="#offers" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-star fa-fw ml-3"></i> العروض والباقات</a>
                    <a href="#categories" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-sitemap fa-fw ml-3"></i> الأقسام</a>
                    <a href="#delivery-personnel" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-biking fa-fw ml-3"></i> عمال التوصيل</a>
                    <a href="#stats" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-chart-line fa-fw ml-3"></i> الإحصائيات</a>
                    <a href="#delivery" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-motorcycle fa-fw ml-3"></i> إعدادات التوصيل</a>
                    <a href="#settings" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-cogs fa-fw ml-3"></i> إعدادات المطعم</a>
                </nav>
            </aside>
            <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden hidden"></div>
            
            <div class="flex-1 flex flex-col">
                <header class="bg-white shadow-md p-4 flex justify-between items-center">
                    <h1 class="text-xl font-bold">TEX<span class="text-orange-500">MEX</span> Dashboard</h1>
                    <button id="mobile-menu-btn" class="text-gray-800 p-2 rounded-lg md:hidden"><i class="fas fa-bars fa-lg"></i></button>
                </header>
                <main class="flex-1 p-4 md:p-8 overflow-y-auto">
                    <div id="dashboard-panel" class="dashboard-panel"></div>
                    <div id="orders-panel" class="dashboard-panel hidden"></div>
                    <div id="menu-items-panel" class="dashboard-panel hidden"></div>
                    <div id="offers-panel" class="dashboard-panel hidden"></div>
                    <div id="categories-panel" class="dashboard-panel hidden"></div>
                    <div id="delivery-personnel-panel" class="dashboard-panel hidden"></div>
                    <div id="stats-panel" class="dashboard-panel hidden"></div>
                    <div id="delivery-panel" class="dashboard-panel hidden"></div>
                    <div id="settings-panel" class="dashboard-panel hidden"></div>
                </main>
            </div>
        </div>
    </div>

    <div id="modal-container"></div>
    <div id="toast-container"></div>
    <audio id="notification-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-notification-947.mp3" preload="auto"></audio>

    <script type="module">
        // --- FIREBASE INITIALIZATION ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, serverTimestamp, orderBy, getDoc, setDoc, getDocs, where, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAsG-85oNZq8kzWPHIDpsifkQ7rhua_oPk",
            authDomain: "texmexfoodannaba23.firebaseapp.com",
            projectId: "texmexfoodannaba23",
            storageBucket: "texmexfoodannaba23.appspot.com",
            messagingSenderId: "712480664933",
            appId: "1:712480664933:web:a5310190bf63115ac9058c",
            measurementId: "G-38D210X1EG"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- GLOBAL CACHES & STATE ---
        let categoriesCache = [];
        let deliveryPersonnelCache = [];
        let menuItemsCache = [];
        let offersCache = [];
        let ordersCache = [];
        let deliveryZonesCache = [];
        let isInitialOrdersLoad = true;
        let selectedFileStore = null;
        let currentOrderStatusFilter = 'all';

        // --- UI & UX HELPERS (MODAL, TOAST) ---
        const showModal = (title, content, onConfirm, confirmText = 'حفظ', showCancel = true) => {
            const modalContainer = document.getElementById('modal-container');
            const confirmButtonHtml = onConfirm ? `<button id="modal-confirm" class="bg-orange-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-orange-700 flex items-center gap-2">${confirmText}</button>` : '';
            const cancelButtonHtml = showCancel ? `<button id="modal-cancel" class="bg-gray-200 px-6 py-2 rounded-lg font-semibold hover:bg-gray-300">إلغاء</button>` : '';
            
            modalContainer.innerHTML = `
                <div class="modal-backdrop" id="modal-backdrop">
                    <div class="modal-content">
                        <div class="flex justify-between items-center mb-4 border-b pb-3"><h3 class="text-xl font-bold">${title}</h3><button id="modal-close-btn" class="text-2xl">&times;</button></div>
                        <div id="modal-body">${content}</div>
                        <div class="flex justify-end gap-4 mt-6 border-t pt-4">
                            ${cancelButtonHtml}
                            ${confirmButtonHtml}
                        </div>
                    </div>
                </div>`;

            const close = () => modalContainer.innerHTML = '';
            if (showCancel) document.getElementById('modal-cancel').onclick = close;
            document.getElementById('modal-close-btn').onclick = close;
            document.getElementById('modal-backdrop').onclick = e => { if (e.target.id === 'modal-backdrop') close(); };
            if (onConfirm) document.getElementById('modal-confirm').onclick = onConfirm;
        };

        const closeModal = () => document.getElementById('modal-container').innerHTML = '';
        const showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-times-circle';
            toast.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };
        const setButtonLoading = (btn, isLoading, text = 'حفظ') => {
            if (isLoading) {
                btn.disabled = true;
                btn.innerHTML = `<div class="spinner"></div><span>جاري الحفظ...</span>`;
            } else {
                btn.disabled = false;
                btn.innerHTML = text;
            }
        };

        // --- IMAGE UPLOAD & COMPRESSION HELPERS (IMPROVED) ---
        async function compressImage(file, maxWidth = 1024) {
            console.log(`Original size: ${(file.size / 1024).toFixed(2)} KB`);
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scaleSize = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        ctx.canvas.toBlob((blob) => {
                           const compressedFile = new File([blob], file.name, { type: 'image/jpeg', lastModified: Date.now() });
                           console.log(`Compressed size: ${(compressedFile.size / 1024).toFixed(2)} KB`);
                           resolve(compressedFile);
                        }, 'image/jpeg', 0.8);
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }
        
        async function uploadImageToImgBB(file) {
            const apiKey = '10cb4fda942ce7147252dc316751b47c';
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, {
                    method: 'POST',
                    body: formData
                });
                if (!response.ok) {
                    return { success: false, error: `فشل الاتصال بالخادم: (${response.status}) ${response.statusText}` };
                }
                const result = await response.json();
                if (result.success) {
                    return { success: true, url: result.data.url };
                } else {
                    return { success: false, error: `خطأ من خدمة رفع الصور: ${result.error.message}` };
                }
            } catch (error) {
                console.error('Image upload network error:', error);
                return { success: false, error: `خطأ في الشبكة. تأكد من اتصالك بالإنترنت.` };
            }
        }

        // --- DASHBOARD INITIALIZATION & NAVIGATION ---
        function initializeDashboard() {
            const tabs = document.querySelectorAll('.dashboard-tab');
            const panels = document.querySelectorAll('.dashboard-panel');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');

            const switchTab = (hash) => {
                const targetId = hash.substring(1) + '-panel';
                tabs.forEach(t => t.classList.toggle('active-tab', t.getAttribute('href') === hash));
                panels.forEach(p => p.classList.toggle('hidden', p.id !== targetId));
                if (hash === '#stats') {
                    loadStats(); 
                }
            };

            tabs.forEach(tab => tab.addEventListener('click', e => {
                e.preventDefault();
                const hash = tab.getAttribute('href');
                window.location.hash = hash;
                if (window.innerWidth < 768) {
                    sidebar.classList.add('translate-x-full');
                    overlay.classList.add('hidden');
                }
            }));
            
            window.addEventListener('hashchange', () => switchTab(window.location.hash || '#dashboard'));
            mobileMenuBtn.onclick = () => { sidebar.classList.remove('translate-x-full'); overlay.classList.remove('hidden'); };
            overlay.onclick = () => { sidebar.classList.add('translate-x-full'); overlay.classList.add('hidden'); };

            loadDashboardSummary();
            loadDeliveryPersonnel();
            loadOrders();
            loadMenuItems();
            loadOffers();
            loadCategories();
            loadDeliverySettings();
            loadRestaurantSettings();
            
            switchTab(window.location.hash || '#dashboard');
        }

        // --- MAIN DASHBOARD SUMMARY ---
        async function loadDashboardSummary() {
            const panel = document.getElementById('dashboard-panel');
            panel.innerHTML = `<h1 class="text-3xl font-bold text-gray-800 mb-6">ملخص اليوم</h1><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="summary-cards"><div class="bg-white p-6 rounded-xl shadow-md text-center col-span-full"><div class="spinner-dark mx-auto"></div></div></div>`;
            const cardsContainer = document.getElementById('summary-cards');
            const renderCards = (data) => {
                cardsContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-4"><i class="fas fa-wallet fa-3x text-green-500"></i><div><p class="text-gray-500">مبيعات اليوم</p><p class="text-2xl font-bold">${(data.todayRevenue || 0).toLocaleString()} د.ج</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-4"><i class="fas fa-concierge-bell fa-3x text-blue-500"></i><div><p class="text-gray-500">طلبات جديدة</p><p class="text-2xl font-bold">${data.newOrdersCount || 0}</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-4"><i class="fas fa-check-circle fa-3x text-teal-500"></i><div><p class="text-gray-500">طلبات مكتملة اليوم</p><p class="text-2xl font-bold">${data.completedTodayCount || 0}</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-4"><i class="fas fa-utensils fa-3x text-orange-500"></i><div><p class="text-gray-500">إجمالي الوجبات</p><p class="text-2xl font-bold">${data.totalMenuItems || 0}</p></div></div>`;
            };
            const todayStart = new Date();
            todayStart.setHours(0, 0, 0, 0);
            onSnapshot(query(collection(db, "orders"), where("createdAt", ">=", Timestamp.fromDate(todayStart))), async (snapshot) => {
                const todayOrders = snapshot.docs.map(doc => doc.data());
                const todayRevenue = todayOrders.filter(o => o.status === 'completed').reduce((sum, order) => sum + (order.totalPrice || 0), 0);
                const newOrdersCount = todayOrders.filter(o => o.status === 'new').length;
                const completedTodayCount = todayOrders.filter(o => o.status === 'completed').length;
                const menuItemsSnapshot = await getDocs(collection(db, "products"));
                renderCards({ todayRevenue, newOrdersCount, completedTodayCount, totalMenuItems: menuItemsSnapshot.size });
            });
        }
        
        // --- ORDERS SECTION (IMPROVED WITH TIMESTAMP) ---
        function loadOrders() {
            const panel = document.getElementById('orders-panel');
            panel.innerHTML = `<div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">الطلبات الواردة</h1>
                    <div class="relative"><i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="order-search-input" placeholder="ابحث بالاسم أو الهاتف..." class="w-full md:w-64 pr-10 pl-3 py-2 border rounded-lg"></div>
                </div>
                <div class="flex items-center gap-3 mb-4" id="order-status-filters">
                    <button class="filter-btn active" data-status="all">الكل</button>
                    <button class="filter-btn" data-status="new">جديد</button>
                    <button class="filter-btn" data-status="completed">مكتمل</button>
                    <button class="filter-btn" data-status="canceled">ملغي</button>
                </div>
                <div class="overflow-x-auto bg-white rounded-xl shadow-md">
                <table class="w-full text-right responsive-table"><thead class="bg-gray-100"><tr>
                    <th class="p-3">العميل</th><th class="p-3">الهاتف</th><th class="p-3">الطلبية</th>
                    <th class="p-3">المبلغ</th><th class="p-3">الحالة</th><th class="p-3">عامل التوصيل</th><th class="p-3">إجراءات</th>
                </tr></thead><tbody id="orders-table-body"></tbody></table></div>`;
            
            const searchInput = document.getElementById('order-search-input');
            searchInput.addEventListener('input', () => renderOrdersTable());

            document.querySelectorAll('#order-status-filters .filter-btn').forEach(btn => {
                btn.onclick = (e) => {
                    document.querySelector('#order-status-filters .filter-btn.active').classList.remove('active');
                    e.currentTarget.classList.add('active');
                    currentOrderStatusFilter = e.currentTarget.dataset.status;
                    renderOrdersTable();
                };
            });

            onSnapshot(query(collection(db, "orders"), orderBy("createdAt", "desc")), snapshot => {
                if (!isInitialOrdersLoad && snapshot.docChanges().some(c => c.type === "added")) {
                    document.getElementById('notification-sound').play();
                    showToast('طلب جديد ورد!', 'success');
                }
                isInitialOrdersLoad = false;
                ordersCache = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                renderOrdersTable();
            });
        }
        function renderOrdersTable() {
            const tableBody = document.getElementById('orders-table-body');
            const searchTerm = document.getElementById('order-search-input').value.toLowerCase();
            
            const filteredOrders = ordersCache.filter(order => {
                const matchesSearch = order.customerName.toLowerCase().includes(searchTerm) || order.customerContact.includes(searchTerm);
                const matchesFilter = currentOrderStatusFilter === 'all' || order.status === currentOrderStatusFilter;
                return matchesSearch && matchesFilter;
            });

            tableBody.innerHTML = filteredOrders.length === 0 ? `<tr><td colspan="7" class="p-8 text-center">لا توجد طلبات تطابق بحثك.</td></tr>` : '';
            
            filteredOrders.forEach(order => {
                const statusColors = { new: 'bg-blue-100 text-blue-800', completed: 'bg-green-100 text-green-800', canceled: 'bg-red-100 text-red-800' };
                const itemsHtml = (order.items || []).map(item => `<div>${item.quantity} x ${item.name}</div>`).join('');
                const deliveryPersonnelOptions = deliveryPersonnelCache.filter(p => p.status === 'active').map(p => `<option value="${p.id}" ${order.deliveryPersonId === p.id ? 'selected' : ''}>${p.name}</option>`).join('');
                
                // --- NEW: Format timestamp ---
                let formattedDate = '';
                if (order.createdAt && typeof order.createdAt.toDate === 'function') {
                    const date = order.createdAt.toDate();
                    formattedDate = date.toLocaleDateString('ar-EG', { day: '2-digit', month: 'short' }) + ' - ' + date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
                }
                
                const row = tableBody.insertRow();
                row.className = `border-b ${order.status === 'new' ? 'bg-blue-50' : 'bg-white'}`;
                row.innerHTML = `
                    <td data-label="العميل" class="p-3">
                        <div class="font-semibold">${order.customerName}</div>
                        <div class="text-xs text-gray-500 font-mono">${formattedDate}</div>
                    </td>
                    <td data-label="الهاتف" class="p-3 font-mono" dir="ltr">${order.customerContact}</td>
                    <td data-label="الطلبية" class="p-3 text-sm">${itemsHtml}</td>
                    <td data-label="المبلغ" class="p-3 font-mono font-bold">${(order.totalPrice || 0).toLocaleString()} د.ج</td>
                    <td data-label="الحالة" class="p-3">
                        <select class="order-status-select p-2 rounded-lg ${statusColors[order.status] || ''}" data-id="${order.id}">
                            <option value="new" ${order.status === 'new' ? 'selected' : ''}>جديد</option>
                            <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>مكتمل</option>
                            <option value="canceled" ${order.status === 'canceled' ? 'selected' : ''}>ملغي</option>
                        </select>
                    </td>
                    <td data-label="عامل التوصيل" class="p-3">
                        <select class="delivery-person-select p-2 rounded-lg bg-gray-50 border" data-id="${order.id}">
                            <option value="">-- اختر --</option> ${deliveryPersonnelOptions}
                        </select>
                    </td>
                    <td data-label="إجراءات" class="p-3">
                        <button class="copy-order-btn text-blue-500 mr-2" data-id="${order.id}" title="نسخ"><i class="fas fa-copy fa-lg"></i></button>
                        <button class="delete-order-btn text-red-500" data-id="${order.id}"><i class="fas fa-trash fa-lg"></i></button>
                    </td>`;
            });
            attachOrderActionListeners();
        }
        function attachOrderActionListeners() {
            document.querySelectorAll('.order-status-select').forEach(sel => sel.onchange = e => updateDoc(doc(db, "orders", e.target.dataset.id), { status: e.target.value }));
            document.querySelectorAll('.delivery-person-select').forEach(sel => sel.onchange = e => {
                const selectedOption = e.target.options[e.target.selectedIndex];
                const personId = selectedOption.value;
                const personName = personId ? selectedOption.text : null;
                updateDoc(doc(db, "orders", e.target.dataset.id), { deliveryPersonId: personId, deliveryPersonName: personName });
            });
            document.querySelectorAll('.delete-order-btn').forEach(btn => btn.onclick = e => {
                if(confirm('هل أنت متأكد من حذف هذا الطلب نهائيًا؟')){
                    deleteDoc(doc(db, "orders", e.currentTarget.dataset.id)).then(() => showToast('تم حذف الطلب.', 'success'));
                }
            });
            document.querySelectorAll('.copy-order-btn').forEach(btn => btn.onclick = e => {
                const order = ordersCache.find(o => o.id === e.currentTarget.dataset.id);
                if (!order) return;
                const itemsText = (order.items || []).map(item => `   - ${item.quantity} x ${item.name}`).join('\n');
                const deliveryPersonText = order.deliveryPersonName ? `\n🚚 بواسطة: ${order.deliveryPersonName}` : '';
                const message = `طلب جديد من TEXMEX\n--------------------\n👤 الاسم: ${order.customerName}\n📞 الهاتف: ${order.customerContact}\n📍 العنوان: ${order.customerLocation}\n📋 الطلبية:\n${itemsText}\n💰 السعر الإجمالي: ${order.totalPrice.toLocaleString()} د.ج${deliveryPersonText}\n--------------------`;
                navigator.clipboard.writeText(message).then(() => showToast('تم نسخ معلومات الطلب بنجاح!'));
            });
        }

        // --- MENU ITEMS SECTION (FIXED) ---
        function loadMenuItems() {
            const panel = document.getElementById('menu-items-panel');
            panel.innerHTML = `<div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-6">
                    <div>
                        <h1 class="text-3xl font-bold">قائمة الطعام</h1>
                        <div class="relative mt-2"><i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="menu-search-input" placeholder="ابحث عن وجبة..." class="w-full md:w-64 pr-10 pl-3 py-2 border rounded-lg"></div>
                    </div>
                    <button id="add-menu-item-btn" class="bg-orange-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-orange-700 h-fit"><i class="fas fa-plus mr-2"></i> إضافة وجبة</button>
                </div>
                <div id="menu-items-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>`;
            document.getElementById('add-menu-item-btn').onclick = () => showMenuItemModal();
            document.getElementById('menu-search-input').addEventListener('input', renderMenuItemsGrid);
            onSnapshot(query(collection(db, "products"), orderBy("createdAt", "desc")), snapshot => {
                menuItemsCache = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                renderMenuItemsGrid();
            });
        }
        function renderMenuItemsGrid() {
            const list = document.getElementById('menu-items-list');
            const searchTerm = document.getElementById('menu-search-input')?.value.toLowerCase() || '';
            const filteredItems = menuItemsCache.filter(item => item.name.toLowerCase().includes(searchTerm));

            list.innerHTML = filteredItems.length === 0 ? '<div class="col-span-full text-center p-8 bg-white rounded-lg shadow-sm"><p>لا توجد وجبات تطابق بحثك.</p></div>' : '';
            filteredItems.forEach(item => {
                const card = document.createElement('div');
                card.className = `bg-white p-4 rounded-xl shadow-md flex flex-col transition-opacity ${item.isAvailable === false ? 'opacity-50' : ''}`;
                card.innerHTML = `
                    <img src="${(item.imageUrl) || 'https://via.placeholder.com/300x160.png?text=No+Image'}" class="w-full h-40 object-cover rounded-lg mb-4 bg-gray-100">
                    <div class="flex justify-between items-start">
                        <h3 class="text-xl font-bold">${item.name}</h3>
                        <div class="text-xs text-center">
                            <label class="toggle-switch"><input type="checkbox" class="availability-toggle" data-id="${item.id}" ${item.isAvailable !== false ? 'checked' : ''}><span class="slider"></span></label>
                            <span class="font-semibold">${item.isAvailable !== false ? 'متوفر' : 'نفذ'}</span>
                        </div>
                    </div>
                    <p class="text-gray-500 text-sm my-2 flex-grow">${item.description || ''}</p>
                    <p class="text-lg font-bold text-orange-600">${(item.price || 0).toLocaleString()} د.ج</p>
                    <div class="border-t mt-4 pt-3 flex justify-end gap-3">
                        <button class="edit-menu-item-btn text-indigo-500" data-id="${item.id}"><i class="fas fa-edit"></i> تعديل</button>
                        <button class="delete-menu-item-btn text-red-500" data-id="${item.id}"><i class="fas fa-trash"></i> حذف</button>
                    </div>`;
                list.appendChild(card);
            });
            attachMenuItemActionListeners();
        }
        function attachMenuItemActionListeners() {
            document.querySelectorAll('.edit-menu-item-btn').forEach(btn => btn.onclick = e => showMenuItemModal(menuItemsCache.find(i => i.id === e.currentTarget.dataset.id)));
            document.querySelectorAll('.delete-menu-item-btn').forEach(btn => btn.onclick = async e => {
                if (confirm('هل أنت متأكد؟')) {
                    await deleteDoc(doc(db, "products", e.currentTarget.dataset.id));
                    showToast('تم حذف الوجبة بنجاح.', 'success');
                }
            });
            document.querySelectorAll('.availability-toggle').forEach(toggle => toggle.onchange = async e => {
                await updateDoc(doc(db, "products", e.currentTarget.dataset.id), { isAvailable: e.currentTarget.checked });
                showToast('تم تحديث حالة الوجبة.', 'success');
            });
        }
        function showMenuItemModal(item = null) {
            selectedFileStore = null;
            const categoryOptions = categoriesCache.map(c => `<option value="${c.id}" ${item && item.categoryId === c.id ? 'selected' : ''}>${c.name}</option>`).join('');
            const content = `<div class="space-y-4">
                <input type="text" id="item-name" placeholder="اسم الوجبة" class="w-full p-2 border rounded" value="${item ? item.name : ''}" required>
                <input type="number" id="item-price" placeholder="السعر (د.ج)" class="w-full p-2 border rounded" value="${item ? item.price : ''}" required>
                <textarea id="item-description" rows="3" placeholder="وصف قصير" class="w-full p-2 border rounded">${item ? item.description || '' : ''}</textarea>
                <select id="item-category" class="w-full p-2 border rounded bg-white"><option value="">اختر قسم...</option>${categoryOptions}</select>
                <div class="border p-3 rounded-lg bg-gray-50">
                    <label class="font-semibold text-sm">صورة الوجبة</label>
                    <div id="image-preview" class="mt-2"><img src="${item?.imageUrl || 'https://via.placeholder.com/150'}" class="w-32 h-32 object-cover rounded-md bg-gray-200"></div>
                    <input type="file" id="item-image-file" class="mt-2" accept="image/*">
                </div>
            </div>`;
            showModal(item ? 'تعديل وجبة' : 'إضافة وجبة', content, async () => {
                const confirmBtn = document.getElementById('modal-confirm');
                setButtonLoading(confirmBtn, true);

                try {
                    let imageUrl = item?.imageUrl || null;
                    if (selectedFileStore) {
                        showToast('جاري ضغط ورفع الصورة...', 'success');
                        const compressedFile = await compressImage(selectedFileStore);
                        const uploadResult = await uploadImageToImgBB(compressedFile);

                        if (uploadResult.success) {
                            imageUrl = uploadResult.url;
                        } else {
                            showModal('فشل رفع الصورة', 
                                `<p class="text-lg">لم نتمكن من رفع الصورة للسبب التالي:</p><p class="mt-2 p-3 bg-red-100 text-red-700 rounded-md font-mono text-left dir-ltr">${uploadResult.error}</p><p class="mt-4">الرجاء التأكد من صلاحية مفتاح API الخاص بخدمة ImgBB ومن اتصالك بالإنترنت.</p>`,
                                closeModal, 'حسنًا', false);
                            setButtonLoading(confirmBtn, false);
                            return; 
                        }
                    }

                    const data = {
                        name: document.getElementById('item-name').value, 
                        price: parseFloat(document.getElementById('item-price').value),
                        description: document.getElementById('item-description').value, 
                        categoryId: document.getElementById('item-category').value,
                        imageUrl: imageUrl, 
                        // --- FIX: Prevent undefined value for isAvailable ---
                        isAvailable: item?.isAvailable ?? true,
                        updatedAt: serverTimestamp(),
                    };

                    if (!data.name || isNaN(data.price)) { 
                        showToast('الرجاء إدخال اسم وسعر الوجبة.', 'error'); 
                        setButtonLoading(confirmBtn, false); 
                        return;
                    }
                    
                    if (item) {
                        await updateDoc(doc(db, "products", item.id), data);
                    } else {
                        data.createdAt = serverTimestamp();
                        await addDoc(collection(db, "products"), data);
                    }
                    
                    closeModal();
                    showToast(item ? 'تم تعديل الوجبة بنجاح' : 'تمت إضافة الوجبة بنجاح', 'success');
                } catch(error) { 
                    console.error("Save item error:", error);
                    showToast('حدث خطأ أثناء الحفظ: ' + error.message, 'error'); 
                } finally { 
                    setButtonLoading(confirmBtn, false); 
                }
            });
            document.getElementById('item-image-file').onchange = (evt) => {
                if (evt.target.files && evt.target.files[0]) {
                    selectedFileStore = evt.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (e) => document.querySelector('#image-preview img').src = e.target.result;
                    reader.readAsDataURL(selectedFileStore);
                }
            };
        }

        // --- OFFERS SECTION (IMPROVED) ---
        function loadOffers() {
            const panel = document.getElementById('offers-panel');
            panel.innerHTML = `<div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold">العروض والباقات</h1>
                <button id="add-offer-btn" class="bg-orange-600 text-white px-5 py-2 rounded-lg font-semibold"><i class="fas fa-plus mr-2"></i> إضافة عرض</button></div>
                <div id="offers-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>`;
            document.getElementById('add-offer-btn').onclick = () => showOfferModal();
            onSnapshot(query(collection(db, "offers"), orderBy("createdAt", "desc")), snapshot => {
                offersCache = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                const list = document.getElementById('offers-list');
                list.innerHTML = offersCache.length === 0 ? '<p class="col-span-full text-center">لا توجد عروض حاليًا.</p>' : '';
                offersCache.forEach(offer => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-xl shadow-md flex flex-col';
                    card.innerHTML = `
                        <img src="${offer.imageUrl || 'https://via.placeholder.com/300x160.png?text=Offer'}" class="w-full h-40 object-cover rounded-lg mb-4 bg-gray-100">
                        <h3 class="text-xl font-bold">${offer.title}</h3>
                        <p class="text-gray-500 text-sm my-2 flex-grow">${offer.description || ''}</p>
                        <p class="text-lg font-bold text-green-600">${(offer.price || 0).toLocaleString()} د.ج</p>
                        <div class="border-t mt-4 pt-3 flex justify-end gap-3">
                            <button class="edit-offer-btn text-indigo-500" data-id="${offer.id}"><i class="fas fa-edit"></i> تعديل</button>
                            <button class="delete-offer-btn text-red-500" data-id="${offer.id}"><i class="fas fa-trash"></i> حذف</button>
                        </div>`;
                    list.appendChild(card);
                });
                document.querySelectorAll('.edit-offer-btn').forEach(btn => btn.onclick = e => showOfferModal(offersCache.find(o => o.id === e.currentTarget.dataset.id)));
                document.querySelectorAll('.delete-offer-btn').forEach(btn => btn.onclick = async e => {
                    if (confirm('هل أنت متأكد من حذف هذا العرض؟')) {
                        await deleteDoc(doc(db, "offers", e.currentTarget.dataset.id));
                        showToast('تم حذف العرض بنجاح.', 'success');
                    }
                });
            });
        }
        function showOfferModal(offer = null) {
            selectedFileStore = null;
            const content = `<div class="space-y-4">
                <input type="text" id="offer-title" placeholder="عنوان العرض" class="w-full p-2 border rounded" value="${offer?.title || ''}" required>
                <input type="number" id="offer-price" placeholder="سعر العرض (د.ج)" class="w-full p-2 border rounded" value="${offer?.price || ''}" required>
                <textarea id="offer-description" rows="3" placeholder="وصف العرض" class="w-full p-2 border rounded">${offer?.description || ''}</textarea>
                <div class="border p-3 rounded-lg bg-gray-50">
                    <label class="font-semibold text-sm">صورة العرض</label>
                    <div id="image-preview" class="mt-2"><img src="${offer?.imageUrl || 'https://via.placeholder.com/150'}" class="w-32 h-32 object-cover rounded-md bg-gray-200"></div>
                    <input type="file" id="offer-image-file" class="mt-2" accept="image/*">
                </div>
            </div>`;
            showModal(offer ? 'تعديل العرض' : 'إضافة عرض', content, async () => {
                const confirmBtn = document.getElementById('modal-confirm');
                setButtonLoading(confirmBtn, true);
                try {
                    let imageUrl = offer?.imageUrl || null;
                    if (selectedFileStore) {
                        showToast('جاري ضغط ورفع الصورة...', 'success');
                        const compressedFile = await compressImage(selectedFileStore);
                        const uploadResult = await uploadImageToImgBB(compressedFile);

                        if(uploadResult.success) {
                            imageUrl = uploadResult.url;
                        } else {
                             showModal('فشل رفع الصورة', 
                                `<p class="text-lg">لم نتمكن من رفع الصورة للسبب التالي:</p><p class="mt-2 p-3 bg-red-100 text-red-700 rounded-md font-mono text-left dir-ltr">${uploadResult.error}</p>`,
                                closeModal, 'حسنًا', false);
                            setButtonLoading(confirmBtn, false);
                            return;
                        }
                    }
                    const data = {
                        title: document.getElementById('offer-title').value.trim(),
                        price: parseFloat(document.getElementById('offer-price').value),
                        description: document.getElementById('offer-description').value.trim(),
                        imageUrl,
                        updatedAt: serverTimestamp()
                    };
                    if (!data.title || isNaN(data.price)) { showToast('الرجاء إدخال عنوان وسعر العرض.', 'error'); setButtonLoading(confirmBtn, false); return; }
                    
                    if (offer) await updateDoc(doc(db, "offers", offer.id), data);
                    else { data.createdAt = serverTimestamp(); await addDoc(collection(db, "offers"), data); }
                    
                    closeModal();
                    showToast(offer ? 'تم تعديل العرض' : 'تمت إضافة العرض', 'success');
                } catch (error) { showToast('حدث خطأ أثناء الحفظ: ' + error.message, 'error'); } 
                finally { setButtonLoading(confirmBtn, false); }
            });
            document.getElementById('offer-image-file').onchange = (evt) => {
                if (evt.target.files && evt.target.files[0]) {
                    selectedFileStore = evt.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (e) => document.querySelector('#image-preview img').src = e.target.result;
                    reader.readAsDataURL(selectedFileStore);
                }
            };
        }

        // --- CATEGORIES SECTION ---
        function loadCategories() {
            const panel = document.getElementById('categories-panel');
            panel.innerHTML = `<div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold">الأقسام</h1><button id="add-cat-btn" class="bg-orange-600 text-white px-5 py-2 rounded-lg font-semibold"><i class="fas fa-plus mr-2"></i> إضافة قسم</button></div>
                <div id="categories-list" class="space-y-3"></div>`;
            document.getElementById('add-cat-btn').onclick = () => showCategoryModal();
            onSnapshot(query(collection(db, "categories"), orderBy("name")), snapshot => {
                categoriesCache = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                const list = document.getElementById('categories-list');
                list.innerHTML = '';
                categoriesCache.forEach(cat => {
                    const el = document.createElement('div');
                    el.className = 'bg-white p-4 rounded-xl shadow-md flex justify-between items-center';
                    el.innerHTML = `<h4 class="text-xl font-bold">${cat.name}</h4><div>
                        <button class="edit-cat-btn text-indigo-500 mr-4" data-id="${cat.id}"><i class="fas fa-edit"></i></button>
                        <button class="delete-cat-btn text-red-500" data-id="${cat.id}"><i class="fas fa-trash"></i></button></div>`;
                    list.appendChild(el);
                });
                document.querySelectorAll('.edit-cat-btn').forEach(btn => btn.onclick = e => showCategoryModal(categoriesCache.find(c => c.id === e.currentTarget.dataset.id)));
                document.querySelectorAll('.delete-cat-btn').forEach(btn => btn.onclick = e => {
                    if (confirm('هل أنت متأكد؟ سيؤثر حذف القسم على الوجبات المرتبطة به.')) {
                        deleteDoc(doc(db, "categories", e.currentTarget.dataset.id)).then(() => showToast('تم حذف القسم', 'success'));
                    }
                });
            });
        }
        function showCategoryModal(cat = null) {
            showModal(cat ? 'تعديل قسم' : 'إضافة قسم', `<input type="text" id="cat-name" placeholder="اسم القسم" class="w-full p-2 border rounded" value="${cat ? cat.name : ''}">`, async () => {
                const name = document.getElementById('cat-name').value.trim();
                if (!name) { showToast('اسم القسم مطلوب.', 'error'); return; }
                if (cat) await updateDoc(doc(db, "categories", cat.id), { name });
                else await addDoc(collection(db, "categories"), { name });
                closeModal();
                showToast(cat ? 'تم تعديل القسم' : 'تمت إضافة القسم', 'success');
            });
        }
        
        // --- DELIVERY PERSONNEL SECTION ---
        function loadDeliveryPersonnel() {
            const panel = document.getElementById('delivery-personnel-panel');
            panel.innerHTML = `<div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold">إدارة عمال التوصيل</h1><button id="add-personnel-btn" class="bg-orange-600 text-white px-5 py-2 rounded-lg font-semibold"><i class="fas fa-plus mr-2"></i> إضافة عامل</button></div>
                <div class="overflow-x-auto bg-white rounded-xl shadow-md">
                <table class="w-full text-right">
                    <thead class="bg-gray-100"><tr><th class="p-3">الاسم</th><th class="p-3">الهاتف</th><th class="p-3">الحالة</th><th class="p-3">إجراءات</th></tr></thead>
                    <tbody id="personnel-table-body"></tbody>
                </table></div>`;
            document.getElementById('add-personnel-btn').onclick = () => showPersonnelModal();
            onSnapshot(query(collection(db, "delivery_personnel"), orderBy("name")), snapshot => {
                deliveryPersonnelCache = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                const tBody = document.getElementById('personnel-table-body');
                tBody.innerHTML = '';
                deliveryPersonnelCache.forEach(person => {
                    const statusClass = person.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    tBody.innerHTML += `<tr class="border-b"><td class="p-3 font-semibold">${person.name}</td><td class="p-3 font-mono" dir="ltr">${person.phone}</td>
                        <td class="p-3"><span class="px-2 py-1 text-sm font-semibold rounded-full ${statusClass}">${person.status === 'active' ? 'نشط' : 'غير نشط'}</span></td>
                        <td class="p-3"><button class="edit-personnel-btn text-indigo-500 mr-4" data-id="${person.id}"><i class="fas fa-edit"></i></button><button class="delete-personnel-btn text-red-500" data-id="${person.id}"><i class="fas fa-trash"></i></button></td></tr>`;
                });
                document.querySelectorAll('.edit-personnel-btn').forEach(btn => btn.onclick = e => showPersonnelModal(deliveryPersonnelCache.find(p => p.id === e.currentTarget.dataset.id)));
                document.querySelectorAll('.delete-personnel-btn').forEach(btn => btn.onclick = e => {
                    if (confirm('هل أنت متأكد؟')) {
                        deleteDoc(doc(db, "delivery_personnel", e.currentTarget.dataset.id)).then(() => showToast('تم حذف العامل', 'success'));
                    }
                });
            });
        }
        function showPersonnelModal(person = null) {
            const content = `<div class="space-y-4"><input type="text" id="person-name" placeholder="اسم العامل" class="w-full p-2 border rounded" value="${person ? person.name : ''}" required>
                <input type="tel" id="person-phone" placeholder="رقم الهاتف" class="w-full p-2 border rounded" value="${person ? person.phone : ''}" required dir="ltr">
                <div><label class="font-semibold text-sm">الحالة</label><select id="person-status" class="w-full p-2 mt-1 border rounded bg-white">
                    <option value="active" ${person && person.status === 'active' ? 'selected' : ''}>نشط</option>
                    <option value="inactive" ${person && person.status === 'inactive' ? 'selected' : ''}>غير نشط</option></select></div></div>`;
            showModal(person ? 'تعديل بيانات العامل' : 'إضافة عامل', content, async () => {
                const data = { name: document.getElementById('person-name').value.trim(), phone: document.getElementById('person-phone').value.trim(), status: document.getElementById('person-status').value, };
                if (!data.name || !data.phone) { showToast('الرجاء إدخال الاسم والهاتف.', 'error'); return; }
                if (person) await updateDoc(doc(db, "delivery_personnel", person.id), data);
                else await addDoc(collection(db, "delivery_personnel"), data);
                closeModal();
                showToast('تم حفظ بيانات العامل', 'success');
            });
        }
        
        // --- STATS SECTION ---
        async function loadStats() {
            const panel = document.getElementById('stats-panel');
            panel.innerHTML = `<h1 class="text-3xl font-bold text-gray-800 mb-6">الإحصائيات</h1><div id="stats-content"><div class="text-center p-10"><div class="spinner-dark mx-auto"></div></div></div>`;
            const statsContent = document.getElementById('stats-content');

            try {
                const ordersSnapshot = await getDocs(query(collection(db, "orders"), where("status", "==", "completed")));
                const allCompletedOrders = ordersSnapshot.docs.map(d => d.data());
                
                const totalRevenue = allCompletedOrders.reduce((sum, order) => sum + (order.totalPrice || 0), 0);
                const totalOrders = allCompletedOrders.length;

                const salesByDay = {};
                for (let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    const key = d.toISOString().split('T')[0];
                    salesByDay[key] = { label: d.toLocaleDateString('ar-DZ', { weekday: 'short' }), revenue: 0 };
                }
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                allCompletedOrders.forEach(order => {
                    if (order.createdAt && typeof order.createdAt.toDate === 'function') {
                        const orderDate = order.createdAt.toDate();
                        if (orderDate >= sevenDaysAgo) {
                            const key = orderDate.toISOString().split('T')[0];
                            if (salesByDay[key]) {
                                salesByDay[key].revenue += order.totalPrice;
                            }
                        }
                    }
                });
                const chartData = Object.values(salesByDay);
                const maxRevenue = Math.max(...chartData.map(d => d.revenue));

                const itemCounts = {};
                allCompletedOrders.forEach(order => {
                    (order.items || []).forEach(item => {
                        itemCounts[item.name] = (itemCounts[item.name] || 0) + item.quantity;
                    });
                });
                const topItems = Object.entries(itemCounts)
                    .sort(([,a],[,b]) => b - a)
                    .slice(0, 5);

                statsContent.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-4">
                            <i class="fas fa-coins fa-3x text-yellow-500"></i>
                            <div><p class="text-gray-500">إجمالي الإيرادات</p><p class="text-2xl font-bold">${totalRevenue.toLocaleString()} د.ج</p></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-4">
                            <i class="fas fa-receipt fa-3x text-purple-500"></i>
                            <div><p class="text-gray-500">إجمالي الطلبات المكتملة</p><p class="text-2xl font-bold">${totalOrders}</p></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h3 class="text-xl font-bold mb-4">مبيعات آخر 7 أيام</h3>
                            <div class="flex justify-between items-end h-64 gap-2 border-b border-gray-200 pb-2">
                                ${chartData.map(day => `
                                    <div class="flex-1 flex flex-col items-center justify-end">
                                        <div class="text-xs font-bold">${day.revenue > 0 ? day.revenue.toLocaleString() : ''}</div>
                                        <div class="w-3/4 bg-orange-200 rounded-t-lg" style="height: ${maxRevenue > 0 ? (day.revenue / maxRevenue) * 90 : 0}%;"></div>
                                        <div class="text-sm text-gray-500 mt-1">${day.label}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h3 class="text-xl font-bold mb-4">أفضل 5 وجبات مبيعًا</h3>
                            <ul class="space-y-3">
                                ${topItems.length > 0 ? topItems.map(([name, count], index) => `
                                    <li class="flex items-center justify-between">
                                        <span class="font-semibold"><span class="text-gray-400 font-bold">${index + 1}.</span> ${name}</span>
                                        <span class="bg-gray-100 px-3 py-1 rounded-full text-sm font-bold">${count} مرة</span>
                                    </li>
                                `).join('') : '<p class="text-gray-500">لا توجد بيانات كافية لعرض أفضل الوجبات.</p>'}
                            </ul>
                        </div>
                    </div>
                `;
            } catch(error) {
                console.error("Error loading stats:", error);
                statsContent.innerHTML = `<div class="bg-red-100 text-red-700 p-4 rounded-lg">حدث خطأ أثناء تحميل الإحصائيات.</div>`;
            }
        }
        
        // --- DELIVERY SETTINGS ---
        function loadDeliverySettings() {
            const panel = document.getElementById('delivery-panel');
            panel.innerHTML = `<div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold">مناطق وأسعار التوصيل</h1><button id="add-zone-btn" class="bg-orange-600 text-white px-5 py-2 rounded-lg font-semibold"><i class="fas fa-plus mr-2"></i> إضافة منطقة</button></div>
                <div class="overflow-x-auto bg-white rounded-xl shadow-md">
                <table class="w-full text-right"><thead class="bg-gray-100"><tr>
                    <th class="p-3">اسم المنطقة</th><th class="p-3">سعر التوصيل العادي</th><th class="p-3">سعر التوصيل السريع</th><th class="p-3">إجراءات</th>
                </tr></thead><tbody id="zones-table-body"></tbody></table></div>`;
            document.getElementById('add-zone-btn').onclick = () => showZoneModal();
            onSnapshot(query(collection(db, "delivery_zones"), orderBy("name")), snapshot => {
                deliveryZonesCache = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                const tBody = document.getElementById('zones-table-body');
                tBody.innerHTML = deliveryZonesCache.length === 0 ? `<tr><td colspan="4" class="p-8 text-center">لم تقم بإضافة أي مناطق توصيل بعد.</td></tr>` : '';
                deliveryZonesCache.forEach(zone => {
                    tBody.innerHTML += `<tr class="border-b">
                        <td class="p-3 font-semibold">${zone.name}</td>
                        <td class="p-3 font-mono">${(zone.price_normal || 0).toLocaleString()} د.ج</td>
                        <td class="p-3 font-mono">${(zone.price_fast || 0).toLocaleString()} د.ج</td>
                        <td class="p-3">
                            <button class="edit-zone-btn text-indigo-500 mr-4" data-id="${zone.id}"><i class="fas fa-edit"></i></button>
                            <button class="delete-zone-btn text-red-500" data-id="${zone.id}"><i class="fas fa-trash"></i></button>
                        </td></tr>`;
                });
                document.querySelectorAll('.edit-zone-btn').forEach(btn => btn.onclick = e => showZoneModal(deliveryZonesCache.find(z => z.id === e.currentTarget.dataset.id)));
                document.querySelectorAll('.delete-zone-btn').forEach(btn => btn.onclick = e => {
                    if (confirm('هل أنت متأكد من حذف هذه المنطقة؟')) {
                        deleteDoc(doc(db, "delivery_zones", e.currentTarget.dataset.id)).then(() => showToast('تم حذف المنطقة', 'success'));
                    }
                });
            });
        }
        function showZoneModal(zone = null) {
            const content = `<div class="space-y-4">
                <input type="text" id="zone-name" placeholder="اسم المنطقة (مثال: وسط المدينة)" class="w-full p-2 border rounded" value="${zone?.name || ''}" required>
                <input type="number" id="zone-price-normal" placeholder="سعر التوصيل العادي (د.ج)" class="w-full p-2 border rounded" value="${zone?.price_normal || ''}" required>
                <input type="number" id="zone-price-fast" placeholder="سعر التوصيل السريع (د.ج)" class="w-full p-2 border rounded" value="${zone?.price_fast || ''}">
            </div>`;
            showModal(zone ? 'تعديل منطقة' : 'إضافة منطقة', content, async () => {
                const data = {
                    name: document.getElementById('zone-name').value.trim(),
                    price_normal: parseFloat(document.getElementById('zone-price-normal').value) || 0,
                    price_fast: parseFloat(document.getElementById('zone-price-fast').value) || 0
                };
                if (!data.name) { showToast('اسم المنطقة مطلوب.', 'error'); return; }
                if (zone) await updateDoc(doc(db, "delivery_zones", zone.id), data);
                else await addDoc(collection(db, "delivery_zones"), data);
                closeModal();
                showToast('تم حفظ المنطقة بنجاح', 'success');
            });
        }
        
        // --- RESTAURANT SETTINGS ---
        async function loadRestaurantSettings() {
            const panel = document.getElementById('settings-panel');
            panel.innerHTML = `<div class="spinner-dark mx-auto mt-10"></div>`;
            const docRef = doc(db, "settings", "config");
            const docSnap = await getDoc(docRef);
            const settings = docSnap.exists() ? docSnap.data() : {};

            panel.innerHTML = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">إعدادات المطعم</h1>
                <div class="space-y-8">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold mb-4 border-b pb-2">حالة المطعم</h3>
                         <div class="flex items-center justify-between bg-red-50 p-4 rounded-lg">
                             <label for="manual-closed-toggle" class="font-semibold text-lg text-red-800">فرض إغلاق المطعم (للطوارئ)</label>
                             <label class="toggle-switch"><input type="checkbox" id="manual-closed-toggle" ${settings.isManuallyClosed ? 'checked' : ''}><span class="slider"></span></label>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold mb-4 border-b pb-2">الإعدادات العامة</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label class="font-semibold">وقت الفتح</label><input type="time" id="open-time" class="w-full p-2 mt-1 border rounded" value="${settings.openTime || ''}"></div>
                            <div><label class="font-semibold">وقت الإغلاق</label><input type="time" id="close-time" class="w-full p-2 mt-1 border rounded" value="${settings.closeTime || ''}"></div>
                        </div>
                        <div class="mt-4"><label class="font-semibold">رسالة الإغلاق</label><input type="text" id="closed-message" placeholder="مثال: المطعم مغلق حاليًا، نفتح غدًا على الساعة 11:00" class="w-full p-2 mt-1 border rounded" value="${settings.closedMessage || ''}"></div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold mb-4 border-b pb-2">عرض التوصيل المجاني</h3>
                        <div class="flex items-center justify-between">
                             <label for="free-delivery-toggle" class="font-semibold text-lg">تفعيل عرض التوصيل المجاني</label>
                             <label class="toggle-switch"><input type="checkbox" id="free-delivery-toggle" ${settings.isFreeDeliveryActive ? 'checked' : ''}><span class="slider"></span></label>
                        </div>
                        <div class="mt-4">
                            <label class="font-semibold">المبلغ الأدنى للتوصيل المجاني (د.ج)</label>
                            <input type="number" id="free-delivery-threshold" placeholder="مثال: 1000" class="w-full p-2 mt-1 border rounded" value="${settings.freeDeliveryThreshold || ''}">
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold mb-4 border-b pb-2">روابط التواصل</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="social-phone1" placeholder="رقم الهاتف (للاتصال)" class="p-2 border rounded" value="${settings.socialLinks?.phone1 || ''}">
                            <input type="text" id="social-whatsapp1" placeholder="رقم الواتساب (بدون +)" class="p-2 border rounded" value="${settings.socialLinks?.whatsapp1 || ''}">
                            <input type="url" id="social-facebook1" placeholder="رابط فيسبوك" class="p-2 border rounded" value="${settings.socialLinks?.facebook1 || ''}">
                            <input type="url" id="social-instagram1" placeholder="رابط انستغرام" class="p-2 border rounded" value="${settings.socialLinks?.instagram1 || ''}">
                        </div>
                    </div>
                </div>
                <div class="mt-8 text-right">
                    <button id="save-settings-btn" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700">حفظ كل الإعدادات</button>
                </div>`;
            document.getElementById('save-settings-btn').onclick = saveGeneralSettings;
        }
        async function saveGeneralSettings() { 
            const btn = document.getElementById('save-settings-btn');
            setButtonLoading(btn, true, 'حفظ كل الإعدادات');
            const settingsData = {
                isManuallyClosed: document.getElementById('manual-closed-toggle').checked,
                openTime: document.getElementById('open-time').value,
                closeTime: document.getElementById('close-time').value,
                closedMessage: document.getElementById('closed-message').value,
                isFreeDeliveryActive: document.getElementById('free-delivery-toggle').checked,
                freeDeliveryThreshold: parseFloat(document.getElementById('free-delivery-threshold').value) || 0,
                socialLinks: {
                    phone1: document.getElementById('social-phone1').value,
                    whatsapp1: document.getElementById('social-whatsapp1').value,
                    facebook1: document.getElementById('social-facebook1').value,
                    instagram1: document.getElementById('social-instagram1').value,
                }
            };
            try {
                await setDoc(doc(db, "settings", "config"), settingsData, { merge: true });
                showToast('تم حفظ الإعدادات بنجاح!', 'success');
            } catch (error) {
                showToast('فشل حفظ الإعدادات: ' + error.message, 'error');
            } finally {
                setButtonLoading(btn, false, 'حفظ كل الإعدادات');
            }
        }

        // --- KICKSTART THE DASHBOARD ---
        initializeDashboard();
    </script>
</body>
</html>