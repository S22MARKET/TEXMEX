<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEXMEX - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f0f2f5; }
        .hidden { display: none; }
        .active-tab { background-color: #ea580c; color: white; }
        .dashboard-panel { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 40; display: flex; align-items: center; justify-content: center; }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 700px; z-index: 50; max-height: 90vh; overflow-y: auto; }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 100; }
        .toast { background-color: #2d3748; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-top: 10px; display: flex; align-items: center; gap: 10px; animation: slideInUp 0.3s ease, fadeOut 0.5s ease 2.5s forwards; }
        .toast.success { background-color: #2f855a; }
        .toast.error { background-color: #c53030; }
        @keyframes slideInUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #48bb78; }
        input:checked + .slider:before { transform: translateX(24px); }
        .spinner { width: 24px; height: 24px; border: 4px solid rgba(255, 255, 255, 0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; }
        .spinner-dark { width: 24px; height: 24px; border: 4px solid rgba(0,0,0, 0.1); border-top-color: #333; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 768px) { .responsive-table thead { display: none; } .responsive-table tr { display: block; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; } .responsive-table td { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6; } .responsive-table td:last-child { border-bottom: none; } .responsive-table td::before { content: attr(data-label); font-weight: 600; margin-left: 0.5rem; } }
        .filter-btn { padding: 8px 16px; border-radius: 8px; border: 1px solid #ddd; background-color: white; transition: all 0.2s; }
        .filter-btn.active { background-color: #f97316; color: white; border-color: #f97316; }
        /* Quill Editor Height */
        .ql-editor { min-height: 120px; }
        /* NEW: Loyal Customer Accordion */
        .customer-details { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.23/dist/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

    <div id="auth-loader" class="flex flex-col items-center justify-center min-h-screen bg-gray-100">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-4">TEX<span class="text-orange-500">MEX</span></h1>
        <div class="spinner-dark"></div>
        <p class="mt-4 text-gray-600">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ©...</p>
    </div>

    <div id="dashboard-page" class="hidden">
        <div class="relative min-h-screen md:flex">
            <aside id="sidebar" class="bg-gray-800 text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 right-0 transform translate-x-full md:relative md:translate-x-0 transition duration-300 ease-in-out z-30">
                <div class="p-3 text-center border-b border-gray-700">
                    <h2 class="text-2xl font-bold">TEX<span class="text-orange-400">MEX</span></h2>
                </div>
                <nav class="flex-1 p-2 space-y-2">
                    <a href="#dashboard" class="dashboard-tab active-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-tachometer-alt fa-fw ml-3"></i> Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
                    <a href="#orders" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-clipboard-list fa-fw ml-3"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</a>
                    <a href="#loyal-customers" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-users fa-fw ml-3"></i> Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø£ÙˆÙÙŠØ§Ø¡</a>
                    <a href="#menu-items" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-utensils fa-fw ml-3"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø¹Ø§Ù…</a>
                    <a href="#offers" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-star fa-fw ml-3"></i> Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙˆØ§Ù„Ø¨Ø§Ù‚Ø§Øª</a>
                    <a href="#coupons" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-tags fa-fw ml-3"></i> Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª</a>
                    <a href="#categories" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-sitemap fa-fw ml-3"></i> Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</a>
                    <a href="#delivery-personnel" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-biking fa-fw ml-3"></i> Ø¹Ù…Ø§Ù„ Ø§Ù„ØªÙˆØµÙŠÙ„</a>
                    <a href="#stats" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-chart-line fa-fw ml-3"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</a>
                    <a href="#delivery" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-motorcycle fa-fw ml-3"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„</a>
                    <a href="#settings" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-cogs fa-fw ml-3"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ø¹Ù…</a>
                </nav>
                <div class="p-4 border-t border-gray-700">
                    <button id="logout-btn" class="w-full flex items-center justify-center px-4 py-3 rounded-md bg-red-600 hover:bg-red-700">
                        <i class="fas fa-sign-out-alt fa-fw ml-3"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                    </button>
                </div>
            </aside>
            <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden hidden"></div>
            
            <div class="flex-1 flex flex-col">
                <header class="bg-white shadow-md p-4 flex justify-between items-center">
                    <h1 class="text-xl font-bold">TEX<span class="text-orange-500">MEX</span> Dashboard</h1>
                    <button id="mobile-menu-btn" class="text-gray-800 p-2 rounded-lg md:hidden"><i class="fas fa-bars fa-lg"></i></button>
                </header>
                <main class="flex-1 p-4 md:p-8 overflow-y-auto">
                    <div id="dashboard-panel" class="dashboard-panel"></div>
                    <div id="orders-panel" class="dashboard-panel hidden"></div>
                    <div id="loyal-customers-panel" class="dashboard-panel hidden"></div>
                    <div id="menu-items-panel" class="dashboard-panel hidden"></div>
                    <div id="offers-panel" class="dashboard-panel hidden"></div>
                    <div id="coupons-panel" class="dashboard-panel hidden"></div>
                    <div id="categories-panel" class="dashboard-panel hidden"></div>
                    <div id="delivery-personnel-panel" class="dashboard-panel hidden"></div>
                    <div id="stats-panel" class="dashboard-panel hidden"></div>
                    <div id="delivery-panel" class="dashboard-panel hidden"></div>
                    <div id="settings-panel" class="dashboard-panel hidden"></div>
                </main>
            </div>
        </div>
    </div>

    <div id="modal-container"></div>
    <div id="toast-container"></div>
    <audio id="notification-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-notification-947.mp3" preload="auto"></audio>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>






<script type="module">
        // --- FIREBASE INITIALIZATION ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, serverTimestamp, orderBy, getDoc, setDoc, getDocs, where, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAsG-85oNZq8kzWPHIDpsifkQ7rhua_oPk",
            authDomain: "texmexfoodannaba23.firebaseapp.com",
            projectId: "texmexfoodannaba23",
            storageBucket: "texmexfoodannaba23.appspot.com",
            messagingSenderId: "712480664933",
            appId: "1:712480664933:web:a5310190bf63115ac9058c",
            measurementId: "G-38D210X1EG"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- AUTHENTICATION GATE ---
        const authLoader = document.getElementById('auth-loader');
        const dashboardPage = document.getElementById('dashboard-page');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                authLoader.classList.add('hidden');
                dashboardPage.classList.remove('hidden');
                initializeDashboard(); 
            } else {
                window.location.href = 'login.html';
            }
        });


        // --- GLOBAL CACHES & STATE ---
        let categoriesCache = [];
        let deliveryPersonnelCache = [];
        let menuItemsCache = [];
        let offersCache = [];
        let couponsCache = [];
        let ordersCache = [];
        let deliveryZonesCache = [];
        let isInitialOrdersLoad = true;
        let selectedFileStore = {}; 
        let currentOrderStatusFilter = 'all';
        let quillEditor = null; // To hold the Quill instance

        // --- UI & UX HELPERS (MODAL, TOAST) ---
        const showModal = (title, content, onConfirm, confirmText = 'Ø­ÙØ¸', showCancel = true) => {
            const modalContainer = document.getElementById('modal-container');
            const confirmButtonHtml = onConfirm ? `<button id="modal-confirm" class="bg-orange-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-orange-700 flex items-center gap-2">${confirmText}</button>` : '';
            const cancelButtonHtml = showCancel ? `<button id="modal-cancel" class="bg-gray-200 px-6 py-2 rounded-lg font-semibold hover:bg-gray-300">Ø¥Ù„ØºØ§Ø¡</button>` : '';
            
            modalContainer.innerHTML = `
                <div class="modal-backdrop" id="modal-backdrop">
                    <div class="modal-content">
                        <div class="flex justify-between items-center mb-4 border-b pb-3"><h3 class="text-xl font-bold">${title}</h3><button id="modal-close-btn" class="text-2xl">&times;</button></div>
                        <div id="modal-body">${content}</div>
                        <div class="flex justify-end gap-4 mt-6 border-t pt-4">
                            ${cancelButtonHtml}
                            ${confirmButtonHtml}
                        </div>
                    </div>
                </div>`;

            const close = () => {
                quillEditor = null; // Clear Quill instance on modal close
                modalContainer.innerHTML = '';
            }
            if (showCancel) document.getElementById('modal-cancel').onclick = close;
            document.getElementById('modal-close-btn').onclick = close;
            document.getElementById('modal-backdrop').onclick = e => { if (e.target.id === 'modal-backdrop') close(); };
            if (onConfirm) document.getElementById('modal-confirm').onclick = onConfirm;
        };

        const closeModal = () => {
             quillEditor = null; // Clear Quill instance on modal close
            document.getElementById('modal-container').innerHTML = '';
        }

        function showDeletionConfirmModal(onConfirmCallback) {
            const content = `
                <p class="mb-4 text-lg">Ù„ØªØ£ÙƒÙŠØ¯ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°ÙØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„ØªØ§Ù„ÙŠ:</p>
                <div class="text-center mb-4">
                    <code class="text-2xl font-bold bg-gray-100 p-2 rounded-lg text-orange-600 select-all">S22MARKET</code>
                </div>
                <input type="text" id="deletion-code-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù‡Ù†Ø§ Ù„Ù„ØªØ£ÙƒÙŠØ¯" class="w-full p-3 border rounded-lg text-center tracking-widest uppercase focus:ring-2 focus:ring-orange-400 focus:border-orange-400">
                <p id="deletion-error-msg" class="text-red-600 text-sm mt-2 text-center hidden">Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø°ÙŠ Ø£Ø¯Ø®Ù„ØªÙ‡ ØºÙŠØ± ØµØ­ÙŠØ­. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p>
            `;

            showModal('ØªØ£ÙƒÙŠØ¯ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°Ù', content, () => {
                const codeInput = document.getElementById('deletion-code-input');
                const errorMsg = document.getElementById('deletion-error-msg');
                if (codeInput.value.trim().toUpperCase() === 'S22MARKET') {
                    onConfirmCallback(); 
                    closeModal();
                } else {
                    errorMsg.classList.remove('hidden');
                    codeInput.classList.add('border-red-500');
                    codeInput.focus();
                }
            }, 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù', true);

            const codeInput = document.getElementById('deletion-code-input');
            const errorMsg = document.getElementById('deletion-error-msg');
            codeInput.addEventListener('input', () => {
                errorMsg.classList.add('hidden');
                codeInput.classList.remove('border-red-500');
            });
        }


        const showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-times-circle';
            toast.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };
        const setButtonLoading = (btn, isLoading, text = 'Ø­ÙØ¸') => {
            if (isLoading) {
                btn.disabled = true;
                btn.innerHTML = `<div class="spinner"></div><span>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...</span>`;
            } else {
                btn.disabled = false;
                btn.innerHTML = text;
            }
        };

        // --- START: PDF GENERATION FUNCTION ---
        const generateOrderPDF = (orderData, orderId) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFontSize(14);
            doc.text("Alsalam ealaykum zabuna alkarim", doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
            doc.setFontSize(22);
            doc.text("TEXMEX Annaba - Order Receipt", doc.internal.pageSize.getWidth() / 2, 25, { align: 'center' });
            doc.setFont(undefined, 'normal'); // Reset font style

            // Order Info
            doc.setFontSize(12);
            const orderDate = orderData.createdAt?.toDate ? orderData.createdAt.toDate().toLocaleString('en-GB') : new Date().toLocaleString('en-GB');
            let startX = 15;
            let startY = 40;
            
            doc.text(`Order ID: ${orderId}`, startX, startY);
            doc.text(`Date: ${orderDate}`, startX, startY += 7);
            doc.text(`Name: ${orderData.customerName}`, startX, startY += 7);
            doc.text(`Phone: ${orderData.customerContact}`, startX, startY += 7);
            doc.text(`Address: ${orderData.customerLocation}`, startX, startY += 7);

            // Table
            const tableColumn = ["Item", "Quantity", "Price", "Total"];
            const tableRows = [];

            orderData.items.forEach(item => {
                const itemName = item.name; // Item names can be in Arabic from DB, which is fine
                const itemData = [
                    itemName,
                    item.quantity,
                    `${item.price.toLocaleString()} DZD`,
                    `${(item.price * item.quantity).toLocaleString()} DZD`,
                ];
                tableRows.push(itemData);
            });

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: startY + 10,
                theme: 'grid',
                headStyles: { halign: 'center', fillColor: [234, 88, 12] },
                bodyStyles: { halign: 'left' },
                columnStyles: {
                    1: { halign: 'center' }, // Quantity
                    2: { halign: 'right' },  // Price
                    3: { halign: 'right' },  // Total
                }
            });
            
            let finalY = doc.autoTable.previous.finalY;
            const totalsX = doc.internal.pageSize.getWidth() - 15;
            const subTotal = orderData.totalPrice - orderData.deliveryFee + (orderData.discountAmount || 0);

            doc.setFontSize(12);
            doc.text(`Subtotal: ${subTotal.toLocaleString()} DZD`, totalsX, finalY += 10, { align: 'right' });
            doc.text(`Delivery Fee: ${orderData.deliveryFee.toLocaleString()} DZD`, totalsX, finalY += 7, { align: 'right' });
            if (orderData.discountAmount > 0) {
                 doc.text(`Discount (${orderData.couponCode}): -${orderData.discountAmount.toLocaleString()} DZD`, totalsX, finalY += 7, { align: 'right' });
            }
            
            doc.setLineWidth(0.5);
            doc.line(140, finalY + 3, totalsX, finalY + 3);

            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(`Total: ${orderData.totalPrice.toLocaleString()} DZD`, totalsX, finalY += 10, { align: 'right' });

            doc.setFont(undefined, 'normal');
            doc.setFontSize(12);
            doc.text("Thank you for your trust in TEXMEX!", doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() - 15, { align: 'center' });

            doc.save(`TEXMEX-Receipt-${orderId.substring(0, 6)}.pdf`);
        };
        // --- END: PDF GENERATION FUNCTION ---

        // --- IMAGE UPLOAD & COMPRESSION HELPERS ---
        async function compressImage(file, maxWidth = 1024) {
            console.log(`Original size: ${(file.size / 1024).toFixed(2)} KB`);
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scaleSize = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        ctx.canvas.toBlob((blob) => {
                           const compressedFile = new File([blob], file.name, { type: 'image/jpeg', lastModified: Date.now() });
                           console.log(`Compressed size: ${(compressedFile.size / 1024).toFixed(2)} KB`);
                           resolve(compressedFile);
                        }, 'image/jpeg', 0.8);
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }
        
        async function uploadImageToImgBB(file) {
            const apiKey = '10cb4fda942ce7147252dc316751b47c';
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, {
                    method: 'POST',
                    body: formData
                });
                if (!response.ok) {
                    return { success: false, error: `ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…: (${response.status}) ${response.statusText}` };
                }
                const result = await response.json();
                if (result.success) {
                    return { success: true, url: result.data.url };
                } else {
                    return { success: false, error: `Ø®Ø·Ø£ Ù…Ù† Ø®Ø¯Ù…Ø© Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±: ${result.error.message}` };
                }
            } catch (error) {
                console.error('Image upload network error:', error);
                return { success: false, error: `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.` };
            }
        }

        // --- DASHBOARD INITIALIZATION & NAVIGATION ---
        function initializeDashboard() {
            const tabs = document.querySelectorAll('.dashboard-tab');
            const panels = document.querySelectorAll('.dashboard-panel');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const logoutBtn = document.getElementById('logout-btn');

            const switchTab = (hash) => {
                const targetId = hash.substring(1) + '-panel';
                tabs.forEach(t => t.classList.toggle('active-tab', t.getAttribute('href') === hash));
                panels.forEach(p => p.classList.toggle('hidden', p.id !== targetId));
                // NEW: Load loyal customers when tab is active
                if (hash === '#loyal-customers') {
                    loadLoyalCustomers();
                }
                if (hash === '#stats') {
                    loadStats(); 
                }
            };

            tabs.forEach(tab => tab.addEventListener('click', e => {
                e.preventDefault();
                const hash = tab.getAttribute('href');
                window.location.hash = hash;
                if (window.innerWidth < 768) {
                    sidebar.classList.add('translate-x-full');
                    overlay.classList.add('hidden');
                }
            }));
            
            window.addEventListener('hashchange', () => switchTab(window.location.hash || '#dashboard'));
            mobileMenuBtn.onclick = () => { sidebar.classList.remove('translate-x-full'); overlay.classList.remove('hidden'); };
            overlay.onclick = () => { sidebar.classList.add('translate-x-full'); overlay.classList.add('hidden'); };
            logoutBtn.onclick = () => {
                signOut(auth).catch((error) => {
                    console.error("Logout Error:", error);
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬.");
                });
            };

            loadDashboardSummary();
            loadDeliveryPersonnel();
            loadOrders();
            loadMenuItems();
            loadOffers();
            loadCoupons();
            loadCategories();
            loadDeliverySettings();
            loadRestaurantSettings();
            
            switchTab(window.location.hash || '#dashboard');
        }

        // --- MAIN DASHBOARD SUMMARY ---
        async function loadDashboardSummary() {
            const panel = document.getElementById('dashboard-panel');
            panel.innerHTML = `<h1 class="text-3xl font-bold text-gray-800 mb-6">Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…</h1><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="summary-cards"><div class="bg-white p-6 rounded-xl shadow-md text-center col-span-full"><div class="spinner-dark mx-auto"></div></div></div>`;
            const cardsContainer = document.getElementById('summary-cards');
            const renderCards = (data) => {
                cardsContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-4"><i class="fas fa-wallet fa-3x text-green-500"></i><div><p class="text-gray-500">Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</p><p class="text-2xl font-bold">${(data.todayRevenue || 0).toLocaleString()} Ø¯.Ø¬</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-4"><i class="fas fa-concierge-bell fa-3x text-blue-500"></i><div><p class="text-gray-500">Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</p><p class="text-2xl font-bold">${data.newOrdersCount || 0}</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-4"><i class="fas fa-check-circle fa-3x text-teal-500"></i><div><p class="text-gray-500">Ø·Ù„Ø¨Ø§Øª Ù…ÙƒØªÙ…Ù„Ø© Ø§Ù„ÙŠÙˆÙ…</p><p class="text-2xl font-bold">${data.completedTodayCount || 0}</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-4"><i class="fas fa-utensils fa-3x text-orange-500"></i><div><p class="text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</p><p class="text-2xl font-bold">${data.totalMenuItems || 0}</p></div></div>`;
            };
            const todayStart = new Date();
            todayStart.setHours(0, 0, 0, 0);
            onSnapshot(query(collection(db, "orders"), where("createdAt", ">=", Timestamp.fromDate(todayStart))), async (snapshot) => {
                const todayOrders = snapshot.docs.map(doc => doc.data());
                const todayRevenue = todayOrders.filter(o => o.status === 'completed').reduce((sum, order) => sum + (order.totalPrice || 0), 0);
                const newOrdersCount = todayOrders.filter(o => o.status === 'new').length;
                const completedTodayCount = todayOrders.filter(o => o.status === 'completed').length;
                const menuItemsSnapshot = await getDocs(collection(db, "products"));
                renderCards({ todayRevenue, newOrdersCount, completedTodayCount, totalMenuItems: menuItemsSnapshot.size });
            });
        }
        
        // --- ORDERS SECTION ---
        function loadOrders() {
            const panel = document.getElementById('orders-panel');
            panel.innerHTML = `<div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h1>
                    <div class="relative"><i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="order-search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ..." class="w-full md:w-64 pr-10 pl-3 py-2 border rounded-lg"></div>
                </div>
                <div class="flex items-center gap-3 mb-4" id="order-status-filters">
                    <button class="filter-btn active" data-status="all">Ø§Ù„ÙƒÙ„</button>
                    <button class="filter-btn" data-status="new">Ø¬Ø¯ÙŠØ¯</button>
                    <button class="filter-btn" data-status="completed">Ù…ÙƒØªÙ…Ù„</button>
                    <button class="filter-btn" data-status="canceled">Ù…Ù„ØºÙŠ</button>
                </div>
                <div class="overflow-x-auto bg-white rounded-xl shadow-md">
                <table class="w-full text-right responsive-table"><thead class="bg-gray-100"><tr>
                    <th class="p-3">Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th class="p-3">Ø§Ù„Ù‡Ø§ØªÙ</th><th class="p-3">Ø§Ù„Ø·Ù„Ø¨ÙŠØ©</th>
                    <th class="p-3">Ø§Ù„Ù…Ø¨Ù„Øº</th><th class="p-3">Ø§Ù„Ø­Ø§Ù„Ø©</th><th class="p-3">Ø¹Ø§Ù…Ù„ Ø§Ù„ØªÙˆØµÙŠÙ„</th><th class="p-3">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr></thead><tbody id="orders-table-body"></tbody></table></div>`;
            
            const searchInput = document.getElementById('order-search-input');
            searchInput.addEventListener('input', () => renderOrdersTable());

            document.querySelectorAll('#order-status-filters .filter-btn').forEach(btn => {
                btn.onclick = (e) => {
                    document.querySelector('#order-status-filters .filter-btn.active').classList.remove('active');
                    e.currentTarget.classList.add('active');
                    currentOrderStatusFilter = e.currentTarget.dataset.status;
                    renderOrdersTable();
                };
            });

            onSnapshot(query(collection(db, "orders"), orderBy("createdAt", "desc")), snapshot => {
                if (!isInitialOrdersLoad && snapshot.docChanges().some(c => c.type === "added")) {
                    document.getElementById('notification-sound').play();
                    showToast('Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ÙˆØ±Ø¯!', 'success');
                }
                isInitialOrdersLoad = false;
                ordersCache = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                renderOrdersTable();
            });
        }
        function renderOrdersTable() {
            const tableBody = document.getElementById('orders-table-body');
            const searchTerm = document.getElementById('order-search-input').value.toLowerCase();
            
            const filteredOrders = ordersCache.filter(order => {
                const matchesSearch = order.customerName.toLowerCase().includes(searchTerm) || order.customerContact.includes(searchTerm);
                const matchesFilter = currentOrderStatusFilter === 'all' || order.status === currentOrderStatusFilter;
                return matchesSearch && matchesFilter;
            });

            tableBody.innerHTML = filteredOrders.length === 0 ? `<tr><td colspan="7" class="p-8 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø¨Ø­Ø«Ùƒ.</td></tr>` : '';
            
            filteredOrders.forEach(order => {
                const statusColors = { new: 'bg-blue-100 text-blue-800', completed: 'bg-green-100 text-green-800', canceled: 'bg-red-100 text-red-800' };
                
                const itemsHtml = (order.items || []).map(item => {
                    let itemText = `<div><span class="font-semibold">${item.quantity} x ${item.name}</span></div>`;
                    if (item.selectedAddons && item.selectedAddons.length > 0) {
                        const addonsText = item.selectedAddons.map(addon => 
                            `<div class="text-xs text-gray-600 mr-4">+ ${addon.name} (${addon.price} Ø¯.Ø¬)</div>`
                        ).join('');
                        itemText += addonsText;
                    }
                    return itemText;
                }).join('');

                let couponHtml = '';
                if(order.couponCode) {
                    couponHtml = `<div class="text-xs text-green-600 font-bold mt-1">ÙƒÙˆØ¨ÙˆÙ† (${order.couponCode}) : -${(order.discountAmount || 0).toLocaleString()} Ø¯.Ø¬</div>`;
                }
                
                const deliveryPersonnelOptions = deliveryPersonnelCache.filter(p => p.status === 'active').map(p => `<option value="${p.id}" ${order.deliveryPersonId === p.id ? 'selected' : ''}>${p.name}</option>`).join('');
                
                let formattedDate = '';
                if (order.createdAt && typeof order.createdAt.toDate === 'function') {
                    const date = order.createdAt.toDate();
                    formattedDate = date.toLocaleDateString('ar-EG', { day: '2-digit', month: 'short' }) + ' - ' + date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
                }
                
                const row = tableBody.insertRow();
                row.className = `border-b ${order.status === 'new' ? 'bg-blue-50' : 'bg-white'}`;
                row.innerHTML = `
                    <td data-label="Ø§Ù„Ø¹Ù…ÙŠÙ„" class="p-3">
                        <div class="font-semibold">${order.customerName}</div>
                        <div class="text-xs text-gray-500 font-mono">${formattedDate}</div>
                    </td>
                    <td data-label="Ø§Ù„Ù‡Ø§ØªÙ" class="p-3 font-mono" dir="ltr">${order.customerContact}</td>
                    <td data-label="Ø§Ù„Ø·Ù„Ø¨ÙŠØ©" class="p-3 text-sm">${itemsHtml}${couponHtml}</td>
                    <td data-label="Ø§Ù„Ù…Ø¨Ù„Øº" class="p-3 font-mono font-bold">${(order.totalPrice || 0).toLocaleString()} Ø¯.Ø¬</td>
                    <td data-label="Ø§Ù„Ø­Ø§Ù„Ø©" class="p-3">
                        <select class="order-status-select p-2 rounded-lg ${statusColors[order.status] || ''}" data-id="${order.id}">
                            <option value="new" ${order.status === 'new' ? 'selected' : ''}>Ø¬Ø¯ÙŠØ¯</option>
                            <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Ù…ÙƒØªÙ…Ù„</option>
                            <option value="canceled" ${order.status === 'canceled' ? 'selected' : ''}>Ù…Ù„ØºÙŠ</option>
                        </select>
                    </td>
                    <td data-label="Ø¹Ø§Ù…Ù„ Ø§Ù„ØªÙˆØµÙŠÙ„" class="p-3">
                        <select class="delivery-person-select p-2 rounded-lg bg-gray-50 border" data-id="${order.id}">
                            <option value="">-- Ø§Ø®ØªØ± --</option> ${deliveryPersonnelOptions}
                        </select>
                    </td>
                    <td data-label="Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª" class="p-3 flex items-center gap-3">
                        <button class="print-order-btn text-gray-600 hover:text-black" data-id="${order.id}" title="Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙˆØµÙ„"><i class="fas fa-print fa-lg"></i></button>
                        <button class="copy-order-btn text-blue-500 hover:text-blue-700" data-id="${order.id}" title="Ù†Ø³Ø®"><i class="fas fa-copy fa-lg"></i></button>
                        <button class="delete-order-btn text-red-500 hover:text-red-700" data-id="${order.id}" title="Ø­Ø°Ù"><i class="fas fa-trash fa-lg"></i></button>
                    </td>`;
            });
            attachOrderActionListeners();
        }
        function attachOrderActionListeners() {
            document.querySelectorAll('.order-status-select').forEach(sel => sel.onchange = e => updateDoc(doc(db, "orders", e.target.dataset.id), { status: e.target.value }));
            document.querySelectorAll('.delivery-person-select').forEach(sel => sel.onchange = e => {
                const selectedOption = e.target.options[e.target.selectedIndex];
                const personId = selectedOption.value;
                const personName = personId ? selectedOption.text : null;
                updateDoc(doc(db, "orders", e.target.dataset.id), { deliveryPersonId: personId, deliveryPersonName: personName });
            });
            document.querySelectorAll('.delete-order-btn').forEach(btn => btn.onclick = e => {
                const docId = e.currentTarget.dataset.id;
                showDeletionConfirmModal(() => {
                    deleteDoc(doc(db, "orders", docId)).then(() => showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨.', 'success'));
                });
            });
            document.querySelectorAll('.copy-order-btn').forEach(btn => btn.onclick = e => {
                const order = ordersCache.find(o => o.id === e.currentTarget.dataset.id);
                if (!order) return;
                
                 const itemsText = (order.items || []).map(item => {
                    let mainText = `   - ${item.quantity} x ${item.name}`;
                    if(item.selectedAddons && item.selectedAddons.length > 0) {
                        const addonsText = item.selectedAddons.map(a => ` (+ ${a.name})`).join('');
                        mainText += addonsText;
                    }
                    return mainText;
                }).join('\n');

                const couponText = order.couponCode ? `\n\nğŸ‰ ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙˆØ¨ÙˆÙ†: ${order.couponCode}\nğŸ’° Ø§Ù„ØªØ®ÙÙŠØ¶: ${order.discountAmount.toLocaleString()} Ø¯.Ø¬` : '';
                const deliveryPersonText = order.deliveryPersonName ? `\nğŸšš Ø¨ÙˆØ§Ø³Ø·Ø©: ${order.deliveryPersonName}` : '';
                const message = `Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† TEXMEX\n--------------------\nğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${order.customerName}\nğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: ${order.customerContact}\nğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${order.customerLocation}\nğŸ“‹ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©:\n${itemsText}${couponText}\nğŸ’° Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${order.totalPrice.toLocaleString()} Ø¯.Ø¬${deliveryPersonText}\n--------------------`;
                navigator.clipboard.writeText(message).then(() => showToast('ØªÙ… Ù†Ø³Ø® Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!'));
            });
            // NEW: PDF Button Listener
            document.querySelectorAll('.print-order-btn').forEach(btn => btn.onclick = e => {
                const orderId = e.currentTarget.dataset.id;
                const order = ordersCache.find(o => o.id === orderId);
                if (order) {
                    generateOrderPDF(order, orderId);
                }
            });
        }

        // --- NEW: LOYAL CUSTOMERS SECTION ---
        function loadLoyalCustomers() {
            const panel = document.getElementById('loyal-customers-panel');
            panel.innerHTML = `<div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø£ÙˆÙÙŠØ§Ø¡</h1>
                    <div class="relative"><i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="loyal-customer-search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„Ø§Ø³Ù…..." class="w-full md:w-64 pr-10 pl-3 py-2 border rounded-lg"></div>
                </div>
                <div id="loyal-customers-list" class="space-y-3">
                    <div class="bg-white p-6 rounded-xl shadow-md text-center col-span-full"><div class="spinner-dark mx-auto"></div></div>
                </div>`;

            // Process data
            const completedOrders = ordersCache.filter(o => o.status === 'completed');
            const customersData = {};

            completedOrders.forEach(order => {
                const name = order.customerName.trim().toLowerCase();
                if (!customersData[name]) {
                    customersData[name] = {
                        displayName: order.customerName.trim(),
                        orders: [],
                        totalSpent: 0
                    };
                }
                customersData[name].orders.push(order);
                customersData[name].totalSpent += order.totalPrice;
            });

            const customersList = Object.values(customersData).sort((a, b) => b.orders.length - a.orders.length);
            
            renderLoyalCustomers(customersList);

            document.getElementById('loyal-customer-search').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filtered = customersList.filter(c => c.displayName.toLowerCase().includes(searchTerm));
                renderLoyalCustomers(filtered);
            });
        }

        function renderLoyalCustomers(customers) {
            const container = document.getElementById('loyal-customers-list');
            if (customers.length === 0) {
                container.innerHTML = `<div class="bg-white p-8 rounded-xl shadow-md text-center"><p class="text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ù„Ø¹Ø±Ø¶Ù‡Ù….</p></div>`;
                return;
            }
            
            const REWARD_THRESHOLD = 10; // Example: reward every 10 orders

            container.innerHTML = customers.map(customer => {
                const totalOrders = customer.orders.length;
                const ordersUntilNextReward = REWARD_THRESHOLD - (totalOrders % REWARD_THRESHOLD);
                const progressPercentage = ((totalOrders % REWARD_THRESHOLD) / REWARD_THRESHOLD) * 100;

                const orderHistoryHtml = customer.orders.sort((a,b) => b.createdAt.toDate() - a.createdAt.toDate()).map(order => `
                    <tr class="border-b">
                        <td class="p-2">${order.createdAt.toDate().toLocaleDateString('ar-DZ')}</td>
                        <td class="p-2 font-mono">${order.totalPrice.toLocaleString()} Ø¯.Ø¬</td>
                        <td class="p-2"><button class="print-order-btn text-gray-500 hover:text-black" data-id="${order.id}" title="Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙˆØµÙ„"><i class="fas fa-print"></i></button></td>
                    </tr>
                `).join('');

                return `
                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <button class="customer-accordion-toggle w-full text-right p-4 flex justify-between items-center hover:bg-gray-50">
                        <div>
                            <h3 class="text-xl font-bold">${customer.displayName}</h3>
                            <p class="text-sm text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: <span class="font-bold">${totalOrders}</span> | Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ù†ÙØ§Ù‚: <span class="font-bold font-mono">${customer.totalSpent.toLocaleString()} Ø¯.Ø¬</span></p>
                        </div>
                        <i class="fas fa-chevron-down transition-transform"></i>
                    </button>
                    <div class="customer-details bg-gray-50 p-4 border-t">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="md:col-span-2">
                                <h4 class="font-bold mb-2">Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª</h4>
                                <div class="max-h-60 overflow-y-auto pr-2">
                                    <table class="w-full text-sm">
                                        <thead class="bg-gray-200"><tr><th class="p-2">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th class="p-2">Ø§Ù„Ù‚ÙŠÙ…Ø©</th><th class="p-2">ÙˆØµÙ„</th></tr></thead>
                                        <tbody>${orderHistoryHtml}</tbody>
                                    </table>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-bold mb-2">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª (Ù…Ø«Ø§Ù„)</h4>
                                <div class="bg-white p-3 rounded-lg shadow-sm space-y-3">
                                    <p>Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù„Ù„Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©: <span class="font-bold text-orange-600 text-lg">${ordersUntilNextReward}</span></p>
                                    <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-green-500 h-2.5 rounded-full" style="width: ${progressPercentage}%"></div></div>
                                    <button class="w-full bg-orange-500 text-white font-semibold py-2 rounded-lg hover:bg-orange-600 redeem-reward-btn" data-customer-name="${customer.displayName}">ØªØ³Ø¬ÙŠÙ„ Ø§Ø³ØªÙ„Ø§Ù… Ù…ÙƒØ§ÙØ£Ø©</button>
                                    <div>
                                        <label class="text-sm font-semibold">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</label>
                                        <textarea class="w-full mt-1 p-2 border rounded-md text-sm" rows="2" placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø­ÙˆÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
            
            attachLoyalCustomerListeners();
        }

        function attachLoyalCustomerListeners() {
            document.querySelectorAll('.customer-accordion-toggle').forEach(button => {
                button.onclick = () => {
                    const details = button.nextElementSibling;
                    const icon = button.querySelector('i');
                    if (details.style.maxHeight) {
                        details.style.maxHeight = null;
                        icon.classList.remove('rotate-180');
                    } else {
                        details.style.maxHeight = details.scrollHeight + "px";
                        icon.classList.add('rotate-180');
                    }
                }
            });

             document.querySelectorAll('.print-order-btn').forEach(btn => btn.onclick = e => {
                e.stopPropagation(); // Prevent accordion from closing
                const orderId = e.currentTarget.dataset.id;
                const order = ordersCache.find(o => o.id === orderId);
                if (order) generateOrderPDF(order, orderId);
            });

            document.querySelectorAll('.redeem-reward-btn').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const customerName = e.currentTarget.dataset.customerName;
                    // In a real application, you would update a 'rewardsRedeemed' field
                    // for this customer in a dedicated 'customers' collection in Firestore.
                    console.log(`Reward redeemed for ${customerName}. Update Firestore here.`);
                    showToast(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…ÙƒØ§ÙØ£Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„: ${customerName}`, 'success');
                }
            });
        }
        
        // --- MENU ITEMS SECTION ---
        function loadMenuItems() {
            const panel = document.getElementById('menu-items-panel');
            panel.innerHTML = `<div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-6">
                    <div>
                        <h1 class="text-3xl font-bold">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø¹Ø§Ù…</h1>
                        <div class="relative mt-2"><i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="menu-search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ÙˆØ¬Ø¨Ø©..." class="w-full md:w-64 pr-10 pl-3 py-2 border rounded-lg"></div>
                    </div>
                    <button id="add-menu-item-btn" class="bg-orange-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-orange-700 h-fit"><i class="fas fa-plus mr-2"></i> Ø¥Ø¶Ø§ÙØ© ÙˆØ¬Ø¨Ø©</button>
                </div>
                <div id="menu-items-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>`;
            document.getElementById('add-menu-item-btn').onclick = () => showMenuItemModal();
            document.getElementById('menu-search-input').addEventListener('input', renderMenuItemsGrid);
            onSnapshot(query(collection(db, "products"), orderBy("createdAt", "desc")), snapshot => {
                menuItemsCache = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                renderMenuItemsGrid();
            });
        }
        function renderMenuItemsGrid() {
            const list = document.getElementById('menu-items-list');
            const searchTerm = document.getElementById('menu-search-input')?.value.toLowerCase() || '';
            const filteredItems = menuItemsCache.filter(item => 
                (item.name?.ar && item.name.ar.toLowerCase().includes(searchTerm)) || 
                (item.name?.fr && item.name.fr.toLowerCase().includes(searchTerm))
            );

            list.innerHTML = filteredItems.length === 0 ? '<div class="col-span-full text-center p-8 bg-white rounded-lg shadow-sm"><p>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ¬Ø¨Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø¨Ø­Ø«Ùƒ.</p></div>' : '';
            filteredItems.forEach(item => {
                const card = document.createElement('div');
                card.className = `bg-white p-4 rounded-xl shadow-md flex flex-col transition-opacity ${item.isAvailable === false ? 'opacity-50' : ''}`;
                const descriptionContainer = document.createElement('div');
                descriptionContainer.className = 'text-gray-500 text-sm my-2 flex-grow';
                descriptionContainer.innerHTML = item.description || '';

                card.innerHTML = `
                    <img src="${(item.imageUrl) || 'https://via.placeholder.com/300x160.png?text=No+Image'}" class="w-full h-40 object-cover rounded-lg mb-4 bg-gray-100">
                    <div class="flex justify-between items-start">
                        <h3 class="text-xl font-bold">${item.name?.ar || ''} <span class="text-base text-gray-500 font-normal">${item.name?.fr ? '/ ' + item.name.fr : ''}</span></h3>
                        <div class="text-xs text-center">
                            <label class="toggle-switch"><input type="checkbox" class="availability-toggle" data-id="${item.id}" ${item.isAvailable !== false ? 'checked' : ''}><span class="slider"></span></label>
                            <span class="font-semibold">${item.isAvailable !== false ? 'Ù…ØªÙˆÙØ±' : 'Ù†ÙØ°'}</span>
                        </div>
                    </div>
                    <div class="description-content text-gray-500 text-sm my-2 flex-grow">${item.description || ''}</div>
                    <p class="text-lg font-bold text-orange-600">${(item.price || 0).toLocaleString()} Ø¯.Ø¬</p>
                    <div class="border-t mt-4 pt-3 flex justify-end gap-3">
                        <button class="edit-menu-item-btn text-indigo-500" data-id="${item.id}"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="delete-menu-item-btn text-red-500" data-id="${item.id}"><i class="fas fa-trash"></i> Ø­Ø°Ù</button>
                    </div>`;
                card.querySelector('.description-content').innerHTML = item.description || '';
                list.appendChild(card);
            });
            attachMenuItemActionListeners();
        }
        function attachMenuItemActionListeners() {
            document.querySelectorAll('.edit-menu-item-btn').forEach(btn => btn.onclick = e => showMenuItemModal(menuItemsCache.find(i => i.id === e.currentTarget.dataset.id)));
            document.querySelectorAll('.delete-menu-item-btn').forEach(btn => btn.onclick = e => {
                const docId = e.currentTarget.dataset.id;
                showDeletionConfirmModal(async () => {
                    await deleteDoc(doc(db, "products", docId));
                    showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ¬Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                });
            });
            document.querySelectorAll('.availability-toggle').forEach(toggle => toggle.onchange = async e => {
                await updateDoc(doc(db, "products", e.currentTarget.dataset.id), { isAvailable: e.currentTarget.checked });
                showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ¬Ø¨Ø©.', 'success');
            });
        }
        
        function showMenuItemModal(item = null) {
            selectedFileStore.menuItem = null;
            const categoryOptions = categoriesCache.map(c => `<option value="${c.id}" ${item && item.categoryId === c.id ? 'selected' : ''}>${c.name.ar}</option>`).join('');
            
            const content = `<div class="space-y-4">
                <div>
                    <label class="font-semibold text-sm text-gray-700">Ø§Ø³Ù… Ø§Ù„ÙˆØ¬Ø¨Ø© (Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)</label>
                    <input type="text" id="item-name-ar" placeholder="Ù…Ø«Ø§Ù„: ØªØ§ÙƒÙˆØ³ Ø¯Ø¬Ø§Ø¬" class="w-full p-2 border rounded mt-1" value="${item?.name?.ar || ''}" dir="rtl">
                </div>
                <div>
                    <label class="font-semibold text-sm text-gray-700">Ø§Ø³Ù… Ø§Ù„ÙˆØ¬Ø¨Ø© (Ø¨Ø§Ù„Ø£Ø¬Ù†Ø¨ÙŠØ©)</label>
                    <input type="text" id="item-name-fr" placeholder="Ex: Tacos Poulet" class="w-full p-2 border rounded mt-1" value="${item?.name?.fr || ''}" dir="ltr">
                </div>
                <input type="number" id="item-price" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ø¯.Ø¬)" class="w-full p-2 border rounded" value="${item ? item.price : ''}" required>
                <div>
                    <label class="font-semibold text-sm text-gray-700">Ø§Ù„ÙˆØµÙ</label>
                    <div id="item-description-editor" class="mt-1 bg-white"></div>
                </div>
                <select id="item-category" class="w-full p-2 border rounded bg-white"><option value="">Ø§Ø®ØªØ± Ù‚Ø³Ù…...</option>${categoryOptions}</select>
                <div class="border p-3 rounded-lg bg-gray-50">
                    <label class="font-semibold text-sm">ØµÙˆØ±Ø© Ø§Ù„ÙˆØ¬Ø¨Ø©</label>
                    <div id="image-preview" class="mt-2"><img src="${item?.imageUrl || 'https://via.placeholder.com/150'}" class="w-32 h-32 object-cover rounded-md bg-gray-200"></div>
                    <input type="file" id="item-image-file" class="mt-2" accept="image/*">
                </div>
                
                <div class="border p-4 rounded-lg bg-gray-50 space-y-3">
                    <h4 class="font-bold text-gray-800">Ø¥Ø¶Ø§ÙØ§Øª Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ¬Ø¨Ø©</h4>
                    <div id="addons-list" class="space-y-2"></div>
                    <div class="flex gap-2 items-center border-t pt-3">
                        <input type="text" id="addon-name-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¥Ø¶Ø§ÙØ© (Ù…Ø«Ø§Ù„: Ø¬Ø¨Ù†)" class="flex-grow p-2 border rounded">
                        <input type="number" id="addon-price-input" placeholder="Ø§Ù„Ø³Ø¹Ø±" class="w-24 p-2 border rounded">
                        <button type="button" id="add-addon-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600">Ø¥Ø¶Ø§ÙØ©</button>
                    </div>
                </div>
            </div>`;

            showModal(item ? 'ØªØ¹Ø¯ÙŠÙ„ ÙˆØ¬Ø¨Ø©' : 'Ø¥Ø¶Ø§ÙØ© ÙˆØ¬Ø¨Ø©', content, async () => {
                const confirmBtn = document.getElementById('modal-confirm');
                setButtonLoading(confirmBtn, true);

                try {
                    let imageUrl = item?.imageUrl || null;
                    if (selectedFileStore.menuItem) {
                        showToast('Ø¬Ø§Ø±ÙŠ Ø¶ØºØ· ÙˆØ±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...', 'success');
                        const compressedFile = await compressImage(selectedFileStore.menuItem);
                        const uploadResult = await uploadImageToImgBB(compressedFile);

                        if (uploadResult.success) {
                            imageUrl = uploadResult.url;
                        } else {
                            showModal('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©', `<p class="text-lg">Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ø³Ø¨Ø¨ Ø§Ù„ØªØ§Ù„ÙŠ:</p><p class="mt-2 p-3 bg-red-100 text-red-700 rounded-md font-mono text-left dir-ltr">${uploadResult.error}</p><p class="mt-4">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ù…ÙØªØ§Ø­ API Ø§Ù„Ø®Ø§Øµ Ø¨Ø®Ø¯Ù…Ø© ImgBB ÙˆÙ…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.</p>`, closeModal, 'Ø­Ø³Ù†Ù‹Ø§', false);
                            setButtonLoading(confirmBtn, false);
                            return; 
                        }
                    }
                    
                    const nameAr = document.getElementById('item-name-ar').value.trim();
                    const nameFr = document.getElementById('item-name-fr').value.trim();

                    if ((!nameAr && !nameFr) || !document.getElementById('item-price').value) { 
                        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ÙˆØ¬Ø¨Ø© (Ø¨Ù„ØºØ© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„) ÙˆØ§Ù„Ø³Ø¹Ø±.', 'error'); 
                        setButtonLoading(confirmBtn, false); 
                        return;
                    }

                    const addons = [];
                    document.querySelectorAll('.addon-item').forEach(el => {
                        addons.push({
                            name: el.dataset.name,
                            price: parseFloat(el.dataset.price)
                        });
                    });

                    const data = {
                        name: { ar: nameAr, fr: nameFr },
                        price: parseFloat(document.getElementById('item-price').value),
                        description: quillEditor.root.innerHTML,
                        categoryId: document.getElementById('item-category').value,
                        imageUrl: imageUrl, 
                        isAvailable: item?.isAvailable ?? true,
                        addons: addons, 
                        updatedAt: serverTimestamp(),
                    };
                    
                    if (item) {
                        await updateDoc(doc(db, "products", item.id), data);
                    } else {
                        data.createdAt = serverTimestamp();
                        await addDoc(collection(db, "products"), data);
                    }
                    
                    closeModal();
                    showToast(item ? 'ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¬Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­' : 'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ¬Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } catch(error) { 
                    console.error("Save item error:", error);
                    showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: ' + error.message, 'error'); 
                } finally { 
                    setButtonLoading(confirmBtn, false); 
                }
            });
            
            const quillToolbarOptions = [
                [{ 'header': [1, 2, false] }],
                ['bold', 'italic'],
                [{'list': 'ordered'}, {'list': 'bullet'}],
                [{ 'color': [] }],
                [{ 'align': [] }],
                ['clean']
            ];
            quillEditor = new Quill('#item-description-editor', {
                modules: { toolbar: quillToolbarOptions },
                theme: 'snow'
            });
            if (item?.description) {
                quillEditor.root.innerHTML = item.description;
            }

            const addonsListEl = document.getElementById('addons-list');
            const renderAddons = (addons) => {
                addonsListEl.innerHTML = '';
                addons.forEach((addon, index) => {
                    const addonEl = document.createElement('div');
                    addonEl.className = 'addon-item flex justify-between items-center bg-white p-2 rounded-md shadow-sm';
                    addonEl.dataset.name = addon.name;
                    addonEl.dataset.price = addon.price;
                    addonEl.innerHTML = `
                        <span>${addon.name} - <span class="font-mono font-bold">${addon.price} Ø¯.Ø¬</span></span>
                        <button type="button" class="delete-addon-btn text-red-500 hover:text-red-700" data-index="${index}">&times;</button>
                    `;
                    addonsListEl.appendChild(addonEl);
                });
                document.querySelectorAll('.delete-addon-btn').forEach(btn => {
                    btn.onclick = (e) => {
                       const indexToRemove = parseInt(e.currentTarget.dataset.index, 10);
                       const currentAddons = Array.from(document.querySelectorAll('.addon-item')).map(el => ({name: el.dataset.name, price: el.dataset.price}));
                       currentAddons.splice(indexToRemove, 1);
                       renderAddons(currentAddons);
                    };
                });
            };

            if (item && item.addons) {
                renderAddons(item.addons);
            }

            document.getElementById('add-addon-btn').onclick = () => {
                const nameInput = document.getElementById('addon-name-input');
                const priceInput = document.getElementById('addon-price-input');
                const name = nameInput.value.trim();
                const price = parseFloat(priceInput.value);

                if (name && !isNaN(price)) {
                    const currentAddons = Array.from(document.querySelectorAll('.addon-item')).map(el => ({name: el.dataset.name, price: el.dataset.price}));
                    currentAddons.push({ name, price });
                    renderAddons(currentAddons);
                    nameInput.value = '';
                    priceInput.value = '';
                    nameInput.focus();
                } else {
                    showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ÙˆØ³Ø¹Ø± ØµØ­ÙŠØ­ÙŠÙ† Ù„Ù„Ø¥Ø¶Ø§ÙØ©.', 'error');
                }
            };
            
            document.getElementById('item-image-file').onchange = (evt) => {
                if (evt.target.files && evt.target.files[0]) {
                    selectedFileStore.menuItem = evt.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (e) => document.querySelector('#image-preview img').src = e.target.result;
                    reader.readAsDataURL(selectedFileStore.menuItem);
                }
            };
        }

        // --- OFFERS SECTION ---
        function loadOffers() {
            const panel = document.getElementById('offers-panel');
            panel.innerHTML = `<div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold">Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙˆØ§Ù„Ø¨Ø§Ù‚Ø§Øª</h1>
                <button id="add-offer-btn" class="bg-orange-600 text-white px-5 py-2 rounded-lg font-semibold"><i class="fas fa-plus mr-2"></i> Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶</button></div>
                <div id="offers-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>`;
            document.getElementById('add-offer-btn').onclick = () => showOfferModal();
            onSnapshot(query(collection(db, "offers"), orderBy("createdAt", "desc")), snapshot => {
                offersCache = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                const list = document.getElementById('offers-list');
                list.innerHTML = offersCache.length === 0 ? '<p class="col-span-full text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ø­Ø§Ù„ÙŠÙ‹Ø§.</p>' : '';
                offersCache.forEach(offer => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-xl shadow-md flex flex-col';
                    card.innerHTML = `
                        <img src="${offer.imageUrl || 'https://via.placeholder.com/300x160.png?text=Offer'}" class="w-full h-40 object-cover rounded-lg mb-4 bg-gray-100">
                        <h3 class="text-xl font-bold">${offer.title}</h3>
                        <p class="text-gray-500 text-sm my-2 flex-grow">${offer.description || ''}</p>
                        <p class="text-lg font-bold text-green-600">${(offer.price || 0).toLocaleString()} Ø¯.Ø¬</p>
                        <div class="border-t mt-4 pt-3 flex justify-end gap-3">
                            <button class="edit-offer-btn text-indigo-500" data-id="${offer.id}"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="delete-offer-btn text-red-500" data-id="${offer.id}"><i class="fas fa-trash"></i> Ø­Ø°Ù</button>
                        </div>`;
                    list.appendChild(card);
                });
                document.querySelectorAll('.edit-offer-btn').forEach(btn => btn.onclick = e => showOfferModal(offersCache.find(o => o.id === e.currentTarget.dataset.id)));
                document.querySelectorAll('.delete-offer-btn').forEach(btn => btn.onclick = e => {
                    const docId = e.currentTarget.dataset.id;
                    showDeletionConfirmModal(async () => {
                        await deleteDoc(doc(db, "offers", docId));
                        showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                    });
                });
            });
        }
        function showOfferModal(offer = null) {
            selectedFileStore.offer = null;
            const content = `<div class="space-y-4">
                <input type="text" id="offer-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ø±Ø¶" class="w-full p-2 border rounded" value="${offer?.title || ''}" required>
                <input type="number" id="offer-price" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¹Ø±Ø¶ (Ø¯.Ø¬)" class="w-full p-2 border rounded" value="${offer?.price || ''}" required>
                <textarea id="offer-description" rows="3" placeholder="ÙˆØµÙ Ø§Ù„Ø¹Ø±Ø¶" class="w-full p-2 border rounded">${offer?.description || ''}</textarea>
                <div class="border p-3 rounded-lg bg-gray-50">
                    <label class="font-semibold text-sm">ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø±Ø¶</label>
                    <div id="image-preview" class="mt-2"><img src="${offer?.imageUrl || 'https://via.placeholder.com/150'}" class="w-32 h-32 object-cover rounded-md bg-gray-200"></div>
                    <input type="file" id="offer-image-file" class="mt-2" accept="image/*">
                </div>
            </div>`;
            showModal(offer ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶' : 'Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶', content, async () => {
                const confirmBtn = document.getElementById('modal-confirm');
                setButtonLoading(confirmBtn, true);
                try {
                    let imageUrl = offer?.imageUrl || null;
                    if (selectedFileStore.offer) {
                        showToast('Ø¬Ø§Ø±ÙŠ Ø¶ØºØ· ÙˆØ±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...', 'success');
                        const compressedFile = await compressImage(selectedFileStore.offer);
                        const uploadResult = await uploadImageToImgBB(compressedFile);

                        if(uploadResult.success) {
                            imageUrl = uploadResult.url;
                        } else {
                             showModal('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©', 
                                `<p class="text-lg">Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ø³Ø¨Ø¨ Ø§Ù„ØªØ§Ù„ÙŠ:</p><p class="mt-2 p-3 bg-red-100 text-red-700 rounded-md font-mono text-left dir-ltr">${uploadResult.error}</p>`,
                                closeModal, 'Ø­Ø³Ù†Ù‹Ø§', false);
                            setButtonLoading(confirmBtn, false);
                            return;
                        }
                    }
                    const data = {
                        title: document.getElementById('offer-title').value.trim(),
                        price: parseFloat(document.getElementById('offer-price').value),
                        description: document.getElementById('offer-description').value.trim(),
                        imageUrl,
                        updatedAt: serverTimestamp()
                    };
                    if (!data.title || isNaN(data.price)) { showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† ÙˆØ³Ø¹Ø± Ø§Ù„Ø¹Ø±Ø¶.', 'error'); setButtonLoading(confirmBtn, false); return; }
                    
                    if (offer) await updateDoc(doc(db, "offers", offer.id), data);
                    else { data.createdAt = serverTimestamp(); await addDoc(collection(db, "offers"), data); }
                    
                    closeModal();
                    showToast(offer ? 'ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶' : 'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø±Ø¶', 'success');
                } catch (error) { showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: ' + error.message, 'error'); } 
                finally { setButtonLoading(confirmBtn, false); }
            });
            document.getElementById('offer-image-file').onchange = (evt) => {
                if (evt.target.files && evt.target.files[0]) {
                    selectedFileStore.offer = evt.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (e) => document.querySelector('#image-preview img').src = e.target.result;
                    reader.readAsDataURL(selectedFileStore.offer);
                }
            };
        }

        // --- COUPONS SECTION ---
        function loadCoupons() {
            const panel = document.getElementById('coupons-panel');
            panel.innerHTML = `<div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª</h1><button id="add-coupon-btn" class="bg-orange-600 text-white px-5 py-2 rounded-lg font-semibold"><i class="fas fa-plus mr-2"></i> Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¨ÙˆÙ†</button></div>
                <div class="overflow-x-auto bg-white rounded-xl shadow-md">
                <table class="w-full text-right responsive-table"><thead class="bg-gray-100"><tr>
                    <th class="p-3">Ø§Ù„ÙƒÙˆØ¯</th><th class="p-3">Ù†ÙˆØ¹/Ù‚ÙŠÙ…Ø© Ø§Ù„ØªØ®ÙÙŠØ¶</th><th class="p-3">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th class="p-3">Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</th><th class="p-3">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th><th class="p-3">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr></thead><tbody id="coupons-table-body"></tbody></table></div>`;
            document.getElementById('add-coupon-btn').onclick = () => showCouponModal();
            onSnapshot(query(collection(db, "coupons"), orderBy("createdAt", "desc")), snapshot => {
                couponsCache = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                renderCouponsTable();
            });
        }
        function renderCouponsTable() {
            const tBody = document.getElementById('coupons-table-body');
            tBody.innerHTML = couponsCache.length === 0 ? `<tr><td colspan="6" class="p-8 text-center">Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ ÙƒÙˆØ¨ÙˆÙ†Ø§Øª Ø¨Ø¹Ø¯.</td></tr>` : '';
            
            couponsCache.forEach(coupon => {
                const now = new Date();
                const expiryDate = coupon.expiresAt?.toDate();
                let statusText = coupon.isActive ? 'Ù†Ø´Ø·' : 'Ù…Ø¹Ø·Ù„';
                let statusClass = coupon.isActive ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';

                if (expiryDate && expiryDate < now) {
                    statusText = 'Ù…Ù†ØªÙ‡ÙŠ';
                    statusClass = 'bg-red-100 text-red-800';
                }

                const discountText = coupon.discountType === 'percentage'
                    ? `${coupon.discountValue}%`
                    : `${(coupon.discountValue || 0).toLocaleString()} Ø¯.Ø¬`;
                
                let expiryText = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
                if (expiryDate) {
                    expiryText = expiryDate.toLocaleDateString('ar-EG');
                }

                const usageText = `${coupon.usageCount || 0} Ù…Ø±Ø©`;

                const row = document.createElement('tr');
                row.className = 'border-b';
                row.innerHTML = `
                    <td data-label="Ø§Ù„ÙƒÙˆØ¯" class="p-3 font-mono font-bold">${coupon.code}</td>
                    <td data-label="Ø§Ù„ØªØ®ÙÙŠØ¶" class="p-3">${discountText}</td>
                    <td data-label="Ø§Ù„Ø­Ø§Ù„Ø©" class="p-3"><span class="px-2 py-1 text-sm font-semibold rounded-full ${statusClass}">${statusText}</span></td>
                    <td data-label="Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…" class="p-3">${usageText}</td>
                    <td data-label="Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡" class="p-3 font-mono">${expiryText}</td>
                    <td data-label="Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª" class="p-3">
                        <button class="edit-coupon-btn text-indigo-500 mr-4" data-id="${coupon.id}"><i class="fas fa-edit"></i></button>
                        <button class="delete-coupon-btn text-red-500" data-id="${coupon.id}"><i class="fas fa-trash"></i></button>
                    </td>`;
                tBody.appendChild(row);
            });

            document.querySelectorAll('.edit-coupon-btn').forEach(btn => btn.onclick = e => showCouponModal(couponsCache.find(c => c.id === e.currentTarget.dataset.id)));
            document.querySelectorAll('.delete-coupon-btn').forEach(btn => btn.onclick = e => {
                const docId = e.currentTarget.dataset.id;
                showDeletionConfirmModal(() => {
                    deleteDoc(doc(db, "coupons", docId)).then(() => showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†', 'success'));
                });
            });
        }
        function showCouponModal(coupon = null) {
            const productOptions = menuItemsCache.map(p => `<option value="${p.id}">${p.name.ar || p.name.fr}</option>`).join('');
            const content = `<div class="space-y-4">
                <input type="text" id="coupon-code" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØªØ®ÙÙŠØ¶ (Ù…Ø«Ø§Ù„: SAVE10)" class="w-full p-2 border rounded uppercase" value="${coupon?.code || ''}">
                <textarea id="coupon-description" rows="2" placeholder="ÙˆØµÙ Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù„ÙƒÙˆØ¨ÙˆÙ† (Ù„Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†ØŸ)" class="w-full p-2 border rounded">${coupon?.description || ''}</textarea>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="font-semibold text-sm">Ù†ÙˆØ¹ Ø§Ù„ØªØ®ÙÙŠØ¶</label>
                        <select id="coupon-type" class="w-full p-2 mt-1 border rounded bg-white">
                            <option value="percentage" ${coupon?.discountType === 'percentage' ? 'selected' : ''}>Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ© (%)</option>
                            <option value="fixed" ${coupon?.discountType === 'fixed' ? 'selected' : ''}>Ù…Ø¨Ù„Øº Ø«Ø§Ø¨Øª (Ø¯.Ø¬)</option>
                        </select>
                    </div>
                    <div>
                        <label class="font-semibold text-sm">Ù‚ÙŠÙ…Ø© Ø§Ù„ØªØ®ÙÙŠØ¶</label>
                        <input type="number" id="coupon-value" placeholder="Ù…Ø«Ø§Ù„: 10 Ø£Ùˆ 100" class="w-full p-2 mt-1 border rounded" value="${coupon?.discountValue || ''}">
                    </div>
                </div>
                <div>
                    <label class="font-semibold text-sm">ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input type="date" id="coupon-expiry" class="w-full p-2 mt-1 border rounded" value="${coupon?.expiresAt ? coupon.expiresAt.toDate().toISOString().split('T')[0] : ''}">
                </div>
                <div>
                    <label class="font-semibold text-sm">Ø¹Ù„Ù‰ Ù…Ø§Ø°Ø§ ÙŠØ·Ø¨Ù‚ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†ØŸ</label>
                    <select id="coupon-applies-to" class="w-full p-2 mt-1 border rounded bg-white">
                        <option value="all" ${coupon?.appliesTo === 'all' ? 'selected' : ''}>ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</option>
                        <option value="specific_products" ${coupon?.appliesTo === 'specific_products' ? 'selected' : ''}>Ù…Ù†ØªØ¬Ø§Øª Ù…Ø­Ø¯Ø¯Ø©</option>
                    </select>
                </div>
                <div id="coupon-products-container" class="hidden">
                    <label class="font-semibold text-sm">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</label>
                    <select id="coupon-products" multiple class="w-full p-2 mt-1 border rounded bg-white h-32">${productOptions}</select>
                </div>
                <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                    <label for="coupon-active-toggle" class="font-semibold">ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†</label>
                    <label class="toggle-switch"><input type="checkbox" id="coupon-active-toggle" ${coupon?.isActive !== false ? 'checked' : ''}><span class="slider"></span></label>
                </div>
            </div>`;

            showModal(coupon ? 'ØªØ¹Ø¯ÙŠÙ„ ÙƒÙˆØ¨ÙˆÙ†' : 'Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¨ÙˆÙ†', content, async () => {
                const confirmBtn = document.getElementById('modal-confirm');
                setButtonLoading(confirmBtn, true);
                try {
                    const expiryDate = document.getElementById('coupon-expiry').value;
                    const selectedProducts = Array.from(document.getElementById('coupon-products').selectedOptions).map(opt => opt.value);
                    const data = {
                        code: document.getElementById('coupon-code').value.trim().toUpperCase(),
                        description: document.getElementById('coupon-description').value.trim(),
                        discountType: document.getElementById('coupon-type').value,
                        discountValue: parseFloat(document.getElementById('coupon-value').value),
                        expiresAt: expiryDate ? Timestamp.fromDate(new Date(expiryDate)) : null,
                        appliesTo: document.getElementById('coupon-applies-to').value,
                        productIds: document.getElementById('coupon-applies-to').value === 'specific_products' ? selectedProducts : [],
                        isActive: document.getElementById('coupon-active-toggle').checked,
                        updatedAt: serverTimestamp()
                    };

                    if(!data.code || isNaN(data.discountValue)) {
                        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙˆÙ‚ÙŠÙ…Ø© Ø§Ù„ØªØ®ÙÙŠØ¶.', 'error');
                        setButtonLoading(confirmBtn, false);
                        return;
                    }
                    if(data.appliesTo === 'specific_products' && data.productIds.length === 0){
                        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø£Ùˆ ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.', 'error');
                        setButtonLoading(confirmBtn, false);
                        return;
                    }

                    if (coupon) {
                        await updateDoc(doc(db, "coupons", coupon.id), data);
                    } else {
                        data.createdAt = serverTimestamp();
                        data.usageCount = 0;
                        await addDoc(collection(db, "coupons"), data);
                    }
                    closeModal();
                    showToast(coupon ? 'ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†' : 'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†', 'success');
                } catch (error) {
                    console.error("Coupon save error: ", error);
                    showToast('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message, 'error');
                } finally {
                    setButtonLoading(confirmBtn, false);
                }
            });

            const appliesToSelect = document.getElementById('coupon-applies-to');
            const productsContainer = document.getElementById('coupon-products-container');
            const toggleProducts = () => {
                productsContainer.classList.toggle('hidden', appliesToSelect.value !== 'specific_products');
            };
            appliesToSelect.onchange = toggleProducts;

            if (coupon?.appliesTo === 'specific_products' && coupon.productIds) {
                coupon.productIds.forEach(id => {
                    const option = document.querySelector(`#coupon-products option[value="${id}"]`);
                    if (option) option.selected = true;
                });
            }
            toggleProducts();
        }

        // --- CATEGORIES SECTION ---
        function loadCategories() {
            const panel = document.getElementById('categories-panel');
            panel.innerHTML = `<div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h1><button id="add-cat-btn" class="bg-orange-600 text-white px-5 py-2 rounded-lg font-semibold"><i class="fas fa-plus mr-2"></i> Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…</button></div>
                <div id="categories-list" class="space-y-3"></div>`;
            document.getElementById('add-cat-btn').onclick = () => showCategoryModal();
            onSnapshot(query(collection(db, "categories"), orderBy("name.ar")), snapshot => {
                categoriesCache = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                const list = document.getElementById('categories-list');
                list.innerHTML = '';
                categoriesCache.forEach(cat => {
                    const el = document.createElement('div');
                    el.className = 'bg-white p-4 rounded-xl shadow-md flex justify-between items-center';
                    el.innerHTML = `<h4 class="text-xl font-bold">${cat.name.ar || ''} <span class="text-base text-gray-500 font-normal">${cat.name.fr ? '/ ' + cat.name.fr : ''}</span></h4><div>
                        <button class="edit-cat-btn text-indigo-500 mr-4" data-id="${cat.id}"><i class="fas fa-edit"></i></button>
                        <button class="delete-cat-btn text-red-500" data-id="${cat.id}"><i class="fas fa-trash"></i></button></div>`;
                    list.appendChild(el);
                });
                document.querySelectorAll('.edit-cat-btn').forEach(btn => btn.onclick = e => showCategoryModal(categoriesCache.find(c => c.id === e.currentTarget.dataset.id)));
                document.querySelectorAll('.delete-cat-btn').forEach(btn => btn.onclick = e => {
                    const docId = e.currentTarget.dataset.id;
                    showDeletionConfirmModal(() => {
                        deleteDoc(doc(db, "categories", docId)).then(() => showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù…', 'success'));
                    });
                });
            });
        }
        function showCategoryModal(cat = null) {
            const content = `<div class="space-y-4">
                <div>
                    <label class="font-semibold text-sm text-gray-700">Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… (Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)</label>
                    <input type="text" id="cat-name-ar" placeholder="Ù…Ø«Ø§Ù„: ØªØ§ÙƒÙˆØ³" class="w-full p-2 border rounded mt-1" value="${cat?.name?.ar || ''}" dir="rtl">
                </div>
                <div>
                    <label class="font-semibold text-sm text-gray-700">Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… (Ø¨Ø§Ù„Ø£Ø¬Ù†Ø¨ÙŠØ©)</label>
                    <input type="text" id="cat-name-fr" placeholder="Ex: Tacos" class="w-full p-2 border rounded mt-1" value="${cat?.name?.fr || ''}" dir="ltr">
                </div>
            </div>`;
            showModal(cat ? 'ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø³Ù…' : 'Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…', content, async () => {
                const nameAr = document.getElementById('cat-name-ar').value.trim();
                const nameFr = document.getElementById('cat-name-fr').value.trim();

                if (!nameAr && !nameFr) { 
                    showToast('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ø¨Ù„ØºØ© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.', 'error'); 
                    return; 
                }
                
                const nameData = { ar: nameAr, fr: nameFr };

                if (cat) await updateDoc(doc(db, "categories", cat.id), { name: nameData });
                else await addDoc(collection(db, "categories"), { name: nameData });

                closeModal();
                showToast(cat ? 'ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù…' : 'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù…', 'success');
            });
        }
        
        // --- DELIVERY PERSONNEL SECTION ---
        function loadDeliveryPersonnel() {
            const panel = document.getElementById('delivery-personnel-panel');
            panel.innerHTML = `<div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold">Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù…Ø§Ù„ Ø§Ù„ØªÙˆØµÙŠÙ„</h1><button id="add-personnel-btn" class="bg-orange-600 text-white px-5 py-2 rounded-lg font-semibold"><i class="fas fa-plus mr-2"></i> Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ù…Ù„</button></div>
                <div class="overflow-x-auto bg-white rounded-xl shadow-md">
                <table class="w-full text-right">
                    <thead class="bg-gray-100"><tr><th class="p-3">Ø§Ù„Ø§Ø³Ù…</th><th class="p-3">Ø§Ù„Ù‡Ø§ØªÙ</th><th class="p-3">Ø§Ù„Ø­Ø§Ù„Ø©</th><th class="p-3">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                    <tbody id="personnel-table-body"></tbody>
                </table></div>`;
            document.getElementById('add-personnel-btn').onclick = () => showPersonnelModal();
            onSnapshot(query(collection(db, "delivery_personnel"), orderBy("name")), snapshot => {
                deliveryPersonnelCache = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                const tBody = document.getElementById('personnel-table-body');
                tBody.innerHTML = '';
                deliveryPersonnelCache.forEach(person => {
                    const statusClass = person.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    tBody.innerHTML += `<tr class="border-b"><td class="p-3 font-semibold">${person.name}</td><td class="p-3 font-mono" dir="ltr">${person.phone}</td>
                        <td class="p-3"><span class="px-2 py-1 text-sm font-semibold rounded-full ${statusClass}">${person.status === 'active' ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·'}</span></td>
                        <td class="p-3"><button class="edit-personnel-btn text-indigo-500 mr-4" data-id="${person.id}"><i class="fas fa-edit"></i></button><button class="delete-personnel-btn text-red-500" data-id="${person.id}"><i class="fas fa-trash"></i></button></td></tr>`;
                });
                document.querySelectorAll('.edit-personnel-btn').forEach(btn => btn.onclick = e => showPersonnelModal(deliveryPersonnelCache.find(p => p.id === e.currentTarget.dataset.id)));
                document.querySelectorAll('.delete-personnel-btn').forEach(btn => btn.onclick = e => {
                    const docId = e.currentTarget.dataset.id;
                    showDeletionConfirmModal(() => {
                        deleteDoc(doc(db, "delivery_personnel", docId)).then(() => showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ø§Ù…Ù„', 'success'));
                    });
                });
            });
        }
        function showPersonnelModal(person = null) {
            const content = `<div class="space-y-4"><input type="text" id="person-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„" class="w-full p-2 border rounded" value="${person ? person.name : ''}" required>
                <input type="tel" id="person-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" class="w-full p-2 border rounded" value="${person ? person.phone : ''}" required dir="ltr">
                <div><label class="font-semibold text-sm">Ø§Ù„Ø­Ø§Ù„Ø©</label><select id="person-status" class="w-full p-2 mt-1 border rounded bg-white">
                    <option value="active" ${person && person.status === 'active' ? 'selected' : ''}>Ù†Ø´Ø·</option>
                    <option value="inactive" ${person && person.status === 'inactive' ? 'selected' : ''}>ØºÙŠØ± Ù†Ø´Ø·</option></select></div></div>`;
            showModal(person ? 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ù„' : 'Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ù…Ù„', content, async () => {
                const data = { name: document.getElementById('person-name').value.trim(), phone: document.getElementById('person-phone').value.trim(), status: document.getElementById('person-status').value, };
                if (!data.name || !data.phone) { showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù‡Ø§ØªÙ.', 'error'); return; }
                if (person) await updateDoc(doc(db, "delivery_personnel", person.id), data);
                else await addDoc(collection(db, "delivery_personnel"), data);
                closeModal();
                showToast('ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ù„', 'success');
            });
        }
        
        // --- STATS SECTION ---
        async function loadStats() {
            const panel = document.getElementById('stats-panel');
            panel.innerHTML = `<h1 class="text-3xl font-bold text-gray-800 mb-6">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h1><div id="stats-content"><div class="text-center p-10"><div class="spinner-dark mx-auto"></div></div></div>`;
            const statsContent = document.getElementById('stats-content');

            try {
                const ordersSnapshot = await getDocs(query(collection(db, "orders"), where("status", "==", "completed")));
                const allCompletedOrders = ordersSnapshot.docs.map(d => d.data());
                
                const totalRevenue = allCompletedOrders.reduce((sum, order) => sum + (order.totalPrice || 0), 0);
                const totalOrders = allCompletedOrders.length;

                const salesByDay = {};
                for (let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    const key = d.toISOString().split('T')[0];
                    salesByDay[key] = { label: d.toLocaleDateString('ar-DZ', { weekday: 'short' }), revenue: 0 };
                }
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                allCompletedOrders.forEach(order => {
                    if (order.createdAt && typeof order.createdAt.toDate === 'function') {
                        const orderDate = order.createdAt.toDate();
                        if (orderDate >= sevenDaysAgo) {
                            const key = orderDate.toISOString().split('T')[0];
                            if (salesByDay[key]) {
                                salesByDay[key].revenue += order.totalPrice;
                            }
                        }
                    }
                });
                const chartData = Object.values(salesByDay);
                const maxRevenue = Math.max(...chartData.map(d => d.revenue));

                const itemCounts = {};
                allCompletedOrders.forEach(order => {
                    (order.items || []).forEach(item => {
                        itemCounts[item.name] = (itemCounts[item.name] || 0) + item.quantity;
                    });
                });
                const topItems = Object.entries(itemCounts)
                    .sort(([,a],[,b]) => b - a)
                    .slice(0, 5);

                const couponCounts = {};
                allCompletedOrders.forEach(order => {
                    if (order.couponCode) {
                        couponCounts[order.couponCode] = (couponCounts[order.couponCode] || 0) + 1;
                    }
                });
                const topCoupons = Object.entries(couponCounts)
                    .sort(([,a],[,b]) => b - a)
                    .slice(0, 5);

                statsContent.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-4">
                            <i class="fas fa-coins fa-3x text-yellow-500"></i>
                            <div><p class="text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</p><p class="text-2xl font-bold">${totalRevenue.toLocaleString()} Ø¯.Ø¬</p></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-4">
                            <i class="fas fa-receipt fa-3x text-purple-500"></i>
                            <div><p class="text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</p><p class="text-2xl font-bold">${totalOrders}</p></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
                            <h3 class="text-xl font-bold mb-4">Ù…Ø¨ÙŠØ¹Ø§Øª Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</h3>
                            <div class="flex justify-between items-end h-64 gap-2 border-b border-gray-200 pb-2">
                                ${chartData.map(day => `
                                    <div class="flex-1 flex flex-col items-center justify-end">
                                        <div class="text-xs font-bold">${day.revenue > 0 ? day.revenue.toLocaleString() : ''}</div>
                                        <div class="w-3/4 bg-orange-200 rounded-t-lg" style="height: ${maxRevenue > 0 ? (day.revenue / maxRevenue) * 90 : 0}%;"></div>
                                        <div class="text-sm text-gray-500 mt-1">${day.label}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h3 class="text-xl font-bold mb-4">Ø£ÙØ¶Ù„ 5 ÙˆØ¬Ø¨Ø§Øª Ù…Ø¨ÙŠØ¹Ù‹Ø§</h3>
                            <ul class="space-y-3">
                                ${topItems.length > 0 ? topItems.map(([name, count], index) => `
                                    <li class="flex items-center justify-between">
                                        <span class="font-semibold"><span class="text-gray-400 font-bold">${index + 1}.</span> ${name}</span>
                                        <span class="bg-gray-100 px-3 py-1 rounded-full text-sm font-bold">${count} Ù…Ø±Ø©</span>
                                    </li>
                                `).join('') : '<p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ©.</p>'}
                            </ul>
                        </div>
                         <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-md">
                            <h3 class="text-xl font-bold mb-4">Ø£ÙƒØ«Ø± Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‹Ø§</h3>
                            <ul class="space-y-3">
                                ${topCoupons.length > 0 ? topCoupons.map(([code, count], index) => `
                                    <li class="flex items-center justify-between">
                                        <span class="font-semibold"><span class="text-gray-400 font-bold">${index + 1}.</span> <span class="font-mono bg-gray-100 px-2 py-1 rounded">${code}</span></span>
                                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-bold">${count} Ø§Ø³ØªØ®Ø¯Ø§Ù…</span>
                                    </li>
                                `).join('') : '<p class="text-gray-500">Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£ÙŠ ÙƒÙˆØ¨ÙˆÙ†Ø§Øª Ø¨Ø¹Ø¯.</p>'}
                            </ul>
                        </div>
                    </div>
                `;
            } catch(error) {
                console.error("Error loading stats:", error);
                statsContent.innerHTML = `<div class="bg-red-100 text-red-700 p-4 rounded-lg">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª.</div>`;
            }
        }
        
        // --- DELIVERY SETTINGS ---
        function loadDeliverySettings() {
            const panel = document.getElementById('delivery-panel');
            panel.innerHTML = `<div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold">Ù…Ù†Ø§Ø·Ù‚ ÙˆØ£Ø³Ø¹Ø§Ø± Ø§Ù„ØªÙˆØµÙŠÙ„</h1><button id="add-zone-btn" class="bg-orange-600 text-white px-5 py-2 rounded-lg font-semibold"><i class="fas fa-plus mr-2"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚Ø©</button></div>
                <div class="overflow-x-auto bg-white rounded-xl shadow-md">
                <table class="w-full text-right"><thead class="bg-gray-100"><tr>
                    <th class="p-3">Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th><th class="p-3">Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø¹Ø§Ø¯ÙŠ</th><th class="p-3">Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹</th><th class="p-3">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr></thead><tbody id="zones-table-body"></tbody></table></div>`;
            document.getElementById('add-zone-btn').onclick = () => showZoneModal();
            onSnapshot(query(collection(db, "delivery_zones"), orderBy("name")), snapshot => {
                deliveryZonesCache = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                const tBody = document.getElementById('zones-table-body');
                tBody.innerHTML = deliveryZonesCache.length === 0 ? `<tr><td colspan="4" class="p-8 text-center">Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ù†Ø§Ø·Ù‚ ØªÙˆØµÙŠÙ„ Ø¨Ø¹Ø¯.</td></tr>` : '';
                deliveryZonesCache.forEach(zone => {
                    tBody.innerHTML += `<tr class="border-b">
                        <td class="p-3 font-semibold">${zone.name}</td>
                        <td class="p-3 font-mono">${(zone.price_normal || 0).toLocaleString()} Ø¯.Ø¬</td>
                        <td class="p-3 font-mono">${(zone.price_fast || 0).toLocaleString()} Ø¯.Ø¬</td>
                        <td class="p-3">
                            <button class="edit-zone-btn text-indigo-500 mr-4" data-id="${zone.id}"><i class="fas fa-edit"></i></button>
                            <button class="delete-zone-btn text-red-500" data-id="${zone.id}"><i class="fas fa-trash"></i></button>
                        </td></tr>`;
                });
                document.querySelectorAll('.edit-zone-btn').forEach(btn => btn.onclick = e => showZoneModal(deliveryZonesCache.find(z => z.id === e.currentTarget.dataset.id)));
                document.querySelectorAll('.delete-zone-btn').forEach(btn => btn.onclick = e => {
                    const docId = e.currentTarget.dataset.id;
                    showDeletionConfirmModal(() => {
                        deleteDoc(doc(db, "delivery_zones", docId)).then(() => showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø·Ù‚Ø©', 'success'));
                    });
                });
            });
        }
        function showZoneModal(zone = null) {
            const content = `<div class="space-y-4">
                <input type="text" id="zone-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø© (Ù…Ø«Ø§Ù„: ÙˆØ³Ø· Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©)" class="w-full p-2 border rounded" value="${zone?.name || ''}" required>
                <input type="number" id="zone-price-normal" placeholder="Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø¹Ø§Ø¯ÙŠ (Ø¯.Ø¬)" class="w-full p-2 border rounded" value="${zone?.price_normal || ''}" required>
                <input type="number" id="zone-price-fast" placeholder="Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ (Ø¯.Ø¬)" class="w-full p-2 border rounded" value="${zone?.price_fast || ''}">
            </div>`;
            showModal(zone ? 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†Ø·Ù‚Ø©' : 'Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚Ø©', content, async () => {
                const data = {
                    name: document.getElementById('zone-name').value.trim(),
                    price_normal: parseFloat(document.getElementById('zone-price-normal').value) || 0,
                    price_fast: parseFloat(document.getElementById('zone-price-fast').value) || 0
                };
                if (!data.name) { showToast('Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ù…Ø·Ù„ÙˆØ¨.', 'error'); return; }
                if (zone) await updateDoc(doc(db, "delivery_zones", zone.id), data);
                else await addDoc(collection(db, "delivery_zones"), data);
                closeModal();
                showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            });
        }
        
        // --- RESTAURANT SETTINGS ---
        async function loadRestaurantSettings() {
            const panel = document.getElementById('settings-panel');
            panel.innerHTML = `<div class="spinner-dark mx-auto mt-10"></div>`;
            const docRef = doc(db, "settings", "config");
            const docSnap = await getDoc(docRef);
            const settings = docSnap.exists() ? docSnap.data() : {};

            panel.innerHTML = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ø¹Ù…</h1>
                <div class="space-y-8">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold mb-4 border-b pb-2">Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø·Ø¹Ù… (Ø§Ù„Ù„ÙˆÙ‚Ùˆ)</h3>
                        <p class="text-sm text-gray-500 mb-3">Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø´Ø¹Ø§Ø± Ø§Ù„Ø°ÙŠ ÙŠØ¸Ù‡Ø± Ù„Ù„Ø²Ø¨Ø§Ø¦Ù† ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø·Ù„Ø¨.</p>
                        <div id="logo-image-preview" class="mt-2 mb-3">
                            <img src="${settings.logoUrl || 'https://via.placeholder.com/200x80.png?text=Logo'}" class="w-40 h-auto object-contain rounded-md bg-gray-100 p-2 border">
                        </div>
                        <input type="file" id="logo-image-file" accept="image/*" class="mt-2">
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold mb-4 border-b pb-2">Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø·Ø¹Ù…</h3>
                         <div class="flex items-center justify-between bg-red-50 p-4 rounded-lg">
                             <label for="manual-closed-toggle" class="font-semibold text-lg text-red-800">ÙØ±Ø¶ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø·Ø¹Ù… (Ù„Ù„Ø·ÙˆØ§Ø±Ø¦)</label>
                             <label class="toggle-switch"><input type="checkbox" id="manual-closed-toggle" ${settings.isManuallyClosed ? 'checked' : ''}><span class="slider"></span></label>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold mb-4 border-b pb-2">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label class="font-semibold">ÙˆÙ‚Øª Ø§Ù„ÙØªØ­</label><input type="time" id="open-time" class="w-full p-2 mt-1 border rounded" value="${settings.openTime || ''}"></div>
                            <div><label class="font-semibold">ÙˆÙ‚Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚</label><input type="time" id="close-time" class="w-full p-2 mt-1 border rounded" value="${settings.closeTime || ''}"></div>
                            <div>
                                <label class="font-semibold">Ø·Ø±ÙŠÙ‚Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ (ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†)</label>
                                <select id="name-display-preference" class="w-full p-2 mt-1 border rounded bg-white">
                                    <option value="both" ${settings.nameDisplayPreference === 'both' ? 'selected' : ''}>Ø¹Ø±Ø¶ Ø§Ù„Ù„ØºØªÙŠÙ† Ù…Ø¹Ù‹Ø§</option>
                                    <option value="ar" ${settings.nameDisplayPreference === 'ar' ? 'selected' : ''}>Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙÙ‚Ø·</option>
                                    <option value="fr" ${settings.nameDisplayPreference === 'fr' ? 'selected' : ''}>Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¬Ù†Ø¨ÙŠØ© ÙÙ‚Ø·</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4"><label class="font-semibold">Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚</label><input type="text" id="closed-message" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù…Ø·Ø¹Ù… Ù…ØºÙ„Ù‚ Ø­Ø§Ù„ÙŠÙ‹Ø§ØŒ Ù†ÙØªØ­ ØºØ¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¹Ø© 11:00" class="w-full p-2 mt-1 border rounded" value="${settings.closedMessage || ''}"></div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold mb-4 border-b pb-2">Ø¹Ø±Ø¶ Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ</h3>
                        <div class="flex items-center justify-between">
                             <label for="free-delivery-toggle" class="font-semibold text-lg">ØªÙØ¹ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ</label>
                             <label class="toggle-switch"><input type="checkbox" id="free-delivery-toggle" ${settings.isFreeDeliveryActive ? 'checked' : ''}><span class="slider"></span></label>
                        </div>
                        <div class="mt-4">
                            <label class="font-semibold">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ (Ø¯.Ø¬)</label>
                            <input type="number" id="free-delivery-threshold" placeholder="Ù…Ø«Ø§Ù„: 1000" class="w-full p-2 mt-1 border rounded" value="${settings.freeDeliveryThreshold || ''}">
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold mb-4 border-b pb-2">Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªÙˆØ§ØµÙ„</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="social-phone1" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù„Ù„Ø§ØªØµØ§Ù„)" class="p-2 border rounded" value="${settings.socialLinks?.phone1 || ''}">
                            <input type="text" id="social-whatsapp1" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ (Ø¨Ø¯ÙˆÙ† +)" class="p-2 border rounded" value="${settings.socialLinks?.whatsapp1 || ''}">
                            <input type="url" id="social-facebook1" placeholder="Ø±Ø§Ø¨Ø· ÙÙŠØ³Ø¨ÙˆÙƒ" class="p-2 border rounded" value="${settings.socialLinks?.facebook1 || ''}">
                            <input type="url" id="social-instagram1" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù†Ø³ØªØºØ±Ø§Ù…" class="p-2 border rounded" value="${settings.socialLinks?.instagram1 || ''}">
                        </div>
                    </div>
                </div>
                <div class="mt-8 text-right">
                    <button id="save-settings-btn" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700">Ø­ÙØ¸ ÙƒÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                </div>`;

            document.getElementById('logo-image-file').onchange = (evt) => {
                if (evt.target.files && evt.target.files[0]) {
                    selectedFileStore.logo = evt.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (e) => document.querySelector('#logo-image-preview img').src = e.target.result;
                    reader.readAsDataURL(selectedFileStore.logo);
                }
            };
            
            document.getElementById('save-settings-btn').onclick = () => saveGeneralSettings(settings);
        }
        async function saveGeneralSettings(currentSettings) { 
            const btn = document.getElementById('save-settings-btn');
            setButtonLoading(btn, true, 'Ø­ÙØ¸ ÙƒÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
            
            try {
                let logoUrl = currentSettings.logoUrl || null;

                if (selectedFileStore.logo) {
                    showToast('Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯...', 'success');
                    const compressedFile = await compressImage(selectedFileStore.logo, 400);
                    const uploadResult = await uploadImageToImgBB(compressedFile);
                    if (uploadResult.success) {
                        logoUrl = uploadResult.url;
                        selectedFileStore.logo = null;
                    } else {
                        showToast(`ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø±: ${uploadResult.error}`, 'error');
                        setButtonLoading(btn, false, 'Ø­ÙØ¸ ÙƒÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
                        return;
                    }
                }

                const settingsData = {
                    logoUrl: logoUrl,
                    isManuallyClosed: document.getElementById('manual-closed-toggle').checked,
                    openTime: document.getElementById('open-time').value,
                    closeTime: document.getElementById('close-time').value,
                    closedMessage: document.getElementById('closed-message').value,
                    isFreeDeliveryActive: document.getElementById('free-delivery-toggle').checked,
                    freeDeliveryThreshold: parseFloat(document.getElementById('free-delivery-threshold').value) || 0,
                    nameDisplayPreference: document.getElementById('name-display-preference').value,
                    socialLinks: {
                        phone1: document.getElementById('social-phone1').value,
                        whatsapp1: document.getElementById('social-whatsapp1').value,
                        facebook1: document.getElementById('social-facebook1').value,
                        instagram1: document.getElementById('social-instagram1').value,
                    }
                };
            
                await setDoc(doc(db, "settings", "config"), settingsData, { merge: true });
                showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            } catch (error) {
                showToast('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: ' + error.message, 'error');
            } finally {
                setButtonLoading(btn, false, 'Ø­ÙØ¸ ÙƒÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
            }
        }
</script>