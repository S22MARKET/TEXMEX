<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEXMEX - ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„Ø¯ÙØ¹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="leaflet.css" />
    <script src="leaflet.js"></script>
    
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f1f5f9; }
        html { scroll-behavior: smooth; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #f97316; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .small-loader { border: 3px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 0.8s linear infinite; }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; translateY(0); } }
        
        #user-menu-dropdown.show { display: block; animation: slideInUp 0.2s ease-out; }
        
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 10001; }
        .toast { background-color: #2d3748; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-top: 10px; display: flex; align-items: center; gap: 10px; animation: slideInUp 0.3s ease, fadeOut 0.5s ease 2.5s forwards; }
        .toast.success { background-color: #2f855a; }
        .toast.error { background-color: #c53030; }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        
        #map {
            height: 300px;
            width: 100%;
            border-radius: 0.75rem;
            border: 2px solid #ddd;
            z-index: 10;
        }
        .leaflet-pane, .leaflet-tile, .leaflet-marker-icon, .leaflet-marker-shadow, .leaflet-tooltip {
            left: auto;
            right: 0;
        }
        .leaflet-right { right: auto; left: 10px; }
        .leaflet-left { left: auto; right: 10px; }

        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s; padding: 1rem; }
        .modal-content { background-color: white; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 500px; max-height: 95vh; display: flex; flex-direction: column; animation: slideInUp 0.4s; position: relative; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <header class="bg-white shadow-sm sticky top-0 z-30">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
             <a href="index.html" class="flex items-center gap-3">
                <img id="header-logo" src="https://i.ibb.co/6yV2L7p/texmex-logo.png" alt="TEXMEX Logo" class="h-10">
                <h1 class="text-xl sm:text-2xl md:text-3xl font-extrabold text-gray-800">
                    TEX<span class="text-orange-500">MEX</span>
                </h1>
            </a>
            
            <div id="header-actions" class="flex items-center gap-4 relative">
                <a href="index_cart.html" id="order-btn" class="relative text-lg font-semibold text-white bg-orange-500 hover:bg-orange-600 px-5 py-2.5 rounded-full transition-colors flex items-center gap-2 shadow-lg">
                    <i class="fas fa-shopping-basket"></i>
                    <span>Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø³Ù„Ø©</span>
                </a>
                <a href="login.html" id="login-btn" class="hidden relative text-lg font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 px-5 py-2.5 rounded-full transition-colors flex items-center gap-2">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„</span>
                </a>
                <div id="user-menu" class="hidden">
                    <button id="user-menu-button" class="flex items-center gap-2 text-lg font-semibold text-gray-700 bg-green-100 hover:bg-green-200 px-5 py-2.5 rounded-full transition-colors">
                        <i class="fas fa-user-check text-green-700"></i>
                        <span id="user-menu-name">...</span>
                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>
                    <div id="user-menu-dropdown" class="hidden absolute left-0 top-full mt-2 w-60 bg-white rounded-xl shadow-lg border z-50 overflow-hidden">
                        <div class="p-3 border-b">
                            <p class="text-sm text-gray-500">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ</p>
                            <p class="font-bold text-gray-800" id="user-menu-displayname">...</p>
                        </div>
                        <a href="profile.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"><i class="fas fa-user-circle fa-fw ml-2 text-gray-400"></i> Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</a>
                        <a href="order_history.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"><i class="fas fa-archive fa-fw ml-2 text-gray-400"></i> Ø£Ø±Ø´ÙŠÙ Ø·Ù„Ø¨Ø§ØªÙŠ</a>
                        <a href="loyalty_card.html" class="block px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"><i class="fas fa-star fa-fw ml-2 text-orange-400"></i> Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙˆÙØ§Ø¡</a>
                        <button id="logout-btn" class="w-full text-right px-4 py-3 text-red-600 hover:bg-red-50 border-t transition-colors"><i class="fas fa-sign-out-alt fa-fw ml-2"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div id="store-loader" class="text-center py-20">
        <div class="loader mx-auto"></div>
        <p class="mt-4 text-gray-600">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
    </div>

    <div id="main-content-wrapper" class="hidden max-w-6xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        
        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 text-center mb-8" style="animation: slideInUp 0.5s ease-out;">
            <i class="fas fa-map-marked-alt text-orange-400"></i>
            Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨
        </h1>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <form id="order-form" class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md space-y-5" style="animation: slideInUp 0.6s ease-out;">
                
                <div>
                    <h2 class="text-xl font-bold mb-3">1. Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</h2>
                    <div id="map"></div>
                    <button type="button" id="locate-me-btn" class="mt-3 w-full md:w-auto bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2">
                        <i class="fas fa-location-arrow"></i>
                        <span>ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</span>
                    </button>
                    <input type="hidden" id="customer-lat" name="customerLat">
                    <input type="hidden" id="customer-lng" name="customerLng">
                </div>
                
                <hr>

                <div>
                    <h2 class="text-xl font-bold mb-3">2. Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ</h2>
                    <div class="space-y-4">
                        <input type="text" id="customer-name" required placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" value="">
                        <input type="tel" id="customer-contact" required placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" dir="ltr" value="">
                        <input type="text" id="customer-address" required placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† / Ø§Ù„Ø­ÙŠ (Ù…Ø«Ø§Ù„: Ø­ÙŠ Ø§Ù„Ù†ØµØ±ØŒ Ø¹Ù…Ø§Ø±Ø© 5)" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                        <textarea id="customer-instructions" placeholder="ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„ØªÙˆØµÙŠÙ„ (Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ø¨Ù‚ØŒ Ù„ÙˆÙ† Ø§Ù„Ø¨Ø§Ø¨...)" rows="3" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500"></textarea>
                    </div>
                </div>

            </form>

            <div class="lg:col-span-1 h-fit lg:sticky top-28" style="animation: slideInUp 0.7s ease-out;">
                <div class="bg-white p-6 rounded-xl shadow-md space-y-4">
                    <h2 class="text-2xl font-bold border-b pb-3">Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h2>
                    <div id="summary-items-list" class="space-y-2 max-h-48 overflow-y-auto pr-2"></div>
                    <div id="total-price-summary" class="p-4 bg-gray-100 rounded-lg text-right font-bold text-lg space-y-2"></div>
                    <button id="submit-order-btn" class="w-full flex justify-center items-center gap-2 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-colors">
                        <span id="submit-btn-text">ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</span>
                        <div id="submit-btn-loader" class="small-loader hidden"></div>
                    </button>
                </div>
            </div>

        </div>
    </div>
    
    <div id="modal-container"></div>
    <div id="toast-container"></div>
    
<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, addDoc, query, orderBy, serverTimestamp, updateDoc, where, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAsG-85oNZq8kzWPHIDpsifkQ7rhua_oPk",
            authDomain: "texmexfoodannaba23.firebaseapp.com",
            projectId: "texmexfoodannaba23",
            storageBucket: "texmexfoodannaba23.appspot.com",
            messagingSenderId: "712480664933",
            appId: "1:712480664933:web:a5310190bf63115ac9058c",
            measurementId: "G-38D210X1EG"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let order = [];
        let restaurantSettings = {};
        let appliedCoupon = null;
        let currentUserProfile = null;
        let map = null;
        let marker = null;
        const ANNABA_COORDS = [36.9039, 7.7554];

        const elements = {
            loader: document.getElementById('store-loader'),
            mainContentWrapper: document.getElementById('main-content-wrapper'),
            summaryDiv: document.getElementById('total-price-summary'),
            summaryItemsList: document.getElementById('summary-items-list'),
            submitBtn: document.getElementById('submit-order-btn'),
            submitBtnText: document.getElementById('submit-btn-text'),
            submitBtnLoader: document.getElementById('submit-btn-loader'),
            orderForm: document.getElementById('order-form'),
            customerName: document.getElementById('customer-name'),
            customerContact: document.getElementById('customer-contact'),
            customerLat: document.getElementById('customer-lat'),
            customerLng: document.getElementById('customer-lng'),
            headerLogo: document.getElementById('header-logo'),
            loginBtn: document.getElementById('login-btn'),
            userMenu: document.getElementById('user-menu'),
            userMenuButton: document.getElementById('user-menu-button'),
            userMenuDropdown: document.getElementById('user-menu-dropdown'),
            userMenuName: document.getElementById('user-menu-name'),
            userMenuDisplayName: document.getElementById('user-menu-displayname'),
            logoutBtn: document.getElementById('logout-btn'),
            modalContainer: document.getElementById('modal-container')
        };

        const formatCurrency = (number) => {
            const num = number || 0;
            return num.toLocaleString('fr-DZ') + ' Ø¯.Ø¬';
        };

        const showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-times-circle';
            toast.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };

        const showDhikrCountdownModal = () => {
            return new Promise(resolve => {
                let seconds = 5;
                const modalHTML = `<div class="modal-backdrop"><div class="modal-content text-center p-8"><h2 class="text-2xl font-bold mb-3">Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ...</h2><p class="text-gray-600 mb-4">Ø¨ÙŠÙ†Ù…Ø§ ØªÙ†ØªØ¸Ø±ØŒ Ù„Ù†Ø¬Ø¹Ù„ Ù‡Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª Ù…Ø¨Ø§Ø±ÙƒÙ‹Ø§.</p><p class="text-3xl font-bold text-orange-600 my-4">Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø­Ù…Ø¯Ù‡</p><div id="countdown-timer" class="text-5xl font-bold text-gray-800">${seconds}</div></div></div>`;
                elements.modalContainer.innerHTML = modalHTML;
                const timerElement = document.getElementById('countdown-timer');
                const interval = setInterval(() => {
                    seconds--;
                    if(timerElement) timerElement.textContent = seconds;
                    if (seconds <= 0) { clearInterval(interval); resolve(); }
                }, 1000);
            });
        };
        
        const showInfoModal = (title, message) => {
            const modalHTML = `<div class="modal-backdrop" id="modal-backdrop"><div class="modal-content text-center !max-w-md"><div class="p-6"><i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i><h2 class="text-2xl font-bold mb-2">${title}</h2><p class="text-gray-600 leading-relaxed">${message}</p></div><div class="p-4 bg-gray-50 border-t"><button id="modal-close" class="w-full bg-orange-500 text-white font-bold py-2.5 px-6 rounded-lg hover:bg-orange-600 transition-colors">Ø­Ø³Ù†Ù‹Ø§</button></div></div></div>`;
            elements.modalContainer.innerHTML = modalHTML;
            const close = () => { 
                elements.modalContainer.innerHTML = '';
                window.location.href = 'order_history.html'; // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
            };
            document.getElementById('modal-close').onclick = close;
            document.getElementById('modal-backdrop').onclick = (e) => e.target.id === 'modal-backdrop' && close();
        };

        function renderSummary() {
            const subTotal = order.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const deliveryFee = restaurantSettings.delivery_config?.fallbackFee || 0;
            let finalDeliveryFee = deliveryFee;
            let deliveryMessage = `<span>${formatCurrency(deliveryFee)}</span>`;
            if (restaurantSettings.isFreeDeliveryActive && subTotal >= restaurantSettings.freeDeliveryThreshold) {
                finalDeliveryFee = 0;
                deliveryMessage = `<span class="text-green-600 font-bold">Ù…Ø¬Ø§Ù†ÙŠ! ğŸ‰</span>`;
            }
            let discountAmount = 0;
            let discountHtml = '';
            if (appliedCoupon) {
                let subTotalForCoupon = subTotal;
                if (appliedCoupon.appliesTo === 'specific_products') {
                    subTotalForCoupon = order.filter(item => appliedCoupon.productIds.includes(item.id)).reduce((sum, item) => sum + item.price * item.quantity, 0);
                }
                if(appliedCoupon.discountType === 'percentage') { discountAmount = subTotalForCoupon * (appliedCoupon.discountValue / 100); }
                else { discountAmount = appliedCoupon.discountValue; }
                discountAmount = Math.min(subTotalForCoupon, discountAmount);
                discountHtml = `<div class="flex justify-between text-green-600 border-t pt-2 mt-2"><span>Ø®ØµÙ… (${appliedCoupon.code}):</span><span>-${formatCurrency(discountAmount)}</span></div>`;
            }
            const grandTotal = subTotal + finalDeliveryFee - discountAmount;
            elements.summaryDiv.innerHTML = `
                <div class="flex justify-between"><span>Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:</span><span>${formatCurrency(subTotal)}</span></div>
                <div class="flex justify-between"><span>Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„:</span>${deliveryMessage}</div>
                ${discountHtml}
                <hr class="my-1 border-gray-300">
                <div class="flex justify-between text-2xl mt-2">
                    <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
                    <span>${formatCurrency(grandTotal)}</span>
                </div>`;
            elements.summaryItemsList.innerHTML = order.map(item => `
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">${item.quantity} x ${item.name.ar}</span>
                    <span class="font-mono font-semibold">${formatCurrency(item.price * item.quantity)}</span>
                </div>
            `).join('');
        }

        // --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ø¬Ø³Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ ---
        
        window.receiveLocationFromApp = (lat, lng) => {
            if (lat && lng && map) {
                const newLatLng = L.latLng(lat, lng);
                marker.setLatLng(newLatLng);
                map.panTo(newLatLng);
                updateCoordinates(lat, lng);
                marker.getPopup().setContent('<b>Ù…ÙˆÙ‚Ø¹Ùƒ!</b>').openOn(map);
                showToast("ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­!", "success");
            }
        };

        function attemptToLocate() {
            if (window.AndroidBridge && typeof window.AndroidBridge.requestLocation === 'function') {
                window.AndroidBridge.requestLocation();
                showToast("Ø¬Ø§Ø±ÙŠ Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...", "success");
            } else {
                showToast("Ø¬Ø§Ø±ÙŠ Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­...", "success");
                map.locate({ setView: true, maxZoom: 16 });
            }
        }
        
        function initializeMap() {
            try { 
                map = L.map('map').setView(ANNABA_COORDS, 14);
                
                // (Ø§Ù„Ø­Ù„ 3): Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø±Ø§Ø¦Ø· Esri Ø§Ù„Ø­Ø¯ÙŠØ«Ø© (Ø¨Ø¯ÙŠÙ„ OpenStreetMap)
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles Â© Esri'
                }).addTo(map);

                marker = L.marker(ANNABA_COORDS, {
                    draggable: true,
                    autoPan: true
                }).addTo(map)
                  .bindPopup('<b>Ù…ÙˆÙ‚Ø¹Ùƒ Ù‡Ù†Ø§</b><br>Ø§Ø³Ø­Ø¨Ù†ÙŠ Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¨Ø¯Ù‚Ø©.').openPopup();
                
                updateCoordinates(ANNABA_COORDS[0], ANNABA_COORDS[1]);

                marker.on('dragend', function(e) {
                    const latLng = e.target.getLatLng();
                    updateCoordinates(latLng.lat, latLng.lng);
                    map.panTo(latLng);
                });

                document.getElementById('locate-me-btn').addEventListener('click', attemptToLocate);

                map.on('locationfound', (e) => {
                    marker.setLatLng(e.latlng);
                    updateCoordinates(e.latlng.lat, e.latlng.lng);
                    marker.getPopup().setContent('<b>Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ!</b>').openOn(map);
                });

                map.on('locationerror', () => {
                    showToast("ÙØ´Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹. Ø¥Ø°Ø§ ÙƒÙ†Øª Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù†Ø­ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚. Ø¥Ø°Ø§ ÙƒÙ†Øª ÙÙŠ Ù…ØªØµÙØ­ØŒ Ø­Ø§ÙˆÙ„ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¯Ø¨ÙˆØ³ ÙŠØ¯ÙˆÙŠÙ‹Ø§.", "error");
                });

            } catch (e) { 
                console.error("Map Initialization Error:", e);
                const mapDiv = document.getElementById('map');
                if (mapDiv) {
                    mapDiv.innerHTML = `
                        <div class="p-4 bg-red-100 text-red-700 rounded-lg text-right h-full">
                            <p class="font-bold">Ø®Ø·Ø£ ÙØ§Ø¯Ø­ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©:</p>
                            <p class="font-mono" dir="ltr" style="line-break: anywhere;">${e.message}</p>
                            <p class="mt-2">Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø·Ø£ Ù‡Ùˆ 'L is not defined'ØŒ ÙÙ‡Ø°Ø§ ÙŠØ¹Ù†ÙŠ Ø£Ù† Ù…Ù„ÙØ§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø© (Leaflet) ÙØ´Ù„Øª ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„.</p>
                            <p class="mt-2">ØªØ£ÙƒØ¯ Ù…Ù† Ø±ÙØ¹ Ù…Ù„ÙÙŠ 'leaflet.css' Ùˆ 'leaflet.js' Ø¥Ù„Ù‰ GitHub Ù…Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù.</p>
                        </div>
                    `;
                }
            }
        }

        function updateCoordinates(lat, lng) {
            elements.customerLat.value = lat;
            elements.customerLng.value = lng;
        }

        const handleOrderSubmit = async (e) => {
            e.preventDefault();
            if (!elements.orderForm.checkValidity()) { 
                showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†).", "error"); 
                return; 
            }
            if (!elements.customerLat.value || !elements.customerLng.value) {
                showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£ÙˆÙ„Ø§Ù‹.", "error");
                return;
            }
            const subTotal = order.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const deliveryFee = restaurantSettings.delivery_config?.fallbackFee || 0;
            let finalDeliveryFee = deliveryFee;
            if (restaurantSettings.isFreeDeliveryActive && subTotal >= restaurantSettings.freeDeliveryThreshold) { finalDeliveryFee = 0; }
            let discountAmount = 0;
            if (appliedCoupon) {
                let subTotalForCoupon = subTotal;
                if (appliedCoupon.appliesTo === 'specific_products') {
                    subTotalForCoupon = order.filter(item => appliedCoupon.productIds.includes(item.id)).reduce((sum, item) => sum + item.price * item.quantity, 0);
                }
                if(appliedCoupon.discountType === 'percentage') { discountAmount = subTotalForCoupon * (appliedCoupon.discountValue / 100); }
                else { discountAmount = appliedCoupon.discountValue; }
                discountAmount = Math.min(subTotalForCoupon, discountAmount);
            }
            const finalTotalPrice = subTotal + finalDeliveryFee - discountAmount;
            
            // (Ø§Ù„Ø­Ù„ 4): Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø®Ø±Ø§Ø¦Ø· Ø¬ÙˆØ¬Ù„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ
            const orderData = {
                customerName: elements.customerName.value.trim(),
                customerContact: elements.customerContact.value.trim(),
                customerAddress: document.getElementById('customer-address').value.trim(), 
                customerLocation: `https://maps.google.com/?q=${elements.customerLat.value},${elements.customerLng.value}`, // <-- âœ… Ø§Ù„Ø­Ù„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ
                customerInstructions: document.getElementById('customer-instructions').value.trim(),
                deliveryFee: finalDeliveryFee,
                totalPrice: finalTotalPrice,
                items: order.map(item => ({ name: item.name.ar, quantity: item.quantity, price: item.price, id: item.id, selectedAddons: item.selectedAddons || [], cookingInstructions: item.cookingInstructions || '' })),
                status: 'new',
                createdAt: serverTimestamp(),
                couponCode: appliedCoupon ? appliedCoupon.code : null,
                discountAmount: discountAmount,
                userId: auth.currentUser ? auth.currentUser.uid : null 
            };
            
            elements.submitBtn.disabled = true;
            elements.submitBtnText.classList.add('hidden');
            elements.submitBtnLoader.classList.remove('hidden');
            
            await showDhikrCountdownModal();
            
            try {
                const docRef = await addDoc(collection(db, "orders"), orderData);
                
                // (Ø§Ù„Ø­Ù„ 5): Ù„Ø§ Ù†Ø¶Ù Ù†Ù‚Ø§Ø· Ø§Ù„ÙˆÙØ§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                
                order = [];
                appliedCoupon = null;
                localStorage.removeItem('texmex_order');
                sessionStorage.removeItem('texmex_coupon');
                showInfoModal('ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!', 'Ø´ÙƒØ±Ù‹Ø§ Ù„Ø·Ù„Ø¨Ùƒ Ù…Ù† TEXMEX. Ø³Ù†ØªØµÙ„ Ø¨Ùƒ Ù‚Ø±ÙŠØ¨Ù‹Ø§ Ù„Ù„ØªØ£ÙƒÙŠØ¯.');
            } catch (error) {
                console.error("Error submitting order: ", error);
                elements.modalContainer.innerHTML = ''; 
                showInfoModal('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£Ùˆ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©.');
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                elements.loginBtn.classList.add('hidden');
                elements.userMenu.classList.remove('hidden');
                const displayName = user.displayName || "Ø²Ø¨ÙˆÙ†Ù†Ø§";
                elements.userMenuName.textContent = displayName.split(' ')[0];
                elements.userMenuDisplayName.textContent = displayName;
                initializeLocationPage(); 
            } else {
                window.location.href = 'login.html';
            }
        });

        elements.userMenuButton.addEventListener('click', (e) => {
            e.stopPropagation();
            elements.userMenuDropdown.classList.toggle('show');
        });
        document.addEventListener('click', () => {
            if (elements.userMenuDropdown.classList.contains('show')) {
                elements.userMenuDropdown.classList.remove('show');
            }
        });
        elements.logoutBtn.addEventListener('click', () => {
            signOut(auth).catch((error) => console.error('Logout Error', error));
        });

        async function initializeLocationPage() {
            try {
                order = JSON.parse(localStorage.getItem('texmex_order')) || [];
                appliedCoupon = JSON.parse(sessionStorage.getItem('texmex_coupon')) || null;
                if (order.length === 0) {
                    window.location.href = 'index_cart.html';
                    return;
                }
                const [settingsSnap, deliveryConfigSnap, userDocSnap] = await Promise.all([
                    getDoc(doc(db, "settings", "config")),
                    getDoc(doc(db, "settings", "delivery_config")), 
                    getDoc(doc(db, "users", auth.currentUser.uid))
                ]);
                restaurantSettings = settingsSnap.exists() ? settingsSnap.data() : {};
                restaurantSettings.delivery_config = deliveryConfigSnap.exists() ? deliveryConfigSnap.data() : {}; 
                if (userDocSnap.exists()) {
                    currentUserProfile = userDocSnap.data();
                }
                elements.customerName.value = currentUserProfile?.displayName || auth.currentUser?.displayName || '';
                elements.customerContact.value = currentUserProfile?.phone || '';
                if (restaurantSettings.logoUrl) {
                    elements.headerLogo.src = restaurantSettings.logoUrl;
                }
                elements.loader.classList.add('hidden');
                elements.mainContentWrapper.classList.remove('hidden');
                renderSummary();
                
                initializeMap(); 
                
                elements.orderForm.addEventListener('submit', handleOrderSubmit);
                elements.submitBtn.onclick = () => elements.orderForm.requestSubmit();
            } catch (error) {
                console.error("Initialization failed:", error);
                elements.loader.innerHTML = `<p class="text-red-500">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙØ­Ø©. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.</p>`;
            }
        }
    </script>
</body>
</html>