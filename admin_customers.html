<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEXMEX - Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¬Ù„ÙˆÙ†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.23/dist/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f0f2f5; }
        .hidden { display: none; }
        .dashboard-tab.active-tab { background-color: #ea580c; color: white; }
        .dashboard-panel { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 40; display: flex; align-items: center; justify-content: center; }
        /* (Ø¬Ø¯ÙŠØ¯) Ø²ÙŠØ§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù„Ø§Ø³ØªÙŠØ¹Ø§Ø¨ Ø§Ù„Ø³Ø¬Ù„ */
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 800px; z-index: 50; max-height: 90vh; overflow-y: auto; }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 100; }
        .toast { background-color: #2d3748; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-top: 10px; display: flex; align-items: center; gap: 10px; animation: slideInUp 0.3s ease, fadeOut 0.5s ease 2.5s forwards; }
        .toast.success { background-color: #2f855a; }
        .toast.error { background-color: #c53030; }
        @keyframes slideInUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #48bb78; }
        input:checked + .slider:before { transform: translateX(24px); }
        .spinner { width: 24px; height: 24px; border: 4px solid rgba(255, 255, 255, 0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; }
        .spinner-dark { width: 24px; height: 24px; border: 4px solid rgba(0,0,0, 0.1); border-top-color: #333; border-radius: 50%; animation: spin 1s linear infinite; }
        .fa-spinner { animation: spin 1s linear infinite; } 
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 768px) { .responsive-table thead { display: none; } .responsive-table tr { display: block; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; } .responsive-table td { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6; } .responsive-table td:last-child { border-bottom: none; } .responsive-table td::before { content: attr(data-label); font-weight: 600; margin-left: 0.5rem; } }
        
        /* (Ø¬Ø¯ÙŠØ¯) Ø³ØªØ§ÙŠÙ„ Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡ */
        .reversal-btn {
            background: none; border: none; color: #9ca3af; cursor: pointer; transition: color 0.2s;
        }
        .reversal-btn:hover { color: #ef4444; }
        .reversal-btn[disabled] { color: #d1d5db; cursor: not-allowed; }
        .reversal-btn i { font-size: 1.1rem; }
    </style>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
</head>
<body>

    <div id="auth-loader" class="flex flex-col items-center justify-center min-h-screen bg-gray-100">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-4">TEX<span class="text-orange-500">MEX</span></h1>
        <div class="spinner-dark"></div>
        <p class="mt-4 text-gray-600">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ©...</p>
    </div>

    <div id="dashboard-page" class="hidden">
        <div class="relative min-h-screen md:flex">

            <aside id="sidebar" class="bg-gray-800 text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 right-0 transform translate-x-full md:relative md:translate-x-0 transition duration-300 ease-in-out z-30">
                <div class="p-3 text-center border-b border-gray-700">
                    <h2 class="text-2xl font-bold">TEX<span class="text-orange-400">MEX</span></h2>
                </div>
                 <nav class="flex-1 p-2 space-y-2">
                    <a href="admin_dashboard.html" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-tachometer-alt fa-fw ml-3"></i> Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
                    <a href="admin_orders.html" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-clipboard-list fa-fw ml-3"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</a>
                    <a href="admin_customer_log.html" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-users fa-fw ml-3"></i> Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ø¨Ø§Ù„Ø·Ù„Ø¨Ø§Øª)</a>
                    <a href="admin_customers.html" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-id-card fa-fw ml-3"></i> Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¬Ù„ÙˆÙ†</a>
                    <a href="admin_menu_items.html" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-utensils fa-fw ml-3"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø¹Ø§Ù…</a>
                    <a href="admin_offers.html" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-star fa-fw ml-3"></i> Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙˆØ§Ù„Ø¨Ø§Ù‚Ø§Øª</a>
                    <a href="admin_coupons.html" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-tags fa-fw ml-3"></i> Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª</a>
                    <a href="admin_categories.html" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-sitemap fa-fw ml-3"></i> Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</a>
                    <a href="admin_delivery_personnel.html" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-biking fa-fw ml-3"></i> Ø¹Ù…Ø§Ù„ Ø§Ù„ØªÙˆØµÙŠÙ„</a>
                    <a href="admin_stats.html" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-chart-line fa-fw ml-3"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</a>
                    <a href="admin_loyalty_settings.html" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-gift fa-fw ml-3"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆÙØ§Ø¡</a>
                    <a href="admin_delivery.html" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-motorcycle fa-fw ml-3"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„</a>
                    <a href="admin_settings.html" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-cogs fa-fw ml-3"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ø¹Ù…</a>
                </nav>
                <div class="p-4 border-t border-gray-700">
                    <button id="logout-btn" class="w-full flex items-center justify-center px-4 py-3 rounded-md bg-red-600 hover:bg-red-700">
                        <i class="fas fa-sign-out-alt fa-fw ml-3"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                    </button>
                </div>
            </aside>
            <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden hidden"></div>
            
            <div class="flex-1 flex flex-col">
                <header class="bg-white shadow-md p-4 flex justify-between items-center">
                    <h1 class="text-xl font-bold">TEX<span class="text-orange-500">MEX</span> Dashboard</h1>
                    <button id="mobile-menu-btn" class="text-gray-800 p-2 rounded-lg md:hidden"><i class="fas fa-bars fa-lg"></i></button>
                </header>
                
                <main class="flex-1 p-4 md:p-8 overflow-y-auto">
                    
                    <div id="customers-panel" class="dashboard-panel">
                        <div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-6">
                            <h1 class="text-3xl font-bold text-gray-800">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¬Ù„ÙˆÙ† (Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª)</h1>
                            <div class="relative">
                                <i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <input type="text" id="registered-customer-search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ..." class="w-full md:w-80 pr-10 pl-3 py-2 border rounded-lg">
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mb-4 bg-green-50 p-3 rounded-lg"><i class="fas fa-info-circle ml-2"></i>Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ ÙŠØ¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø°ÙŠÙ† Ù‚Ø§Ù…ÙˆØ§ Ø¨Ù€ <strong class="text-green-700">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</strong> ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Ù…Ù† Ù…Ø¬Ù…ÙˆØ¹Ø© 'users').</p>
                        <div class="overflow-x-auto bg-white rounded-xl shadow-md">
                            <table class="w-full text-right responsive-table">
                                <thead class="bg-gray-100"><tr>
                                    <th class="p-3">Ø§Ù„Ø§Ø³Ù…</th>
                                    <th class="p-3">Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th>
                                    <th class="p-3">Ø§Ù„Ù‡Ø§ØªÙ</th>
                                    <th class="p-3">Ø§Ù„Ù†Ù‚Ø§Ø·</th>
                                    <th class="p-3">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                                    <th class="p-3">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr></thead>
                                <tbody id="registered-customers-table-body">
                                    <tr><td colspan="6" class="p-8 text-center"><div class="spinner-dark mx-auto"></div><p class="mt-2">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡...</p></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </main>
                </div>
        </div>
    </div>

    <div id="modal-container"></div>
    <div id="toast-container"></div>

<script type="module">
    // --- (Ø¬Ø¯ÙŠØ¯) Ø¥Ø¶Ø§ÙØ© 'increment' ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, serverTimestamp, orderBy, getDoc, setDoc, getDocs, where, Timestamp, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyAsG-85oNZq8kzWPHIDpsifkQ7rhua_oPk",
        authDomain: "texmexfoodannaba23.firebaseapp.com",
        projectId: "texmexfoodannaba23",
        storageBucket: "texmexfoodannaba23.appspot.com",
        messagingSenderId: "712480664933",
        appId: "1:712480664933:web:a5310190bf63115ac9058c",
        measurementId: "G-38D210X1EG"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // --- AUTHENTICATION GATE (Ù…Ø´ØªØ±Ùƒ) ---
    const authLoader = document.getElementById('auth-loader');
    const dashboardPage = document.getElementById('dashboard-page');

    onAuthStateChanged(auth, (user) => {
        if (user) {
            authLoader.classList.add('hidden');
            dashboardPage.classList.remove('hidden');
            initializeDashboard(); 
        } else {
            window.location.href = 'logindashborded.html'; 
        }
    });

    // --- GLOBAL CACHES & STATE (Ù…Ø´ØªØ±Ùƒ) ---
    let ordersCache = [];
    let registeredUsersCache = [];

    // --- UI & UX HELPERS (Ù…Ø´ØªØ±ÙƒØ©) ---
    
    const formatCurrency = (number) => {
        const num = Math.round(number) || 0;
        return `${num} Ø¯.Ø¬`;
    };

    const showModal = (title, content, onConfirm, confirmText = 'Ø­ÙØ¸', showCancel = true) => {
        const modalContainer = document.getElementById('modal-container');
        const confirmButtonHtml = onConfirm ? `<button id="modal-confirm" class="bg-orange-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-orange-700 flex items-center gap-2">${confirmText}</button>` : '';
        const cancelButtonHtml = showCancel ? `<button id="modal-cancel" class="bg-gray-200 px-6 py-2 rounded-lg font-semibold hover:bg-gray-300">Ø¥Ù„ØºØ§Ø¡</button>` : '';
        modalContainer.innerHTML = `<div class="modal-backdrop" id="modal-backdrop"><div class="modal-content"><div class="flex justify-between items-center mb-4 border-b pb-3"><h3 class="text-xl font-bold">${title}</h3><button id="modal-close-btn" class="text-2xl">&times;</button></div><div id="modal-body">${content}</div><div class="flex justify-end gap-4 mt-6 border-t pt-4">${cancelButtonHtml}${confirmButtonHtml}</div></div></div>`;
        const close = () => { modalContainer.innerHTML = ''; }
        if (showCancel) document.getElementById('modal-cancel').onclick = close;
        document.getElementById('modal-close-btn').onclick = close;
        document.getElementById('modal-backdrop').onclick = e => { if (e.target.id === 'modal-backdrop') close(); };
        if (onConfirm) document.getElementById('modal-confirm').onclick = onConfirm;
    };

    const closeModal = () => {
        document.getElementById('modal-container').innerHTML = '';
    }

    const showDeletionConfirmModal = (onConfirmCallback) => {
        const content = `<p class="mb-4 text-lg">Ù„ØªØ£ÙƒÙŠØ¯ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°ÙØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„ØªØ§Ù„ÙŠ:</p><div class="text-center mb-4"><code class="text-2xl font-bold bg-gray-100 p-2 rounded-lg text-orange-600 select-all">S22MARKET</code></div><input type="text" id="deletion-code-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù‡Ù†Ø§ Ù„Ù„ØªØ£ÙƒÙŠØ¯" class="w-full p-3 border rounded-lg text-center tracking-widest uppercase focus:ring-2 focus:ring-orange-400 focus:border-orange-400"><p id="deletion-error-msg" class="text-red-600 text-sm mt-2 text-center hidden">Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø°ÙŠ Ø£Ø¯Ø®Ù„ØªÙ‡ ØºÙŠØ± ØµØ­ÙŠØ­.</p>`;
        showModal('ØªØ£ÙƒÙŠØ¯ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°Ù', content, () => {
            const codeInput = document.getElementById('deletion-code-input');
            const errorMsg = document.getElementById('deletion-error-msg');
            if (codeInput.value.trim().toUpperCase() === 'S22MARKET') { onConfirmCallback(); closeModal(); } 
            else { errorMsg.classList.remove('hidden'); codeInput.classList.add('border-red-500'); }
        }, 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù', true);
    };

    // --- (Ø¬Ø¯ÙŠØ¯) Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„ (ØªÙØ³ØªØ®Ø¯Ù… Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„) ---
    async function fetchLoyaltyHistory(userId) {
        const historyQuery = query(
            collection(db, 'users', userId, 'loyaltyChanges'),
            orderBy('timestamp', 'desc')
        );
        const snapshot = await getDocs(historyQuery);
        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    // --- (Ø¬Ø¯ÙŠØ¯) Ø¯Ø§Ù„Ø© Ø±Ø³Ù… Ø§Ù„Ø³Ø¬Ù„ (ØªÙØ³ØªØ®Ø¯Ù… Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„) ---
    function renderLoyaltyHistory(history, userId, currentPoints) {
        const historyContainer = document.getElementById('loyalty-history-list');
        if (!historyContainer) return '';

        if (history.length === 0) {
            historyContainer.innerHTML = '<p class="text-center text-gray-500 text-sm">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø³Ø§Ø¨Ù‚ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.</p>';
            return;
        }

        historyContainer.innerHTML = history.map(change => {
            const date = change.timestamp?.toDate ? change.timestamp.toDate().toLocaleDateString('ar-EG', { day: 'numeric', month: 'short' }) : '...';
            
            let pointsChange, reason, color, title;

            if (change.type === 'admin_manual_edit') {
                pointsChange = change.pointsAfter - change.pointsBefore;
                reason = change.reason || (pointsChange > 0 ? 'Ø¥Ø¶Ø§ÙØ© Ø¥Ø¯Ø§Ø±ÙŠØ©' : 'Ø®ØµÙ… Ø¥Ø¯Ø§Ø±ÙŠ');
                title = `(${reason})`;
            } else if (change.type === 'order_reward') {
                pointsChange = change.pointsAdded;
                reason = `Ù…ÙƒØ§ÙØ£Ø© Ø·Ù„Ø¨ (${change.orderId.substring(0, 5)}...)`;
                title = `(${reason})`;
            } else if (change.type === 'reversal') {
                // (Ø¬Ø¯ÙŠØ¯) Ù†ÙˆØ¹ Ø§Ù„Ø¥Ù„ØºØ§Ø¡
                pointsChange = change.pointsChange; // (Ø³ÙŠÙƒÙˆÙ† Ø±Ù‚Ù… Ø³Ø§Ù„Ø¨)
                reason = change.reason; // (Ù…Ø«Ø§Ù„: "Ø¥Ù„ØºØ§Ø¡ Ø­Ø±ÙƒØ©: +10")
                title = `ğŸ”„ ${reason}`;
            } else {
                pointsChange = 0;
                reason = 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                title = '(ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ)';
            }

            color = pointsChange > 0 ? 'text-green-600' : 'text-red-600';
            
            // (Ø¬Ø¯ÙŠØ¯) Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡
            // (Ø¬Ø¯ÙŠØ¯) ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­Ø±ÙƒØ© Ù…Ù„ØºØ§Ø© (reversed) Ø£Ùˆ Ù‡ÙŠ Ù†ÙØ³Ù‡Ø§ Ø­Ø±ÙƒØ© Ø¥Ù„ØºØ§Ø¡
            const isDisabled = change.reversed === true || change.type === 'reversal';
            const reversalButton = `
                <button class="reversal-btn" 
                        data-log-id="${change.id}" 
                        data-user-id="${userId}"
                        data-points-change="${pointsChange}"
                        data-reason="${reason}"
                        data-current-points="${currentPoints}"
                        title="${isDisabled ? 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø±ÙƒØ©' : 'Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø±ÙƒØ©'}" 
                        ${isDisabled ? 'disabled' : ''}>
                    <i class="fas ${isDisabled ? 'fa-check' : 'fa-undo-alt'}"></i>
                </button>
            `;

            return `<div class="flex justify-between items-center text-sm border-b pb-1 mb-1">
                        ${reversalButton} <div class="flex-grow mr-2">
                            <p class="font-semibold">${title}</p>
                            <p class="text-xs text-gray-500">${date}</p>
                        </div>
                        <span class="font-bold ${color}">${pointsChange > 0 ? '+' : ''}${pointsChange}</span>
                    </div>`;
        }).join('');
    }

    // --- (Ø¬Ø¯ÙŠØ¯) Ø¯Ø§Ù„Ø© ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ù„ØºØ§Ø¡ ---
    async function handleReversal(btn) {
        const { logId, userId, pointsChange, reason, currentPoints } = btn.dataset;
        const pointsToReverse = parseFloat(pointsChange); // (Ù…Ø«Ø§Ù„: +10 Ø£Ùˆ -5)
        
        // (Ø¬Ø¯ÙŠØ¯) ØªØ£ÙƒÙŠØ¯ Ø¥Ø¶Ø§ÙÙŠ Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ù„ØºØ§Ø¡
        const confirmContent = `<p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø±ÙƒØ©ØŸ</p>
                                <p class="font-bold mt-2">${reason}: <span class="${pointsToReverse > 0 ? 'text-green-600' : 'text-red-600'}">${pointsToReverse} Ù†Ù‚Ø·Ø©</span></p>
                                <p class="text-red-600 mt-2">Ø³ÙŠØªÙ… Ø¹ÙƒØ³ Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ…Ø© (Ø®ØµÙ… ${pointsToReverse} Ù†Ù‚Ø§Ø·) Ù…Ù† Ø±ØµÙŠØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ.</p>`;
        showModal('ØªØ£ÙƒÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø±ÙƒØ©', confirmContent, async () => {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const newPoints = parseFloat(currentPoints) - pointsToReverse; // (Ø¬Ø¯ÙŠØ¯) Ø¹ÙƒØ³ Ø§Ù„Ù‚ÙŠÙ…Ø©
                const reversalReason = `(Ø¥Ù„ØºØ§Ø¡) ${reason}`;
                
                const userDocRef = doc(db, "users", userId);
                const logDocRef = doc(db, "users", userId, "loyaltyChanges", logId);
                const newLogRef = collection(db, "users", userId, "loyaltyChanges");

                // 1. ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„
                await updateDoc(userDocRef, { loyaltyPoints: newPoints });

                // 2. ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙƒÙ€ "Ù…Ù„ØºØ§Ø©" (reversed)
                await updateDoc(logDocRef, { reversed: true });

                // 3. Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ù„ØºØ§Ø¡
                await addDoc(newLogRef, {
                    type: 'reversal',
                    reason: reversalReason,
                    pointsChange: -pointsToReverse, // (Ø¬Ø¯ÙŠØ¯) Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¹ÙƒÙˆØ³Ø©
                    reversedLogId: logId, // (Ø¬Ø¯ÙŠØ¯) Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…
                    adminId: auth.currentUser.uid,
                    timestamp: serverTimestamp()
                });

                showToast('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                
                // (Ø¬Ø¯ÙŠØ¯) ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹
                document.getElementById('loyalty-points-input').value = newPoints; // ØªØ­Ø¯ÙŠØ« Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
                document.getElementById('current-points-display').textContent = newPoints; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
                btn.closest('.reversal-btn').disabled = true;
                btn.closest('.reversal-btn').innerHTML = '<i class="fas fa-check"></i>';
                
                // (Ø¬Ø¯ÙŠØ¯) Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
                const updatedHistory = await fetchLoyaltyHistory(userId);
                renderLoyaltyHistory(updatedHistory, userId, newPoints);
                
                // (Ø¬Ø¯ÙŠØ¯) ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
                const pointsSpan = document.getElementById(`points-user-${userId}`);
                if(pointsSpan) pointsSpan.textContent = newPoints;
                
                closeModal(); // Ø¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ£ÙƒÙŠØ¯

            } catch (error) {
                console.error("Error reversing transaction:", error);
                showToast('ÙØ´Ù„ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø±ÙƒØ©: ' + error.message, 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-undo-alt"></i>';
            }
        }, 'Ù†Ø¹Ù…ØŒ Ù‚Ù… Ø¨Ø§Ù„Ø¥Ù„ØºØ§Ø¡', true);
    }


    // --- (Ù…Ø¹Ø¯Ù„) Ø¯Ø§Ù„Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ù‚Ø§Ø· (Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø³Ø¬Ù„) ---
    const showEditLoyaltyModal = async (userId, currentPoints, btnElement = null) => {
        
        if (btnElement) {
            btnElement.disabled = true;
            btnElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        }

        let historyData = [];
        try {
            historyData = await fetchLoyaltyHistory(userId);
        } catch (err) {
            console.error("Error fetching history:", err);
            // Ø³Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø·Ø£ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
        }

        if (btnElement) {
            btnElement.disabled = false;
            btnElement.innerHTML = '<i class="fas fa-edit"></i>';
        }

        const content = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <div class="space-y-4">
                    <p>ØªØ¹Ø¯ÙŠÙ„ Ù†Ù‚Ø§Ø· Ø§Ù„ÙˆÙØ§Ø¡. Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <strong id="current-points-display">${currentPoints}</strong></p>
                    <div>
                        <label for="loyalty-points-input" class="font-semibold text-gray-700">Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:</label>
                        <input type="number" id="loyalty-points-input" class="w-full p-3 border rounded-lg text-center text-xl" value="${currentPoints}">
                    </div>
                    
                    <div>
                        <label for="loyalty-edit-reason" class="font-semibold text-gray-700">Ø³Ø¨Ø¨ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ø³ÙŠØ¸Ù‡Ø± Ù„Ù„Ø¹Ù…ÙŠÙ„):</label>
                        <input type="text" id="loyalty-edit-reason" placeholder="Ù…Ø«Ø§Ù„: Ù‡Ø¯ÙŠØ©ØŒ ØªØ¹ÙˆÙŠØ¶ Ø¹Ù† Ø·Ù„Ø¨ØŒ Ø®ØµÙ… Ù†Ù‚Ø§Ø·..." class="w-full p-3 border rounded-lg">
                    </div>
                    <div class="flex items-center gap-3 pt-2">
                        <input type="checkbox" id="loyalty-notify-customer" class="h-5 w-5 text-orange-600 border-gray-300 rounded focus:ring-orange-500" checked>
                        <label for="loyalty-notify-customer" class="font-semibold text-gray-700">Ø¥Ø¨Ù„Ø§Øº Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù‡Ø°Ø§ Ø§Ù„ØªØºÙŠÙŠØ±ØŸ</label>
                    </div>
                    
                    <hr class="my-4">
                    <p class="mb-2 text-lg">Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„ØªØ§Ù„ÙŠ:</p>
                    <div class="text-center"><code class="text-2xl font-bold bg-gray-100 p-2 rounded-lg text-orange-600 select-all">S22MARKET</code></div>
                    <input type="text" id="confirmation-code-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù‡Ù†Ø§ Ù„Ù„ØªØ£ÙƒÙŠØ¯" class="w-full p-3 border rounded-lg text-center tracking-widest uppercase">
                    <p id="confirmation-error-msg" class="text-red-600 text-sm mt-2 text-center hidden">Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­.</p>
                </div>

                <div class="space-y-2">
                    <label class="font-bold text-gray-800">ğŸ“œ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„Ù„Ø¹Ù…ÙŠÙ„ (Ù…Ø¹ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¥Ù„ØºØ§Ø¡ ğŸ”„):</label>
                    <div id="loyalty-history-list" class="max-h-96 overflow-y-auto bg-gray-50 p-3 rounded-lg border">
                        <div class="text-center"><div class="spinner-dark mx-auto"></div></div>
                    </div>
                </div>

            </div>
        `;
        
        showModal('ØªØ¹Ø¯ÙŠÙ„ Ù†Ù‚Ø§Ø· Ø§Ù„ÙˆÙØ§Ø¡', content, async () => {
            const newPointsInput = document.getElementById('loyalty-points-input');
            const newPoints = parseInt(newPointsInput.value, 10);
            const codeInput = document.getElementById('confirmation-code-input');
            const errorMsg = document.getElementById('confirmation-error-msg');
            
            const reasonInput = document.getElementById('loyalty-edit-reason');
            const reason = reasonInput.value.trim(); 
            const notifyCheckbox = document.getElementById('loyalty-notify-customer');
            const shouldNotify = notifyCheckbox.checked;

            if (codeInput.value.trim().toUpperCase() === 'S22MARKET') {
                if (isNaN(newPoints) || newPoints < 0) {
                    showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­ Ù„Ù„Ù†Ù‚Ø§Ø·.', 'error');
                    return; 
                }
                
                const confirmBtn = document.getElementById('modal-confirm');
                setButtonLoading(confirmBtn, true);

                try {
                    // (Ø¬Ø¯ÙŠØ¯) Ø¬Ù„Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ *Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ* Ù…Ù† Ø§Ù„ÙƒØ§Ø´ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¯Ù‚Ø©
                    const user = registeredUsersCache.find(u => u.id === userId);
                    const oldPoints = user ? user.loyaltyPoints : parseInt(currentPoints);

                    // (Ø¬Ø¯ÙŠØ¯) Ù„Ø§ ØªÙ‚Ù… Ø¨Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªØºÙŠØ± Ø§Ù„Ø±ØµÙŠØ¯ ÙˆÙ„Ù… ÙŠÙÙƒØªØ¨ Ø³Ø¨Ø¨
                    if (oldPoints === newPoints && !reason) {
                        showToast('Ù„Ù… ÙŠØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆÙ„Ù… ÙŠÙÙƒØªØ¨ Ø³Ø¨Ø¨. Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø§ ÙŠÙØ­ÙØ¸.', 'error');
                        setButtonLoading(confirmBtn, false);
                        return;
                    }

                    await updateDoc(doc(db, "users", userId), { loyaltyPoints: newPoints });
                    
                    if (oldPoints !== newPoints || reason) {
                        const changeLogRef = collection(db, 'users', userId, 'loyaltyChanges');
                        await addDoc(changeLogRef, {
                            type: 'admin_manual_edit',
                            pointsBefore: oldPoints,
                            pointsAfter: newPoints,
                            reason: reason || null, 
                            adminId: auth.currentUser.uid, 
                            timestamp: serverTimestamp()
                        });
                        
                        const notificationRef = collection(db, 'users', userId, 'notifications');
                        const reasonText = reason ? `Ø§Ù„Ø³Ø¨Ø¨: ${reason}` : '';
                        
                        if (newPoints > oldPoints) {
                            const pointsAdded = newPoints - oldPoints;
                            await addDoc(notificationRef, {
                                title: "ğŸ Ù†Ù‚Ø§Ø· Ø¬Ø¯ÙŠØ¯Ø©!",
                                body: `Ø²Ø¨ÙˆÙ†Ù†Ø§ Ø§Ù„ÙƒØ±ÙŠÙ…ØŒ ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${pointsAdded} Ù†Ù‚Ø·Ø© Ù„Ø±ØµÙŠØ¯Ùƒ. ${reasonText}`,
                                timestamp: serverTimestamp(),
                                isRead: false,
                                type: "points_admin_gift"
                            });
                        } else if (newPoints < oldPoints && shouldNotify) {
                            const pointsRemoved = oldPoints - newPoints; // (Ø³ÙŠÙƒÙˆÙ† Ø±Ù‚Ù… Ø³Ø§Ù„Ø¨)
                            await addDoc(notificationRef, {
                                title: "âš ï¸ ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·",
                                body: `ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø±ØµÙŠØ¯Ùƒ Ø¨Ù€ ${pointsRemoved} Ù†Ù‚Ø·Ø©. ${reasonText}`,
                                timestamp: serverTimestamp(),
                                isRead: false,
                                type: "points_admin_removal"
                            });
                        }
                    }
                    
                    showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø· Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    
                    const userInCache = registeredUsersCache.find(u => u.id === userId);
                    if(userInCache) userInCache.loyaltyPoints = newPoints;
                    const pointsSpan = document.getElementById(`points-user-${userId}`);
                    if(pointsSpan) pointsSpan.textContent = newPoints;
                    
                    closeModal();
                } catch (error) {
                    console.error("Error updating points:", error);
                    showToast('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø·. ØªØ£ÙƒØ¯ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†. ' + error.message, 'error');
                } finally {
                    setButtonLoading(confirmBtn, false);
                }
                
            } else {
                errorMsg.classList.remove('hidden');
                codeInput.classList.add('border-red-500');
                return; 
            }
        });

        // (Ø¬Ø¯ÙŠØ¯) Ø§Ù„Ø¢Ù† Ø¨Ø¹Ø¯ Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ØŒ Ù‚Ù… Ø¨Ù…Ù„Ø¡ Ø§Ù„Ø³Ø¬Ù„
        renderLoyaltyHistory(historyData, userId, currentPoints);
        // (Ø¬Ø¯ÙŠØ¯) Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ù†Ù‚Ø±Ø§Øª Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡
        document.getElementById('loyalty-history-list').addEventListener('click', (e) => {
            const reversalBtn = e.target.closest('.reversal-btn');
            if (reversalBtn) {
                handleReversal(reversalBtn);
            }
        });
    };

    const showToast = (message, type = 'success') => {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        const icon = type === 'success' ? 'fa-check-circle' : 'fa-times-circle';
        toast.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    };

    const setButtonLoading = (btn, isLoading, text = 'Ø­ÙØ¸') => {
        if (isLoading) {
            btn.disabled = true;
            btn.innerHTML = `<div class="spinner"></div><span>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...</span>`;
        } else {
            btn.disabled = false;
            btn.innerHTML = text;
        }
    };

    // --- Ø¯ÙˆØ§Ù„ Ø·Ø¨Ø§Ø¹Ø© ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØµÙ„ (Ù…Ø·Ù„ÙˆØ¨Ø© Ù‡Ù†Ø§) ---
    const generateReceiptContent = (orderData, orderId) => {
        const orderDate = orderData.createdAt?.toDate ? orderData.createdAt.toDate().toLocaleString('ar-DZ') : new Date().toLocaleString('ar-DZ');
        const itemsTotal = (orderData.items || []).reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const itemsHtml = (orderData.items || []).map(item => {
            let addonsText = '';
            if(item.selectedAddons && item.selectedAddons.length > 0) {
                addonsText = '<div style="font-size: 10pt; color: #555;">+ ' + item.selectedAddons.map(a => `${a.name} (${formatCurrency(a.price)})`).join(', ') + '</div>';
            }
            const itemTotal = item.price * item.quantity;
            return `<tr><td style="border:1px solid #333; padding:8px;">${item.name}${addonsText}</td><td style="border:1px solid #333; padding:8px;">${item.quantity}</td><td style="border:1px solid #333; padding:8px;">${formatCurrency(item.price)}</td><td style="border:1px solid #333; padding:8px;">${formatCurrency(itemTotal)}</td></tr>`;
        }).join('');
        let financialSummaryHtml = '';
        if (orderData.discountAmount && orderData.discountAmount > 0) {
            const subtotalAfterDiscount = itemsTotal - orderData.discountAmount;
            financialSummaryHtml = `<div style="font-weight:bold;">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${formatCurrency(itemsTotal)}</div><div style="font-weight:bold; color: #c53030;">Ø§Ù„Ø®ØµÙ… (${orderData.couponCode || ''}): -${formatCurrency(orderData.discountAmount)}</div><div style="font-weight:bold;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…: ${formatCurrency(subtotalAfterDiscount)}</div><div style="font-weight:bold;">Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„: ${formatCurrency(orderData.deliveryFee)}</div>`;
        } else {
             financialSummaryHtml = `<div style="font-weight:bold;">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${formatCurrency(itemsTotal)}</div><div style="font-weight:bold;">Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„: ${formatCurrency(orderData.deliveryFee)}</div>`;
        }
        return `<div class="receipt-header" style="text-align:center; margin-bottom:40px;"><h1 style="font-size:24pt; border:none; margin:0;">TEXMEX Annaba</h1><p style="font-size:12pt; margin:5px 0;">ÙˆØµÙ„ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©</p></div><div style="display:flex; justify-content:space-between; margin-bottom:20px; font-size:12pt;"><div><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${orderData.customerName}<br><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${orderData.customerContact}<br><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${orderData.customerLocation}<br><strong>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</strong> ${orderId.substring(0, 6)}</div><div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${orderDate}</div></div><table class="receipt-table" style="width:100%; border-collapse:collapse; font-size:12pt; color: black;"><thead><tr><th style="border:1px solid #333; padding:8px; background-color: #eee;">Ø§Ù„ØµÙ†Ù</th><th style="border:1px solid #333; padding:8px; background-color: #eee;">Ø§Ù„ÙƒÙ…ÙŠØ©</th><th style="border:1px solid #333; padding:8px; background-color: #eee;">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th style="border:1px solid #333; padding:8px; background-color: #eee;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr></thead><tbody>${itemsHtml}</tbody></table><div style="text-align:left; margin-top:20px; font-size:12pt;">${financialSummaryHtml}<hr style="margin: 5px 0;"><div style="font-size:14pt; font-weight:bold;">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${formatCurrency(orderData.totalPrice)}</div></div>`;
    };
    const printOrderReceiptHTML = (orderData, orderId) => {
        const receiptContent = generateReceiptContent(orderData, orderId);
        const printContent = `<div id="receipt-to-print">${receiptContent}<div class="receipt-actions" style="margin-top: 30px; text-align: center;"><button onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø©</button><button onclick="window.close()">Ø¥ØºÙ„Ø§Ù‚</button></div></div>`;
        const printWindow = window.open('', '_blank', 'width=800,height=600');
        printWindow.document.write(`<html><head><title>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙˆØµÙ„</title><link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet"><style>@media print { .receipt-actions { display: none; } } body { font-family: 'Tajawal', sans-serif; }</style></head><body>${printContent}</body></html>`);
        printWindow.document.close();
        printWindow.focus();
    };
    const downloadOrderReceiptPDF = (orderData, orderId) => {
        const receiptHtml = generateReceiptContent(orderData, orderId);
        const element = document.createElement('div');
        element.innerHTML = receiptHtml;
        element.style.fontFamily = 'Tajawal, sans-serif';
        element.style.width = '210mm'; // A4 width
        element.style.padding = '20px';
        
        html2pdf(element, {
            margin:       10,
            filename:     `order_${orderId.substring(0, 6)}.pdf`,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2, useCORS: true },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
        });
        showToast('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ù…Ù„Ù PDF...', 'success');
    };
    
    // --- DASHBOARD INITIALIZATION & NAVIGATION (Ù…Ø´ØªØ±Ùƒ) ---
    
    function setActiveTab() {
        const currentPage = window.location.pathname.split('/').pop();
        if (!currentPage) return;
        const tabs = document.querySelectorAll('.dashboard-tab');
        tabs.forEach(tab => {
            const tabHref = tab.getAttribute('href').split('/').pop();
            if (tabHref === currentPage) {
                tab.classList.add('active-tab');
            } else {
                tab.classList.remove('active-tab');
            }
        });
    }

    function initializeDashboard() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const logoutBtn = document.getElementById('logout-btn');
        mobileMenuBtn.onclick = () => { sidebar.classList.remove('translate-x-full'); overlay.classList.remove('hidden'); };
        overlay.onclick = () => { sidebar.classList.add('translate-x-full'); overlay.classList.add('hidden'); };
        logoutBtn.onclick = () => { signOut(auth).catch((error) => console.error("Logout Error:", error)); };
        setActiveTab();
        
        // =============== Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„ØµÙØ­Ø© ===============
        
        onSnapshot(query(collection(db, "orders"), orderBy("createdAt", "desc")), snapshot => {
            ordersCache = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
        });

        loadRegisteredCustomers();
        
        // =============== Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„ØµÙØ­Ø© ===============
    }


    // --- ===== Ù‚Ø³Ù… "Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¬Ù„ÙˆÙ† (Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª)" ===== ---
    async function loadRegisteredCustomers() {
        const searchInput = document.getElementById('registered-customer-search');
        if(searchInput) {
            searchInput.addEventListener('input', () => renderRegisteredCustomers());
        }

        try {
            const usersSnapshot = await getDocs(query(collection(db, "users"), orderBy("registrationDate", "desc")));
            registeredUsersCache = usersSnapshot.docs.map(d => ({id: d.id, ...d.data()}));
            renderRegisteredCustomers();
        } catch (error) {
            console.error("Error loading registered customers:", error);
            document.getElementById('registered-customers-table-body').innerHTML = `<tr><td colspan="6" class="p-8 text-center text-red-600">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡. ØªØ£ÙƒØ¯ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø­Ù…Ø§ÙŠØ©.</td></tr>`;
        }
    }

    function renderRegisteredCustomers() {
        const tBody = document.getElementById('registered-customers-table-body');
        const searchInput = document.getElementById('registered-customer-search');
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';

        const filteredUsers = registeredUsersCache.filter(user => 
            (user.displayName || '').toLowerCase().includes(searchTerm) ||
            (user.email || '').toLowerCase().includes(searchTerm) ||
            (user.phone || '').includes(searchTerm)
        );

        tBody.innerHTML = filteredUsers.length === 0 ? `<tr><td colspan="6" class="p-8 text-center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø³Ø¬Ù„ÙˆÙ† ÙŠØ·Ø§Ø¨Ù‚ÙˆÙ† Ø¨Ø­Ø«Ùƒ.</td></tr>` : '';

        filteredUsers.forEach(user => {
            const regDate = user.registrationDate?.toDate ? user.registrationDate.toDate().toLocaleDateString('ar-EG') : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
            const row = document.createElement('tr');
            row.className = 'border-b';
            row.innerHTML = `
                <td data-label="Ø§Ù„Ø§Ø³Ù…" class="p-3 font-semibold">${user.displayName || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø³Ù…'}</td>
                <td data-label="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„" class="p-3 text-gray-600">${user.email || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</td>
                <td data-label="Ø§Ù„Ù‡Ø§ØªÙ" class="p-3 font-mono" dir="ltr">${user.phone || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</td>
                <td data-label="Ø§Ù„Ù†Ù‚Ø§Ø·" class="p-3 font-bold text-orange-600 flex justify-between items-center">
                    <span id="points-user-${user.id}">${user.loyaltyPoints || 0}</span>
                    <button class="edit-user-loyalty-btn text-blue-500 hover:text-blue-700" data-id="${user.id}" data-points="${user.loyaltyPoints || 0}" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ù‚Ø§Ø·">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
                <td data-label="ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„" class="p-3 font-mono">${regDate}</td>
                <td data-label="Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª" class="p-3 space-x-2 space-x-reverse text-lg">
                    <button class="view-user-orders-btn text-blue-500 hover:text-blue-700" data-id="${user.uid}" title="Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ">
                        <i class="fas fa-list-alt"></i>
                    </button>
                    <button class="delete-user-btn text-red-500 hover:text-red-700" data-id="${user.id}" title="Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ (Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹)">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            `;
            tBody.appendChild(row);
        });
        
        attachRegisteredCustomerListeners();
    }
    
    function attachRegisteredCustomerListeners() {
        document.querySelectorAll('.view-user-orders-btn').forEach(btn => {
            btn.onclick = (e) => showCustomerOrdersModal(e.currentTarget.dataset.id);
        });
        
        document.querySelectorAll('.edit-user-loyalty-btn').forEach(btn => {
            btn.onclick = (e) => {
                const btnElement = e.currentTarget; 
                const id = btnElement.dataset.id;
                const user = registeredUsersCache.find(u => u.id === id);
                const currentPoints = user ? user.loyaltyPoints : 0;
                showEditLoyaltyModal(id, currentPoints || 0, btnElement);
            };
        });

        document.querySelectorAll('.delete-user-btn').forEach(btn => {
            btn.onclick = (e) => {
                const docId = e.currentTarget.dataset.id;
                showDeletionConfirmModal(async () => {
                    try {
                        await deleteDoc(doc(db, "users", docId));
                        showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ø¶Ùˆ Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                        registeredUsersCache = registeredUsersCache.filter(u => u.id !== docId);
                        renderRegisteredCustomers(); 
                    } catch (error) {
                        console.error("Error deleting user: ", error);
                        showToast('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¹Ø¶Ùˆ.', 'error');
                    }
                });
            };
        });
    }
    
    async function showCustomerOrdersModal(userId) {
        if (!userId) {
            showToast('Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø¶Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.', 'error');
            return;
        }
        
        const user = registeredUsersCache.find(u => u.uid === userId);
        const title = `Ø³Ø¬Ù„ Ø·Ù„Ø¨Ø§Øª: ${user ? user.displayName : 'Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`;
        const modalContent = `<div class="text-center p-8"><div class="spinner-dark mx-auto"></div><p>Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p></div>`;

        showModal(title, modalContent, null, '', false); 

        try {
            const userOrders = ordersCache.filter(order => order.userId === userId);

            let contentHtml = '';
            if (userOrders.length === 0) {
                contentHtml = `<div class="text-center p-8"><i class="fas fa-box-open text-4xl text-gray-400"></i><p class="mt-4 text-gray-600">Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù… ÙŠÙ‚Ù… Ø¨Ø£ÙŠ Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯.</p></div>`;
            } else {
                const ordersHtml = userOrders.map(order => {
                    const orderId = order.id;
                    const orderDate = order.createdAt.toDate().toLocaleDateString('ar-DZ');
                    return `
                        <tr class="border-b">
                            <td class="p-2 font-mono">${orderDate}</td>
                            <td class="p-2 font-mono">${formatCurrency(order.totalPrice)}</td>
                            <td class="p-2"><span class="px-2 py-1 text-sm font-semibold rounded-full ${order.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-gray-100'}">${order.status}</span></td>
                            <td class="p-2 flex items-center gap-3">
                               <button class="print-order-btn text-gray-500 hover:text-black" data-id="${orderId}" title="Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙˆØµÙ„"><i class="fas fa-print"></i></button>
                               <button class="pdf-order-btn text-red-500 hover:text-red-700" data-id="${orderId}" title="ØªØ­Ù…ÙŠÙ„ PDF"><i class="fas fa-file-pdf"></i></button>
                            </td>
                        </tr>`;
                }).join('');
                
                contentHtml = `
                    <div class="max-h-96 overflow-y-auto">
                        <table class="w-full text-sm text-right">
                            <thead class="bg-gray-100 sticky top-0"><tr>
                                <th class="p-2">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th class="p-2">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th class="p-2">Ø§Ù„Ø­Ø§Ù„Ø©</th><th class="p-2">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr></thead>
                            <tbody>${ordersHtml}</tbody>
                        </table>
                    </div>`;
            }
            
            document.getElementById('modal-body').innerHTML = contentHtml;

            document.querySelectorAll('#modal-body .print-order-btn').forEach(btn => btn.onclick = e => {
                const orderId = e.currentTarget.dataset.id;
                const order = ordersCache.find(o => o.id === orderId);
                if (order) printOrderReceiptHTML(order, orderId);
            });
            document.querySelectorAll('#modal-body .pdf-order-btn').forEach(btn => btn.onclick = e => {
                const orderId = e.currentTarget.dataset.id;
                const order = ordersCache.find(o => o.id === orderId);
                if (order) downloadOrderReceiptPDF(order, orderId);
            });

        } catch (error) {
            console.error("Error fetching user orders:", error);
            document.getElementById('modal-body').innerHTML = `<p class="text-red-600 text-center">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª.</p>`;
        }
    }

</script>

</body>
</html>