<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEXMEX - ملفي الشخصي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f1f5f9; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #f97316; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .small-loader { border: 3px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 0.8s linear infinite; }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; translateY(0); } }
        
        #user-menu-dropdown.show {
            display: block;
            animation: slideInUp 0.2s ease-out;
        }
        
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100; }
        .toast { background-color: #2d3748; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-top: 10px; display: flex; align-items: center; gap: 10px; animation: slideInUp 0.3s ease, fadeOut 0.5s ease 2.5s forwards; }
        .toast.success { background-color: #2f855a; }
        .toast.error { background-color: #c53030; }
        @keyframes fadeOut { from { opacity: 1; } to: { opacity: 0; } }
    </style>
</head>
<body>

    <header class="bg-white shadow-sm sticky top-0 z-30">
        </header>

    <main class="max-w-3xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
        
        <div id="auth-loader" class="text-center py-20">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-gray-600 text-lg">جاري جلب بياناتك...</p>
        </div>

        <div id="profile-content" class="hidden" style="animation: slideInUp 0.5s ease-out;">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 text-center mb-8">
                <i class="fas fa-user-edit text-orange-400"></i> ملفي الشخصي
            </h1>

            <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                <form id="profile-form" class="space-y-6 p-8">
                    
                    <div>
                        <label for="profile-name" class="block text-sm font-semibold text-gray-700 mb-1">الاسم الكامل</label>
                        <input type="text" id="profile-name" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" required>
                    </div>

                    <div>
                        <label for="profile-email" class="block text-sm font-semibold text-gray-700 mb-1">البريد الإلكتروني</label>
                        <input type="email" id="profile-email" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100 text-gray-500 cursor-not-allowed" disabled>
                        <p class="text-xs text-gray-400 mt-1">لا يمكن تغيير البريد الإلكتروني بعد التسجيل.</p>
                    </div>

                    <div>
                        <label for="profile-phone" class="block text-sm font-semibold text-gray-700 mb-1">رقم الهاتف الأساسي (لا يمكن تغييره لاحقاً)</label>
                        <input type="tel" id="profile-phone" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" dir="ltr" required>
                        <p id="phone-message" class="text-xs text-gray-400 mt-1">
                            <i class="fas fa-info-circle"></i> هذا الرقم هو الضمان لحسابك ولن يتكرر.
                        </p>
                    </div>

                    <div class="border-t pt-6">
                        <button type="submit" id="save-profile-btn" class="w-full flex justify-center items-center gap-2 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-colors">
                            <span id="save-btn-text">حفظ التعديلات</span>
                            <div id="save-btn-loader" class="small-loader hidden"></div>
                        </button>
                    </div>

                </form>
            </div>

            <div id="referral-section" class="mt-8 bg-white rounded-2xl shadow-xl p-8 hidden">
                <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">
                    <i class="fas fa-gift text-orange-400"></i> نظام الدعوات
                </h2>
                <p class="text-center text-gray-600 mb-4">
                    شارك هذا الكود مع أصدقائك. عندما يقوم صديقك بإنشاء حساب جديد باستخدام هذا الكود، ستحصل أنت على نقاط مكافأة!
                </p>
                
                <div id="referral-code-loader" class="text-center py-5">
                    <div class="loader mx-auto !w-10 !h-10 !border-4"></div>
                    <p class="mt-3 text-gray-500">جاري إنشاء كود الدعوة الخاص بك...</p>
                </div>

                <div id="referral-code-display" class="hidden">
                    <label class="block text-sm font-semibold text-gray-700 mb-2 text-center">كود الدعوة الخاص بك:</label>
                    <div class="relative max-w-sm mx-auto">
                        <input type="text" id="referral-code-input" class="w-full p-4 border-2 border-dashed border-gray-300 rounded-lg bg-gray-50 text-center text-3xl font-mono font-bold text-orange-600 tracking-widest" value="..." readonly>
                        <button id="copy-referral-btn" class="absolute left-2 top-1/2 -translate-y-1/2 bg-gray-200 text-gray-700 p-2 rounded-lg hover:bg-gray-300" title="نسخ الكود">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            </div>
            </div>
    </main>
    
    <div id="toast-container"></div>

    <script type="module">
        // --- إعدادات Firebase ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- (*** تم التعديل: إضافة writeBatch, deleteDoc ***) ---
        import { getFirestore, doc, getDoc, updateDoc, setDoc, collection, addDoc, serverTimestamp, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            // ... (كما هو) ...
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- عناصر واجهة المستخدم ---
        // ... (عناصر الهيدر كما هي) ...
        const loginBtn = document.getElementById('login-btn');
        const userMenu = document.getElementById('user-menu');
        const userMenuButton = document.getElementById('user-menu-button');
        const userMenuDropdown = document.getElementById('user-menu-dropdown');
        const userMenuName = document.getElementById('user-menu-name');
        const userMenuDisplayName = document.getElementById('user-menu-displayname');
        const logoutBtn = document.getElementById('logout-btn');

        const authLoader = document.getElementById('auth-loader');
        const profileContent = document.getElementById('profile-content');
        const profileForm = document.getElementById('profile-form');
        const profileName = document.getElementById('profile-name');
        const profileEmail = document.getElementById('profile-email');
        const profilePhone = document.getElementById('profile-phone');
        const phoneMessage = document.getElementById('phone-message');
        const saveBtn = document.getElementById('save-profile-btn');
        const saveBtnText = document.getElementById('save-btn-text');
        const saveBtnLoader = document.getElementById('save-btn-loader');

        // (**** بداية الإضافة: عناصر كود الدعوة ****)
        const referralSection = document.getElementById('referral-section');
        const referralCodeLoader = document.getElementById('referral-code-loader');
        const referralCodeDisplay = document.getElementById('referral-code-display');
        const referralCodeInput = document.getElementById('referral-code-input');
        const copyReferralBtn = document.getElementById('copy-referral-btn');
        // (**** نهاية الإضافة ****)

        // --- تمت الإضافة: متغيرات لحفظ القيم القديمة للمقارنة ---
        let oldName = '';
        let oldPhone = '';
        let hasPhoneBeenSet = false; // (جديد) لمنع تغيير الرقم بعد الحفظ
        // ----------------------------------------------------

        // --- دالة التنبيهات (Toast) ---
        const showToast = (message, type = 'success') => { /* ... (كما هي) ... */ };

        // --- جلب بيانات الملف الشخصي (*** تم التعديل ***) ---
        async function loadProfileData(user) {
            try {
                const userDocRef = doc(db, 'users', user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    const data = userDocSnap.data();
                    
                    oldName = data.displayName || user.displayName || '';
                    oldPhone = data.phone || '';
                    profileName.value = oldName;
                    profileEmail.value = data.email || user.email || '';
                    profilePhone.value = oldPhone;

                    // (*** بداية الإضافة: منطق حقل الهاتف وكود الدعوة ***)
                    if (oldPhone) {
                        hasPhoneBeenSet = true;
                        profilePhone.disabled = true;
                        profilePhone.classList.add('bg-gray-100', 'cursor-not-allowed');
                        phoneMessage.innerHTML = '<i class="fas fa-lock text-green-600"></i> تم تأكيد هذا الرقم. لا يمكن تغييره.';
                        phoneMessage.className = 'text-xs text-green-700 mt-1';
                    } else {
                        hasPhoneBeenSet = false;
                        phoneMessage.innerHTML = '<i class="fas fa-exclamation-triangle text-red-500"></i> سيتم ربط هذا الرقم بحسابك نهائياً. تأكد من صحته.';
                        phoneMessage.className = 'text-xs text-red-600 mt-1';
                    }

                    // إظهار قسم الدعوات
                    referralSection.classList.remove('hidden');
                    if (data.referralCode) {
                        referralCodeInput.value = data.referralCode;
                        referralCodeLoader.classList.add('hidden');
                        referralCodeDisplay.classList.remove('hidden');
                    } else {
                        // الدالة السحابية ربما لم تعمل بعد، ننتظر
                        console.log("Waiting for referral code generation...");
                    }
                    // (*** نهاية الإضافة ***)

                } else {
                    // ... (حالة نادرة) ...
                }

                authLoader.classList.add('hidden');
                profileContent.classList.remove('hidden');

            } catch (error) {
                console.error("Error fetching profile data: ", error);
                authLoader.innerHTML = '<p class="text-red-500 text-center">حدث خطأ أثناء جلب بياناتك.</p>';
            }
        }
        
        // (**** بداية الإضافة: زر نسخ الكود ****)
        copyReferralBtn.addEventListener('click', () => {
            referralCodeInput.select();
            document.execCommand('copy');
            showToast('تم نسخ الكود بنجاح!', 'success');
        });
        // (**** نهاية الإضافة ****)


        // --- معالج حفظ التعديلات (*** تم التعديل بالكامل ***) ---
        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newName = profileName.value.trim();
            const newPhone = profilePhone.value.trim();

            if (!newName || !newPhone) {
                showToast('الرجاء ملء حقلي الاسم والهاتف', 'error');
                return;
            }

            // تحقق بسيط من صيغة الرقم (يمكن تحسينه)
            if (!/^\d{9,15}$/.test(newPhone)) {
                showToast('الرجاء إدخال رقم هاتف صحيح (9-15 أرقام).', 'error');
                return;
            }

            saveBtn.disabled = true;
            saveBtnText.classList.add('hidden');
            saveBtnLoader.classList.remove('hidden');

            const user = auth.currentUser;
            const userDocRef = doc(db, 'users', user.uid);
            
            // نستخدم "دفعة" لضمان تنفيذ كل شيء أو فشل كل شيء
            const batch = writeBatch(db);

            try {
                // --- الخطوة 1: التحقق من الهاتف (إذا كان جديداً أو متغيراً) ---
                const phoneChanged = (newPhone !== oldPhone) && !hasPhoneBeenSet;
                
                if (phoneChanged) {
                    const phoneDocRef = doc(db, "phoneNumbers", newPhone);
                    const phoneDocSnap = await getDoc(phoneDocRef);
                    
                    if (phoneDocSnap.exists()) {
                        // الرقم محجوز من قبل شخص آخر
                        throw new Error('رقم الهاتف هذا مستخدم بالفعل من قبل حساب آخر.');
                    }
                    
                    // حجز الرقم الجديد
                    batch.set(phoneDocRef, { uid: user.uid });
                    
                    // إذا كان هناك رقم قديم (نادر، لكن للاحتياط)
                    if (oldPhone) {
                        batch.delete(doc(db, "phoneNumbers", oldPhone));
                    }
                }

                // --- الخطوة 2: تجهيز تحديث بيانات العميل ---
                const dataToUpdate = {
                    displayName: newName,
                    phone: newPhone // سيتم حفظ الرقم الجديد
                };
                batch.set(userDocRef, dataToUpdate, { merge: true });

                // --- الخطوة 3: تحديث بيانات Auth (للاسم المعروض) ---
                if (newName !== oldName) {
                    await updateProfile(user, { displayName: newName });
                }
                
                // --- الخطوة 4: تنفيذ الدفعة (الحفظ الفعلي) ---
                await batch.commit();

                // --- الخطوة 5: تسجيل التغييرات (Audit Log) ---
                const changes = {};
                if (newName !== oldName) changes.displayName = { old: oldName, new: newName };
                if (phoneChanged) changes.phone = { old: oldPhone, new: newPhone };

                if (Object.keys(changes).length > 0) {
                    const changesCollectionRef = collection(db, 'users', user.uid, 'profileChanges');
                    await addDoc(changesCollectionRef, {
                        changes,
                        timestamp: serverTimestamp()
                    });
                    
                    // تحديث القيم القديمة بالجديدة
                    oldName = newName;
                    oldPhone = newPhone;
                    
                    // (جديد) قفل حقل الهاتف بعد الحفظ
                    if (phoneChanged) {
                        hasPhoneBeenSet = true;
                        profilePhone.disabled = true;
                        profilePhone.classList.add('bg-gray-100', 'cursor-not-allowed');
                        phoneMessage.innerHTML = '<i class="fas fa-lock text-green-600"></i> تم تأكيد هذا الرقم. لا يمكن تغييره.';
                        phoneMessage.className = 'text-xs text-green-700 mt-1';
                    }
                }

                showToast('تم حفظ التعديلات بنجاح!', 'success');
                // تحديث اسم القائمة في الهيدر
                userMenuName.textContent = newName.split(' ')[0];
                userMenuDisplayName.textContent = newName;

            } catch (error) {
                console.error("Error updating profile: ", error);
                // عرض رسالة الخطأ المخصصة إذا كان الرقم مستخدماً
                if (error.message.includes('رقم الهاتف')) {
                    showToast(error.message, 'error');
                } else {
                    showToast('حدث خطأ أثناء حفظ التعديلات. (قد يكون الرقم مستخدماً)', 'error');
                }
            } finally {
                saveBtn.disabled = false;
                saveBtnText.classList.remove('hidden');
                saveBtnLoader.classList.add('hidden');
            }
        });

        // --- منطق المصادقة والتحكم بالصفحة ---
        onAuthStateChanged(auth, (user) => { /* ... (كما هو) ... */ });

        // --- معالجات القائمة وتسجيل الخروج ---
        userMenuButton.addEventListener('click', (e) => { /* ... (كما هو) ... */ });
        document.addEventListener('click', () => { /* ... (كما هو) ... */ });
        logoutBtn.addEventListener('click', () => { /* ... (كما هو) ... */ });
    </script>
</body>
</html>