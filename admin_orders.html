<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEXMEX - Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.23/dist/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f0f2f5; }
        .hidden { display: none; }
        .dashboard-tab.active-tab { background-color: #ea580c; color: white; }
        .dashboard-panel { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 40; display: flex; align-items: center; justify-content: center; }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 700px; z-index: 50; max-height: 90vh; overflow-y: auto; }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 100; }
        .toast { background-color: #2d3748; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-top: 10px; display: flex; align-items: center; gap: 10px; animation: slideInUp 0.3s ease, fadeOut 0.5s ease 2.5s forwards; }
        .toast.success { background-color: #2f855a; }
        .toast.error { background-color: #c53030; }
        @keyframes slideInUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #48bb78; }
        input:checked + .slider:before { transform: translateX(24px); }
        .spinner { width: 24px; height: 24px; border: 4px solid rgba(255, 255, 255, 0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; }
        .spinner-dark { width: 24px; height: 24px; border: 4px solid rgba(0,0,0, 0.1); border-top-color: #333; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 768px) { .responsive-table thead { display: none; } .responsive-table tr { display: block; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; } .responsive-table td { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6; } .responsive-table td:last-child { border-bottom: none; } .responsive-table td::before { content: attr(data-label); font-weight: 600; margin-left: 0.5rem; } }
        .filter-btn { padding: 8px 16px; border-radius: 8px; border: 1px solid #ddd; background-color: white; transition: all 0.2s; }
        .filter-btn.active { background-color: #f97316; color: white; border-color: #f97316; }
        .ql-editor { min-height: 120px; }
        /* (Ø®Ø§Øµ Ø¨Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙˆØµÙ„) */
        @media print {
            body * { visibility: hidden; }
            #receipt-to-print, #receipt-to-print * { visibility: visible; }
            #receipt-to-print { position: absolute; left: 0; top: 0; width: 100%; padding: 20px; font-family: 'Tajawal', sans-serif; direction: rtl; color: black; }
            .receipt-header h1 { font-size: 24pt; color: black; border: none; }
            .receipt-table th, .receipt-table td { color: black; }
            .receipt-actions { display: none; }
        }
    </style>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
</head>
<body>

    <div id="auth-loader" class="flex flex-col items-center justify-center min-h-screen bg-gray-100">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-4">TEX<span class="text-orange-500">MEX</span></h1>
        <div class="spinner-dark"></div>
        <p class="mt-4 text-gray-600">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ©...</p>
    </div>

    <div id="dashboard-page" class="hidden">
        <div class="relative min-h-screen md:flex">

            <aside id="sidebar" class="bg-gray-800 text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 right-0 transform translate-x-full md:relative md:translate-x-0 transition duration-300 ease-in-out z-30">
                <div class="p-3 text-center border-b border-gray-700">
                    <h2 class="text-2xl font-bold">TEX<span class="text-orange-400">MEX</span></h2>
                </div>
                <nav class="flex-1 p-2 space-y-2">
                    <a href="admin_dashboard.html" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-tachometer-alt fa-fw ml-3"></i> Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
                    <a href="admin_orders.html" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-clipboard-list fa-fw ml-3"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</a>
                    <a href="admin_loyalty_approvals.html" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-check-to-slot fa-fw ml-3"></i> Ù…ÙˆØ§ÙÙ‚Ø§Øª Ø§Ù„Ù†Ù‚Ø§Ø·</a>
                    <a href="admin_customer_log.html" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-users fa-fw ml-3"></i> Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ø¨Ø§Ù„Ø·Ù„Ø¨Ø§Øª)</a>
                    <a href="admin_customers.html" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-id-card fa-fw ml-3"></i> Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¬Ù„ÙˆÙ†</a>
                    <a href="admin_menu_items.html" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-utensils fa-fw ml-3"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø¹Ø§Ù…</a>
                    <a href="admin_offers.html" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-star fa-fw ml-3"></i> Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙˆØ§Ù„Ø¨Ø§Ù‚Ø§Øª</a>
                    <a href="admin_coupons.html" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-tags fa-fw ml-3"></i> Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª</a>
                    <a href="admin_categories.html" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-sitemap fa-fw ml-3"></i> Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</a>
                    <a href="admin_delivery_personnel.html" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-biking fa-fw ml-3"></i> Ø¹Ù…Ø§Ù„ Ø§Ù„ØªÙˆØµÙŠÙ„</a>
                    <a href="admin_stats.html" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-chart-line fa-fw ml-3"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</a>
                    <a href="admin_loyalty_settings.html" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-gift fa-fw ml-3"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆÙØ§Ø¡</a>
                    <a href="admin_delivery.html" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-motorcycle fa-fw ml-3"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„</a>
                    <a href="admin_settings.html" class="dashboard-tab flex items-center px-4 py-3 rounded-md hover:bg-orange-700"><i class="fas fa-cogs fa-fw ml-3"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ø¹Ù…</a>
                </nav>
                <div class="p-4 border-t border-gray-700">
                    <button id="logout-btn" class="w-full flex items-center justify-center px-4 py-3 rounded-md bg-red-600 hover:bg-red-700">
                        <i class="fas fa-sign-out-alt fa-fw ml-3"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                    </button>
                </div>
            </aside>
            <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden hidden"></div>
            
            <div class="flex-1 flex flex-col">
                <header class="bg-white shadow-md p-4 flex justify-between items-center">
                    <h1 class="text-xl font-bold">TEX<span class="text-orange-500">MEX</span> Dashboard</h1>
                    <button id="mobile-menu-btn" class="text-gray-800 p-2 rounded-lg md:hidden"><i class="fas fa-bars fa-lg"></i></button>
                </header>
                
                <main class="flex-1 p-4 md:p-8 overflow-y-auto">
                    
                    <div id="orders-panel" class="dashboard-panel">
                        <div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-6">
                            <h1 class="text-3xl font-bold text-gray-800">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h1>
                            <div class="relative"><i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input type="text" id="order-search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ..." class="w-full md:w-64 pr-10 pl-3 py-2 border rounded-lg"></div>
                        </div>
                        <div class="flex items-center gap-3 mb-4" id="order-status-filters">
                            <button class="filter-btn active" data-status="all">Ø§Ù„ÙƒÙ„</button>
                            <button class="filter-btn" data-status="new">Ø¬Ø¯ÙŠØ¯</button>
                            <button class="filter-btn" data-status="completed">Ù…ÙƒØªÙ…Ù„</button>
                            <button class="filter-btn" data-status="canceled">Ù…Ù„ØºÙŠ</button>
                        </div>
                        <div class="overflow-x-auto bg-white rounded-xl shadow-md">
                        <table class="w-full text-right responsive-table">
                            <thead class="bg-gray-100"><tr>
                                <th class="p-3">Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th class="p-3">Ø§Ù„Ù‡Ø§ØªÙ</th><th class="p-3">Ø§Ù„Ø·Ù„Ø¨ÙŠØ©</th>
                                <th class="p-3">Ø§Ù„Ù…Ø¨Ù„Øº</th><th class="p-3">Ø§Ù„Ø­Ø§Ù„Ø©</th><th class="p-3">Ø¹Ø§Ù…Ù„ Ø§Ù„ØªÙˆØµÙŠÙ„</th><th class="p-3">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr></thead>
                            <tbody id="orders-table-body">
                                <tr><td colspan="7" class="p-8 text-center"><div class="spinner-dark mx-auto"></div><p class="mt-2">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p></td></tr>
                            </tbody>
                        </table>
                        </div>
                    </div>

                </main>
                </div>
        </div>
    </div>

    <div id="modal-container"></div>
    <div id="toast-container"></div>
    <audio id="notification-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-notification-947.mp3" preload="auto"></audio>

<script type="module">
    // --- FIREBASE INITIALIZATION (Ù…Ø´ØªØ±Ùƒ) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, serverTimestamp, orderBy, getDoc, setDoc, getDocs, where, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyAsG-85oNZq8kzWPHIDpsifkQ7rhua_oPk",
        authDomain: "texmexfoodannaba23.firebaseapp.com",
        projectId: "texmexfoodannaba23",
        storageBucket: "texmexfoodannaba23.appspot.com",
        messagingSenderId: "712480664933",
        appId: "1:712480664933:web:a5310190bf63115ac9058c",
        measurementId: "G-38D210X1EG"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // --- AUTHENTICATION GATE (Ù…Ø´ØªØ±Ùƒ) ---
    const authLoader = document.getElementById('auth-loader');
    const dashboardPage = document.getElementById('dashboard-page');

    onAuthStateChanged(auth, (user) => {
        if (user) {
            authLoader.classList.add('hidden');
            dashboardPage.classList.remove('hidden');
            initializeDashboard(); 
        } else {
            window.location.href = 'logindashborded.html'; 
        }
    });

    // --- GLOBAL CACHES & STATE (Ù…Ø´ØªØ±Ùƒ) ---
    let categoriesCache = [];
    let deliveryPersonnelCache = [];
    let menuItemsCache = [];
    let offersCache = [];
    let couponsCache = [];
    let ordersCache = [];
    let deliveryZonesCache = [];
    let registeredUsersCache = [];
    let quillEditor = null; 
    let selectedFileStore = {}; 
    
    // --- (Ø¬Ø¯ÙŠØ¯) Ù…ØªØºÙŠØ±Ø§Øª Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© ---
    let isInitialOrdersLoad = true;
    let currentOrderStatusFilter = 'all';

    // --- UI & UX HELPERS (Ù…Ø´ØªØ±ÙƒØ©) ---
    
    const formatCurrency = (number) => {
        const num = Math.round(number) || 0;
        return `${num} Ø¯.Ø¬`;
    };

    const showModal = (title, content, onConfirm, confirmText = 'Ø­ÙØ¸', showCancel = true) => {
        const modalContainer = document.getElementById('modal-container');
        const confirmButtonHtml = onConfirm ? `<button id="modal-confirm" class="bg-orange-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-orange-700 flex items-center gap-2">${confirmText}</button>` : '';
        const cancelButtonHtml = showCancel ? `<button id="modal-cancel" class="bg-gray-200 px-6 py-2 rounded-lg font-semibold hover:bg-gray-300">Ø¥Ù„ØºØ§Ø¡</button>` : '';
        modalContainer.innerHTML = `<div class="modal-backdrop" id="modal-backdrop"><div class="modal-content"><div class="flex justify-between items-center mb-4 border-b pb-3"><h3 class="text-xl font-bold">${title}</h3><button id="modal-close-btn" class="text-2xl">&times;</button></div><div id="modal-body">${content}</div><div class="flex justify-end gap-4 mt-6 border-t pt-4">${cancelButtonHtml}${confirmButtonHtml}</div></div></div>`;
        const close = () => { quillEditor = null; modalContainer.innerHTML = ''; }
        if (showCancel) document.getElementById('modal-cancel').onclick = close;
        document.getElementById('modal-close-btn').onclick = close;
        document.getElementById('modal-backdrop').onclick = e => { if (e.target.id === 'modal-backdrop') close(); };
        if (onConfirm) document.getElementById('modal-confirm').onclick = onConfirm;
    };

    const closeModal = () => {
         quillEditor = null;
        document.getElementById('modal-container').innerHTML = '';
    }

    const showDeletionConfirmModal = (onConfirmCallback) => {
        const content = `<p class="mb-4 text-lg">Ù„ØªØ£ÙƒÙŠØ¯ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°ÙØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„ØªØ§Ù„ÙŠ:</p><div class="text-center mb-4"><code class="text-2xl font-bold bg-gray-100 p-2 rounded-lg text-orange-600 select-all">S22MARKET</code></div><input type="text" id="deletion-code-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù‡Ù†Ø§ Ù„Ù„ØªØ£ÙƒÙŠØ¯" class="w-full p-3 border rounded-lg text-center tracking-widest uppercase focus:ring-2 focus:ring-orange-400 focus:border-orange-400"><p id="deletion-error-msg" class="text-red-600 text-sm mt-2 text-center hidden">Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø°ÙŠ Ø£Ø¯Ø®Ù„ØªÙ‡ ØºÙŠØ± ØµØ­ÙŠØ­.</p>`;
        showModal('ØªØ£ÙƒÙŠØ¯ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°Ù', content, () => {
            const codeInput = document.getElementById('deletion-code-input');
            const errorMsg = document.getElementById('deletion-error-msg');
            if (codeInput.value.trim().toUpperCase() === 'S22MARKET') { onConfirmCallback(); closeModal(); } 
            else { errorMsg.classList.remove('hidden'); codeInput.classList.add('border-red-500'); }
        }, 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù', true);
    };

    const showEditLoyaltyModal = (userId, currentPoints) => {
        // ... (Ø§Ù„Ø¯Ø§Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø´ØªØ±ÙƒØŒ Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„ØªÙƒØ±Ø§Ø±Ù‡Ø§ Ù‡Ù†Ø§ Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø§Ø­ØªØ¬ØªÙ‡Ø§)
    };

    const showToast = (message, type = 'success') => {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        const icon = type === 'success' ? 'fa-check-circle' : 'fa-times-circle';
        toast.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    };

    const setButtonLoading = (btn, isLoading, text = 'Ø­ÙØ¸') => {
        if (isLoading) {
            btn.disabled = true;
            btn.innerHTML = `<div class="spinner"></div><span>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...</span>`;
        } else {
            btn.disabled = false;
            btn.innerHTML = text;
        }
    };
    
    // --- Ø¯ÙˆØ§Ù„ Ø·Ø¨Ø§Ø¹Ø© ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØµÙ„ (Ù…Ø·Ù„ÙˆØ¨Ø© Ù‡Ù†Ø§) ---
    const generateReceiptContent = (orderData, orderId) => {
        const orderDate = orderData.createdAt?.toDate ? orderData.createdAt.toDate().toLocaleString('ar-DZ') : new Date().toLocaleString('ar-DZ');
        const itemsTotal = (orderData.items || []).reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const itemsHtml = (orderData.items || []).map(item => {
            let addonsText = '';
            if(item.selectedAddons && item.selectedAddons.length > 0) {
                addonsText = '<div style="font-size: 10pt; color: #555;">+ ' + item.selectedAddons.map(a => `${a.name} (${formatCurrency(a.price)})`).join(', ') + '</div>';
            }
            const itemTotal = item.price * item.quantity;
            return `<tr><td style="border:1px solid #333; padding:8px;">${item.name}${addonsText}</td><td style="border:1px solid #333; padding:8px;">${item.quantity}</td><td style="border:1px solid #333; padding:8px;">${formatCurrency(item.price)}</td><td style="border:1px solid #333; padding:8px;">${formatCurrency(itemTotal)}</td></tr>`;
        }).join('');
        let financialSummaryHtml = '';
        if (orderData.discountAmount && orderData.discountAmount > 0) {
            const subtotalAfterDiscount = itemsTotal - orderData.discountAmount;
            financialSummaryHtml = `<div style="font-weight:bold;">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${formatCurrency(itemsTotal)}</div><div style="font-weight:bold; color: #c53030;">Ø§Ù„Ø®ØµÙ… (${orderData.couponCode || ''}): -${formatCurrency(orderData.discountAmount)}</div><div style="font-weight:bold;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…: ${formatCurrency(subtotalAfterDiscount)}</div><div style="font-weight:bold;">Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„: ${formatCurrency(orderData.deliveryFee)}</div>`;
        } else {
             financialSummaryHtml = `<div style="font-weight:bold;">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${formatCurrency(itemsTotal)}</div><div style="font-weight:bold;">Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„: ${formatCurrency(orderData.deliveryFee)}</div>`;
        }
        return `<div class="receipt-header" style="text-align:center; margin-bottom:40px;"><h1 style="font-size:24pt; border:none; margin:0;">TEXMEX Annaba</h1><p style="font-size:12pt; margin:5px 0;">ÙˆØµÙ„ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©</p></div><div style="display:flex; justify-content:space-between; margin-bottom:20px; font-size:12pt;"><div><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${orderData.customerName}<br><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${orderData.customerContact}<br><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${orderData.customerLocation}<br><strong>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</strong> ${orderId.substring(0, 6)}</div><div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${orderDate}</div></div><table class="receipt-table" style="width:100%; border-collapse:collapse; font-size:12pt; color: black;"><thead><tr><th style="border:1px solid #333; padding:8px; background-color: #eee;">Ø§Ù„ØµÙ†Ù</th><th style="border:1px solid #333; padding:8px; background-color: #eee;">Ø§Ù„ÙƒÙ…ÙŠØ©</th><th style="border:1px solid #333; padding:8px; background-color: #eee;">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th style="border:1px solid #333; padding:8px; background-color: #eee;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr></thead><tbody>${itemsHtml}</tbody></table><div style="text-align:left; margin-top:20px; font-size:12pt;">${financialSummaryHtml}<hr style="margin: 5px 0;"><div style="font-size:14pt; font-weight:bold;">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${formatCurrency(orderData.totalPrice)}</div></div>`;
    };
    const printOrderReceiptHTML = (orderData, orderId) => {
        const receiptContent = generateReceiptContent(orderData, orderId);
        const printContent = `<div id="receipt-to-print">${receiptContent}<div class="receipt-actions" style="margin-top: 30px; text-align: center;"><button onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø©</button><button onclick="window.close()">Ø¥ØºÙ„Ø§Ù‚</button></div></div>`;
        const printWindow = window.open('', '_blank', 'width=800,height=600');
        printWindow.document.write(`<html><head><title>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙˆØµÙ„</title><link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet"><style>@media print { .receipt-actions { display: none; } } body { font-family: 'Tajawal', sans-serif; }</style></head><body>${printContent}</body></html>`);
        printWindow.document.close();
        printWindow.focus();
    };
    const downloadOrderReceiptPDF = (orderData, orderId) => {
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… html2pdf.js ÙƒØ­Ù„ Ø£Ø³Ù‡Ù„ Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
        const receiptHtml = generateReceiptContent(orderData, orderId);
        const element = document.createElement('div');
        element.innerHTML = receiptHtml;
        element.style.fontFamily = 'Tajawal, sans-serif';
        element.style.width = '210mm'; // A4 width
        element.style.padding = '20px';
        
        html2pdf(element, {
            margin:       10,
            filename:     `order_${orderId.substring(0, 6)}.pdf`,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2, useCORS: true },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
        });
        showToast('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ù…Ù„Ù PDF...', 'success');
    };
    
    async function compressImage(file, maxWidth = 1024) { /* ... (Ø¯Ø§Ù„Ø© Ø§Ù„Ø¶ØºØ·) ... */ }
    async function uploadImageToImgBB(file) { /* ... (Ø¯Ø§Ù„Ø© Ø§Ù„Ø±ÙØ¹) ... */ }


    // --- DASHBOARD INITIALIZATION & NAVIGATION (Ù…Ø´ØªØ±Ùƒ) ---
    
    function setActiveTab() {
        const currentPage = window.location.pathname.split('/').pop();
        if (!currentPage) return;
        const tabs = document.querySelectorAll('.dashboard-tab');
        tabs.forEach(tab => {
            const tabHref = tab.getAttribute('href').split('/').pop();
            if (tabHref === currentPage) {
                tab.classList.add('active-tab');
            } else {
                tab.classList.remove('active-tab');
            }
        });
    }

    function initializeDashboard() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const logoutBtn = document.getElementById('logout-btn');
        mobileMenuBtn.onclick = () => { sidebar.classList.remove('translate-x-full'); overlay.classList.remove('hidden'); };
        overlay.onclick = () => { sidebar.classList.add('translate-x-full'); overlay.classList.add('hidden'); };
        logoutBtn.onclick = () => { signOut(auth).catch((error) => console.error("Logout Error:", error)); };
        setActiveTab();
        
        // =============== Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„ØµÙØ­Ø© ===============
        
        // (Ø¬Ø¯ÙŠØ¯) Ù†Ø­ØªØ§Ø¬ Ø¬Ù„Ø¨ Ø¹Ù…Ø§Ù„ Ø§Ù„ØªÙˆØµÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù…Ù„Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
        loadDeliveryPersonnel();
        
        // (Ø¬Ø¯ÙŠØ¯) Ø«Ù… Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        loadOrders();
        
        // =============== Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„ØµÙØ­Ø© ===============
    }

    // --- (Ø¬Ø¯ÙŠØ¯) Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø¹Ù…Ø§Ù„ Ø§Ù„ØªÙˆØµÙŠÙ„ (Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©) ---
    function loadDeliveryPersonnel() {
        // Ø¬Ù„Ø¨ Ø¹Ù…Ø§Ù„ Ø§Ù„ØªÙˆØµÙŠÙ„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙˆØªØ®Ø²ÙŠÙ†Ù‡Ù… ÙÙŠ Ø§Ù„ÙƒØ§Ø´
        onSnapshot(query(collection(db, "delivery_personnel"), orderBy("name")), snapshot => {
            deliveryPersonnelCache = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
            // Ø¨Ø¹Ø¯ Ø¬Ù„Ø¨ Ø¹Ù…Ø§Ù„ Ø§Ù„ØªÙˆØµÙŠÙ„ØŒ Ù†Ø¹ÙŠØ¯ Ø±Ø³Ù… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„Ø¶Ù…Ø§Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
            renderOrdersTable();
        });
    }

    // --- ORDERS SECTION (Ø®Ø§Øµ Ø¨Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©) ---
    function loadOrders() {
        const searchInput = document.getElementById('order-search-input');
        searchInput.addEventListener('input', () => renderOrdersTable());

        document.querySelectorAll('#order-status-filters .filter-btn').forEach(btn => {
            btn.onclick = (e) => {
                document.querySelector('#order-status-filters .filter-btn.active').classList.remove('active');
                e.currentTarget.classList.add('active');
                currentOrderStatusFilter = e.currentTarget.dataset.status;
                renderOrdersTable();
            };
        });

        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø·Ù„Ø¨Ø§Øª
        onSnapshot(query(collection(db, "orders"), orderBy("createdAt", "desc")), snapshot => {
            if (!isInitialOrdersLoad && snapshot.docChanges().some(c => c.type === "added")) {
                document.getElementById('notification-sound').play();
                showToast('Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ÙˆØ±Ø¯!', 'success');
            }
            isInitialOrdersLoad = false;
            ordersCache = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
            renderOrdersTable(); // Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        });
    }

    function renderOrdersTable() {
        const tableBody = document.getElementById('orders-table-body');
        if (!tableBody) return; // ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø¹Ù†ØµØ± Ù…ÙˆØ¬ÙˆØ¯

        const searchInput = document.getElementById('order-search-input');
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';

        const filteredOrders = ordersCache.filter(order => {
            const matchesSearch = (order.customerName || '').toLowerCase().includes(searchTerm) || (order.customerContact || '').includes(searchTerm);
            const matchesFilter = currentOrderStatusFilter === 'all' || order.status === currentOrderStatusFilter;
            return matchesSearch && matchesFilter;
        });

        tableBody.innerHTML = filteredOrders.length === 0 ? `<tr><td colspan="7" class="p-8 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø¨Ø­Ø«Ùƒ.</td></tr>` : '';

        filteredOrders.forEach(order => {
            const statusColors = { new: 'bg-blue-100 text-blue-800', completed: 'bg-green-100 text-green-800', canceled: 'bg-red-100 text-red-800' };
            const itemsHtml = (order.items || []).map(item => {
                let itemText = `<div><span class="font-semibold">${item.quantity} x ${item.name}</span></div>`;
                if (item.selectedAddons && item.selectedAddons.length > 0) {
                    const addonsText = item.selectedAddons.map(addon => `<div class="text-xs text-gray-600 mr-4">+ ${addon.name} (${formatCurrency(addon.price)})</div>`).join('');
                    itemText += addonsText;
                }
                return itemText;
            }).join('');

            let couponHtml = '';
            if(order.couponCode) { couponHtml = `<div class="text-xs text-green-600 font-bold mt-1">ÙƒÙˆØ¨ÙˆÙ† (${order.couponCode}) : -${formatCurrency(order.discountAmount)}</div>`; }

            // (Ù…Ù‡Ù…) Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ø¯Ø« Ù„Ø¹Ù…Ø§Ù„ Ø§Ù„ØªÙˆØµÙŠÙ„
            const deliveryPersonnelOptions = deliveryPersonnelCache
                .filter(p => p.status === 'active')
                .map(p => `<option value="${p.id}" ${order.deliveryPersonId === p.id ? 'selected' : ''}>${p.name}</option>`)
                .join('');

            let formattedDate = '';
            if (order.createdAt && typeof order.createdAt.toDate === 'function') {
                const date = order.createdAt.toDate();
                formattedDate = date.toLocaleDateString('ar-EG', { day: '2-digit', month: 'short' }) + ' - ' + date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
            }

            const row = tableBody.insertRow();
            row.className = `border-b ${order.status === 'new' ? 'bg-blue-50' : 'bg-white'}`;
            row.innerHTML = `
                <td data-label="Ø§Ù„Ø¹Ù…ÙŠÙ„" class="p-3"><div class="font-semibold">${order.customerName}</div><div class="text-xs text-gray-500 font-mono">${formattedDate}</div></td>
                <td data-label="Ø§Ù„Ù‡Ø§ØªÙ" class="p-3 font-mono" dir="ltr">${order.customerContact}</td>
                <td data-label="Ø§Ù„Ø·Ù„Ø¨ÙŠØ©" class="p-3 text-sm">${itemsHtml}${couponHtml}</td>
                <td data-label="Ø§Ù„Ù…Ø¨Ù„Øº" class="p-3 font-mono font-bold">${formatCurrency(order.totalPrice)}</td>
                <td data-label="Ø§Ù„Ø­Ø§Ù„Ø©" class="p-3"><select class="order-status-select p-2 rounded-lg ${statusColors[order.status] || ''}" data-id="${order.id}"><option value="new" ${order.status === 'new' ? 'selected' : ''}>Ø¬Ø¯ÙŠØ¯</option><option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Ù…ÙƒØªÙ…Ù„</option><option value="canceled" ${order.status === 'canceled' ? 'selected' : ''}>Ù…Ù„ØºÙŠ</option></select></td>
                <td data-label="Ø¹Ø§Ù…Ù„ Ø§Ù„ØªÙˆØµÙŠÙ„" class="p-3"><select class="delivery-person-select p-2 rounded-lg bg-gray-50 border" data-id="${order.id}"><option value="">-- Ø§Ø®ØªØ± --</option> ${deliveryPersonnelOptions}</select></td>
                <td data-label="Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª" class="p-3 flex items-center gap-4">
                    <button class="print-order-btn text-gray-600 hover:text-black" data-id="${order.id}" title="Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙˆØµÙ„"><i class="fas fa-print fa-lg"></i></button>
                    <button class="pdf-order-btn text-red-500 hover:text-red-700" data-id="${order.id}" title="ØªØ­Ù…ÙŠÙ„ PDF"><i class="fas fa-file-pdf fa-lg"></i></button>
                    <button class="copy-order-btn text-blue-500 hover:text-blue-700" data-id="${order.id}" title="Ù†Ø³Ø®"><i class="fas fa-copy fa-lg"></i></button>
                    <button class="delete-order-btn text-red-500 hover:text-red-700" data-id="${order.id}" title="Ø­Ø°Ù"><i class="fas fa-trash fa-lg"></i></button>
                </td>`;
        });
        attachOrderActionListeners();
    }

    function attachOrderActionListeners() {
        document.querySelectorAll('.order-status-select').forEach(sel => sel.onchange = e => updateDoc(doc(db, "orders", e.target.dataset.id), { status: e.target.value }));
        
        document.querySelectorAll('.delivery-person-select').forEach(sel => sel.onchange = e => {
            const selectedOption = e.target.options[e.target.selectedIndex];
            const personId = selectedOption.value;
            const personName = personId ? selectedOption.text : null;
            updateDoc(doc(db, "orders", e.target.dataset.id), { deliveryPersonId: personId, deliveryPersonName: personName });
        });

        document.querySelectorAll('.delete-order-btn').forEach(btn => btn.onclick = e => {
            const docId = e.currentTarget.dataset.id;
            showDeletionConfirmModal(() => { deleteDoc(doc(db, "orders", docId)).then(() => showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨.', 'success')); });
        });

        document.querySelectorAll('.copy-order-btn').forEach(btn => btn.onclick = e => {
            const order = ordersCache.find(o => o.id === e.currentTarget.dataset.id);
            if (!order) return;
             const itemsText = (order.items || []).map(item => {
                let mainText = `   - ${item.quantity} x ${item.name}`;
                if(item.selectedAddons && item.selectedAddons.length > 0) { const addonsText = item.selectedAddons.map(a => ` (+ ${a.name})`).join(''); mainText += addonsText; }
                return mainText;
            }).join('\n');
            const couponText = order.couponCode ? `\n\nğŸ‰ ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙˆØ¨ÙˆÙ†: ${order.couponCode}\nğŸ’° Ø§Ù„ØªØ®ÙÙŠØ¶: ${formatCurrency(order.discountAmount)}` : '';
            const deliveryPersonText = order.deliveryPersonName ? `\nğŸšš Ø¨ÙˆØ§Ø³Ø·Ø©: ${order.deliveryPersonName}` : '';
            const message = `Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† TEXMEX\n--------------------\nğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${order.customerName}\nğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: ${order.customerContact}\nğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${order.customerLocation}\nğŸ“‹ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©:\n${itemsText}${couponText}\nğŸ’° Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${formatCurrency(order.totalPrice)}${deliveryPersonText}\n--------------------`;
            navigator.clipboard.writeText(message).then(() => showToast('ØªÙ… Ù†Ø³Ø® Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!'));
        });

        document.querySelectorAll('.print-order-btn').forEach(btn => btn.onclick = e => {
            const orderId = e.currentTarget.dataset.id;
            const order = ordersCache.find(o => o.id === orderId);
            if (order) printOrderReceiptHTML(order, orderId);
        });

        document.querySelectorAll('.pdf-order-btn').forEach(btn => btn.onclick = e => {
            const orderId = e.currentTarget.dataset.id;
            const order = ordersCache.find(o => o.id === orderId);
            if (order) downloadOrderReceiptPDF(order, orderId);
        });
    }

</script>

</body>
</html>