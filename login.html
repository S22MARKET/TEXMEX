<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TEXMEX - تسجيل الدخول و إنشاء حساب</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        /* الخط الرئيسي والخلفية */
        body { 
            font-family: 'Tajawal', sans-serif; 
            background-color: #f3f4f6;
            /* منع السحب الزائد في الهواتف */
            overscroll-behavior-y: none; 
        }
        
        /* كلاسات التحميل */
        .loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #ffffff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* تنسيق الأرقام والمدخلات اللاتينية */
        input[type="tel"], 
        input[type="email"], 
        input[type="password"],
        .ltr-input {
            text-align: left;
            direction: ltr;
        }
        
        /* تحسين التركيز */
        .input-focus:focus {
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2);
        }

        /* تحريك ظهور الصندوق */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeInUp 0.5s ease-out forwards;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col justify-center items-center p-4 sm:p-6">

    <div id="message-box" class="fixed top-4 left-4 right-4 mx-auto p-4 rounded-lg shadow-xl text-center text-sm font-bold text-white hidden transition-all duration-300 transform -translate-y-20 max-w-sm z-50">
        الرسالة هنا
    </div>

    <div class="w-full max-w-sm bg-white p-6 rounded-2xl shadow-xl border border-gray-100 animate-fadeIn my-auto">
        
        <div class="text-center mb-6">
            <h1 class="text-3xl font-extrabold text-gray-800 tracking-tight">TEXMEX</h1>
            <p class="text-sm text-gray-500 mt-2" id="sub-title">مرحباً بك مجدداً</p>
        </div>

        <form id="auth-form" class="space-y-4">
            
            <div id="name-field" class="hidden">
                <label for="name" class="block text-sm font-medium text-gray-700 mb-1">الاسم الكامل</label>
                <input type="text" id="name" placeholder="مثال: أحمد محمد" class="input-focus block w-full rounded-lg border-gray-300 border p-3 text-gray-900 placeholder:text-gray-400 focus:outline-none transition-all" autocomplete="name">
            </div>

            <div>
                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">البريد الإلكتروني</label>
                <input type="email" id="email" placeholder="name@example.com" class="input-focus block w-full rounded-lg border-gray-300 border p-3 text-gray-900 placeholder:text-gray-400 focus:outline-none transition-all" required autocomplete="email">
            </div>

            <div>
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">كلمة المرور</label>
                <input type="password" id="password" placeholder="••••••••" class="input-focus block w-full rounded-lg border-gray-300 border p-3 text-gray-900 focus:outline-none transition-all" required autocomplete="current-password">
            </div>

            <div id="phone-field" class="hidden">
                <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">رقم الهاتف <span class="text-xs text-gray-400">(مطلوب)</span></label>
                <input type="tel" id="phone" placeholder="0550123456" class="input-focus block w-full rounded-lg border-gray-300 border p-3 text-gray-900 placeholder:text-gray-400 focus:outline-none transition-all" autocomplete="tel">
            </div>
            
            <div id="referral-field" class="hidden">
                <label for="referral-code" class="block text-sm font-medium text-gray-700 mb-1">رمز دعوة (اختياري)</label>
                <input type="text" id="referral-code" placeholder="CODE123" class="input-focus ltr-input block w-full rounded-lg border-gray-300 border p-3 text-gray-900 placeholder:text-gray-400 focus:outline-none transition-all">
            </div>

            <div id="remember-me-container" class="flex items-center justify-between pt-1">
                <div class="flex items-center cursor-pointer">
                    <input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300 rounded cursor-pointer" checked>
                    <label for="remember-me" class="mr-2 block text-sm text-gray-600 cursor-pointer select-none">
                        تذكرني
                    </label>
                </div>
                <a href="#" id="reset-password-btn" class="text-sm font-medium text-orange-600 hover:text-orange-500">نسيت كلمة المرور؟</a>
            </div>

            <button type="submit" id="submit-button" class="w-full flex justify-center items-center py-3.5 px-4 border border-transparent rounded-xl shadow-md font-bold text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition-all duration-200 mt-6 active:scale-95">
                <span id="button-text">تسجيل الدخول</span>
                <div id="button-loader" class="loader hidden"></div>
            </button>
            
        </form>

        <div class="mt-8 text-center border-t border-gray-100 pt-6">
            <p id="toggle-message" class="text-sm text-gray-600">
                ليس لديك حساب؟
            </p>
            <button id="toggle-mode-btn" class="mt-2 w-full py-2.5 rounded-lg border border-orange-100 text-orange-600 font-bold hover:bg-orange-50 transition-colors focus:outline-none">
                أنشئ حسابك الآن
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, sendPasswordResetEmail, setPersistence, browserSessionPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, writeBatch, Timestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // =========================================================
        // ✅ تم تحديث بيانات التهيئة (Config) بالبيانات الصحيحة ✅
        // =========================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAsG-85oNZq8kzWPHIDpsifkQ7rhua_oPk",
            authDomain: "texmexfoodannaba23.firebaseapp.com",
            projectId: "texmexfoodannaba23",
            storageBucket: "texmexfoodannaba23.firebasestorage.app",
            messagingSenderId: "712480664933",
            appId: "1:712480664933:web:a5310190bf63115ac9058c"
            // ملاحظة: تم إزالة databaseURL و measurementId لأنهما غير مطلوبين للعمليات الحالية.
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- عناصر الواجهة (Elements) ---
        const authForm = document.getElementById('auth-form');
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const buttonLoader = document.getElementById('button-loader');
        const subTitle = document.getElementById('sub-title');
        
        const toggleModeBtn = document.getElementById('toggle-mode-btn');
        const toggleMessage = document.getElementById('toggle-message');
        
        const nameField = document.getElementById('name-field');
        const phoneField = document.getElementById('phone-field');
        const referralField = document.getElementById('referral-field');
        const rememberMeContainer = document.getElementById('remember-me-container');
        const resetPasswordBtn = document.getElementById('reset-password-btn');
        const rememberMeCheckbox = document.getElementById('remember-me');
        
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const nameInput = document.getElementById('name');
        const phoneInput = document.getElementById('phone');
        const referralCodeInput = document.getElementById('referral-code');

        let isRegisterMode = false;

        // --- دوال مساعدة ---

        function showMessage(message, type = 'error', duration = 4000) {
            const msgBox = document.getElementById('message-box');
            msgBox.textContent = message;
            // إزالة جميع كلاسات الألوان وإضافة الكلاس المناسب
            msgBox.classList.remove('hidden', 'bg-red-500', 'bg-green-500', '-translate-y-20');
            
            if (type === 'success') {
                msgBox.classList.add('bg-green-500');
            } else {
                msgBox.classList.add('bg-red-500');
            }
            
            // إظهار الرسالة (تحريكها للأسفل)
            setTimeout(() => {
                msgBox.classList.remove('-translate-y-20');
            }, 10); 

            // إخفاء الرسالة بعد المدة المحددة (تحريكها للأعلى)
            setTimeout(() => {
                msgBox.classList.add('-translate-y-20');
                setTimeout(() => msgBox.classList.add('hidden'), 300);
            }, duration);
        }

        function toggleButtonState(isLoading) {
            submitButton.disabled = isLoading;
            if (isLoading) {
                buttonText.classList.add('hidden');
                buttonLoader.classList.remove('hidden');
                submitButton.classList.add('cursor-not-allowed', 'opacity-80');
            } else {
                buttonText.classList.remove('hidden');
                buttonLoader.classList.add('hidden');
                submitButton.classList.remove('cursor-not-allowed', 'opacity-80');
            }
        }

        function toggleMode() {
            isRegisterMode = !isRegisterMode;

            // مسح الحقول عند التبديل، إلا إذا كان رمز الدعوة موجوداً
            if(!referralCodeInput.value) authForm.reset(); 

            if (isRegisterMode) {
                // وضع التسجيل
                subTitle.textContent = 'أدخل بياناتك للمتابعة';
                buttonText.textContent = 'إنشاء الحساب';
                toggleMessage.textContent = 'لديك حساب بالفعل؟';
                toggleModeBtn.textContent = 'تسجيل الدخول';
                
                nameField.classList.remove('hidden');
                phoneField.classList.remove('hidden');
                referralField.classList.remove('hidden');
                rememberMeContainer.classList.add('hidden');
                
                nameInput.required = true;
                phoneInput.required = true;
                
                // التركيز على حقل الاسم
                setTimeout(() => nameInput.focus(), 100);

            } else {
                // وضع تسجيل الدخول
                subTitle.textContent = 'مرحباً بك مجدداً';
                buttonText.textContent = 'تسجيل الدخول';
                toggleMessage.textContent = 'ليس لديك حساب؟';
                toggleModeBtn.textContent = 'أنشئ حسابك الآن';
                
                nameField.classList.add('hidden');
                phoneField.classList.add('hidden');
                referralField.classList.add('hidden');
                rememberMeContainer.classList.remove('hidden');
                
                nameInput.required = false;
                phoneInput.required = false;
            }
        }

        function redirectToNextPage() {
            const urlParams = new URLSearchParams(window.location.search);
            // التوجيه لصفحة "index.html" أو أي صفحة محددة في رابط "next"
            const nextUrl = urlParams.get('next') || 'index.html';
            window.location.href = nextUrl;
        }

        // --- المنطق الرئيسي لعمليات المصادقة (Auth) ---

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            const name = nameInput.value.trim();
            // تنظيف رقم الهاتف وإزالة المسافات
            const phone = phoneInput.value.trim().replace(/\s/g, ''); 
            const referralCode = referralCodeInput.value.trim().toUpperCase();
            const rememberMe = rememberMeCheckbox.checked;

            if (!email || !password) {
                showMessage('الرجاء تعبئة جميع الحقول المطلوبة.');
                return;
            }

            toggleButtonState(true);

            try {
                if (isRegisterMode) {
                    // === عملية التسجيل ===
                    if (!name || !phone) {
                        showMessage('الرجاء إدخال الاسم ورقم الهاتف.');
                        toggleButtonState(false);
                        return;
                    }
                    
                    // 1. التحقق من تكرار الهاتف باستخدام قواعد البيانات (لضمان رقم فريد)
                    const phoneDocSnap = await getDoc(doc(db, "phoneNumbers", phone));
                    if (phoneDocSnap.exists()) {
                         showMessage('رقم الهاتف هذا مسجل مسبقاً.');
                         toggleButtonState(false);
                         return;
                    }

                    // 2. تحديد وضع الثبات (Persistence) مؤقت لإكمال العملية (إذا أردت تثبيت الجلسة)
                    // يمكن استخدام browserSessionPersistence هنا
                    await setPersistence(auth, browserLocalPersistence);

                    // 3. إنشاء الحساب في Authentication
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const newUser = userCredential.user;
                    
                    // 4. حفظ البيانات في Firestore باستخدام Batch
                    const batch = writeBatch(db);

                    // سجل المستخدم
                    const userDocRef = doc(db, "users", newUser.uid);
                    batch.set(userDocRef, {
                        displayName: name,
                        email: email,
                        phone: phone, 
                        createdAt: Timestamp.now(),
                        loyaltyPoints: 0,
                        referredBy: referralCode || null,
                        referralProcessed: false
                    });

                    // سجل الهاتف (لمنع التكرار لاحقاً)
                    const phoneDocRef = doc(db, "phoneNumbers", phone);
                    batch.set(phoneDocRef, {
                        uid: newUser.uid,
                        registeredAt: Timestamp.now()
                    });
                    
                    await batch.commit();

                    showMessage('تم إنشاء الحساب بنجاح! يتم توجيهك الآن...', 'success', 2000);
                    setTimeout(redirectToNextPage, 2000);

                } else {
                    // === عملية تسجيل الدخول ===
                    const persistenceMode = rememberMe ? browserLocalPersistence : browserSessionPersistence;
                    await setPersistence(auth, persistenceMode);
                    
                    await signInWithEmailAndPassword(auth, email, password);
                    
                    showMessage('تم تسجيل الدخول بنجاح', 'success', 1000);
                    setTimeout(redirectToNextPage, 1000);
                }

            } catch (error) {
                console.error("Auth Error:", error);
                // رسائل خطأ أكثر وضوحاً
                let errorMessage = 'حدث خطأ غير متوقع. الرجاء التأكد من الإعدادات أو جودة الاتصال.';

                switch(error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                    case 'auth/invalid-credential':
                        errorMessage = 'البريد الإلكتروني أو كلمة المرور غير صحيحة.';
                        break;
                    case 'auth/email-already-in-use':
                        errorMessage = 'هذا البريد مسجل بالفعل. حاول تسجيل الدخول.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'صيغة البريد الإلكتروني غير صحيحة.';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'كلمة المرور ضعيفة (يجب أن تكون 6 أحرف على الأقل).';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'تأكد من اتصالك بالإنترنت.';
                        break;
                }
                showMessage(errorMessage);
            } finally {
                toggleButtonState(false);
            }
        });

        // --- استعادة كلمة المرور ---
        resetPasswordBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            const email = emailInput.value.trim();
            if (!email) {
                showMessage('أدخل بريدك الإلكتروني في الحقل المخصص أولاً.');
                emailInput.focus();
                return;
            }

            if (!confirm(`إرسال رابط استعادة كلمة المرور إلى: ${email}؟`)) return;

            toggleButtonState(true);
            try {
                await sendPasswordResetEmail(auth, email);
                showMessage('تم إرسال الرابط. تحقق من بريدك (والمجلدات المهملة).', 'success', 5000);
            } catch (error) {
                showMessage('فشل الإرسال. تأكد من صحة البريد.');
            } finally {
                toggleButtonState(false);
            }
        });

        // --- معالجة تبديل الوضع (Login/Register) ---
        toggleModeBtn.addEventListener('click', toggleMode);

        // --- التحقق من الجلسة ---
        onAuthStateChanged(auth, (user) => {
            submitButton.disabled = false;
            if (user) {
                redirectToNextPage();
            }
        });

        // --- معالجة روابط الدعوة ---
        const urlParams = new URLSearchParams(window.location.search);
        const referralCodeParam = urlParams.get('referral');

        if (referralCodeParam) {
            // التبديل فوراً لوضع التسجيل
            toggleMode();
            // تعبئة الكود تلقائياً
            referralCodeInput.value = referralCodeParam;
        }

    </script>
</body>
</html>