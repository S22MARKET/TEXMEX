<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEXMEX - ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        /* Ø§Ù„Ø®Ø· Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙˆØ§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù†Ø¸ÙŠÙØ© */
        body { 
            font-family: 'Tajawal', sans-serif; 
            background-color: #f8f8f8; /* Ø®Ù„ÙÙŠØ© ÙØ§ØªØ­Ø© ÙˆÙ†Ø¸ÙŠÙØ© */
        }
        /* ÙƒÙ„Ø§Ø³Ø§Øª Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø®ØµØµØ© Ù„Ù„ØªØ­Ù…ÙŠÙ„ */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* ØªØµÙ…ÙŠÙ… Ù…Ø®ØµØµ Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ø£Ø±Ù‚Ø§Ù… (Ù„Ù„Ù‡Ø§ØªÙ ÙˆØ±Ù…Ø² Ø§Ù„Ø¯Ø¹ÙˆØ©) */
        input[type="tel"], input[type="text"][dir="ltr"] {
            text-align: left;
        }
        
        /* ØªØ£Ø«ÙŠØ± Ø§Ù„ØªØ±ÙƒÙŠØ² Ø§Ù„Ø­Ø¯ÙŠØ« Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª */
        .input-focus:focus {
            border-color: #f97316; /* Ù„ÙˆÙ† Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ (TEXMEX) */
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.3);
        }
    </style>
</head>

<body class="min-h-screen flex flex-col justify-center items-center p-4">

    <div id="message-box" class="fixed top-0 inset-x-0 mx-auto p-4 rounded-b-lg shadow-lg text-center text-sm hidden transition-all duration-300 transform -translate-y-full max-w-sm" style="z-index: 99;">
        Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù‡Ù†Ø§
    </div>

    <div class="w-full max-w-sm bg-white p-6 md:p-8 rounded-2xl shadow-2xl border border-gray-100 animate-fadeIn">
        
        <div class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-gray-800 tracking-tight">TEXMEX</h1>
            <p class="text-sm text-gray-500 mt-1" id="sub-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</p>
        </div>

        <form id="auth-form" class="space-y-4">
            
            <div id="name-field" class="hidden">
                <label for="name" class="block text-sm font-medium text-gray-700">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                <div class="relative mt-1 rounded-md shadow-sm">
                    <input type="text" id="name" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯" class="input-focus block w-full rounded-md border-gray-300 border p-3 text-gray-900 placeholder:text-gray-400 focus:outline-none" required>
                </div>
            </div>

            <div>
                <label for="email" class="block text-sm font-medium text-gray-700">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                <div class="relative mt-1 rounded-md shadow-sm">
                    <input type="email" id="email" placeholder="name@example.com" class="input-focus block w-full rounded-md border-gray-300 border p-3 text-gray-900 placeholder:text-gray-400 focus:outline-none" required>
                </div>
            </div>

            <div>
                <label for="password" class="block text-sm font-medium text-gray-700">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <div class="relative mt-1 rounded-md shadow-sm">
                    <input type="password" id="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="input-focus block w-full rounded-md border-gray-300 border p-3 text-gray-900 focus:outline-none" required>
                </div>
            </div>

            <div id="phone-field" class="hidden">
                <label for="phone" class="block text-sm font-medium text-gray-700">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ <span class="text-xs text-gray-500">(Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª)</span></label>
                <div class="relative mt-1 rounded-md shadow-sm">
                    <input type="tel" id="phone" placeholder="Ù…Ø«Ø§Ù„: 0550123456" class="input-focus block w-full rounded-md border-gray-300 border p-3 text-gray-900 placeholder:text-gray-400 focus:outline-none" dir="ltr">
                </div>
            </div>
            
            <div id="referral-field" class="hidden">
                <label for="referral-code" class="block text-sm font-medium text-gray-700">Ø±Ù…Ø² Ø¯Ø¹ÙˆØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <div class="relative mt-1 rounded-md shadow-sm">
                    <input type="text" id="referral-code" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ø¯Ø¹ÙˆØ© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø·" class="input-focus block w-full rounded-md border-gray-300 border p-3 text-gray-900 placeholder:text-gray-400 focus:outline-none" dir="ltr">
                </div>
            </div>

            <div id="remember-me-container" class="flex items-center justify-between">
                <div class="flex items-center">
                    <input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300 rounded" checked>
                    <label for="remember-me" class="mr-2 block text-sm text-gray-900">
                        ØªØ°ÙƒØ±Ù†ÙŠ (ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø³Ø±ÙŠØ¹)
                    </label>
                </div>
            </div>


            <button type="submit" id="submit-button" class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-lg font-bold text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-4 focus:ring-orange-300 transition-colors duration-200 mt-6" disabled>
                <span id="button-text">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
                <div id="button-loader" class="loader hidden mr-2"></div>
            </button>
            
            <div id="forgot-password-link" class="text-center pt-2">
                <a href="#" id="reset-password-btn" class="text-sm font-medium text-orange-600 hover:text-orange-500">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</a>
            </div>

        </form>

        <div class="mt-6 text-center border-t pt-4">
            <p id="toggle-message" class="text-sm text-gray-600">
                Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ
                <button id="toggle-mode-btn" class="font-bold text-orange-600 hover:text-orange-500 focus:outline-none">
                    Ø£Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø¢Ù†!
                </button>
            </p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
        // ğŸ’¡ ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ setPersistence Ùˆ browserSessionPersistence Ùˆ browserLocalPersistence
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, sendPasswordResetEmail, setPersistence, browserSessionPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, writeBatch, Timestamp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore.js";

        // âš ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
        // ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
        const authForm = document.getElementById('auth-form');
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const buttonLoader = document.getElementById('button-loader');
        const subTitle = document.getElementById('sub-title');
        const toggleModeBtn = document.getElementById('toggle-mode-btn');
        const toggleMessage = document.getElementById('toggle-message');
        const nameField = document.getElementById('name-field');
        const phoneField = document.getElementById('phone-field');
        const referralField = document.getElementById('referral-field');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const resetPasswordBtn = document.getElementById('reset-password-btn');
        const rememberMeCheckbox = document.getElementById('remember-me'); // ğŸ’¡ Ø¬Ø¯ÙŠØ¯
        const rememberMeContainer = document.getElementById('remember-me-container'); // ğŸ’¡ Ø¬Ø¯ÙŠØ¯
        
        // Ø§Ù„Ø­Ù‚ÙˆÙ„
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const nameInput = document.getElementById('name');
        const phoneInput = document.getElementById('phone');
        const referralCodeInput = document.getElementById('referral-code');

        let isRegisterMode = false;

        // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ---

        /** Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© (Ù†Ø¬Ø§Ø­ Ø£Ùˆ Ø®Ø·Ø£) ÙÙŠ ØµÙ†Ø¯ÙˆÙ‚ Ø¹Ù„ÙˆÙŠ Ù…ØªØ­Ø±Ùƒ */
        function showMessage(message, type = 'error', duration = 3000) {
            const msgBox = document.getElementById('message-box');
            msgBox.textContent = message;
            msgBox.classList.remove('hidden', 'bg-red-500', 'bg-green-500', '-translate-y-full');
            
            if (type === 'success') {
                msgBox.classList.add('bg-green-500');
            } else {
                msgBox.classList.add('bg-red-500');
            }
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            setTimeout(() => {
                msgBox.classList.add('translate-y-0');
            }, 10); 

            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
            setTimeout(() => {
                msgBox.classList.remove('translate-y-0');
                msgBox.classList.add('-translate-y-full');
            }, duration);
        }

        /** ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹ Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        function toggleButtonState(isLoading) {
            submitButton.disabled = isLoading;
            if (isLoading) {
                buttonText.classList.add('hidden');
                buttonLoader.classList.remove('hidden');
            } else {
                buttonText.classList.remove('hidden');
                buttonLoader.classList.add('hidden');
            }
        }

        /** Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ùˆ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ */
        function toggleMode() {
            isRegisterMode = !isRegisterMode;

            if (isRegisterMode) {
                // ÙˆØ¶Ø¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                subTitle.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
                buttonText.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
                toggleMessage.innerHTML = 'Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ <button id="toggle-mode-btn-inner" class="font-bold text-orange-600 hover:text-orange-500 focus:outline-none">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>';
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ¥Ø®ÙØ§Ø¡ "ØªØ°ÙƒØ±Ù†ÙŠ"
                nameField.classList.remove('hidden');
                phoneField.classList.remove('hidden');
                referralField.classList.remove('hidden');
                forgotPasswordLink.classList.add('hidden');
                rememberMeContainer.classList.add('hidden'); // ğŸ’¡ Ø¥Ø®ÙØ§Ø¡
                nameInput.required = true;
                phoneInput.required = true;
            } else {
                // ÙˆØ¶Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                subTitle.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
                buttonText.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
                toggleMessage.innerHTML = 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <button id="toggle-mode-btn-inner" class="font-bold text-orange-600 hover:text-orange-500 focus:outline-none">Ø£Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø¢Ù†!</button>';
                
                // Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± "ØªØ°ÙƒØ±Ù†ÙŠ"
                nameField.classList.add('hidden');
                phoneField.classList.add('hidden');
                referralField.classList.add('hidden');
                forgotPasswordLink.classList.remove('hidden');
                rememberMeContainer.classList.remove('hidden'); // ğŸ’¡ Ø¥Ø¸Ù‡Ø§Ø±
                nameInput.required = false;
                phoneInput.required = false;
            }
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ù„Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ innerHTML
            document.getElementById('toggle-mode-btn-inner').onclick = toggleMode;
        }

        /** Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© */
        function redirectToNextPage() {
            const urlParams = new URLSearchParams(window.location.search);
            const nextUrl = urlParams.get('next') || 'index.html';
            window.location.href = nextUrl;
        }

        // --- Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Submit Handler) ---

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            const name = nameInput.value.trim();
            const phone = phoneInput.value.trim().replace(/\s/g, ''); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª
            const referralCode = referralCodeInput.value.trim().toUpperCase();
            const rememberMe = rememberMeCheckbox.checked; // ğŸ’¡ Ø­Ø§Ù„Ø© Ø§Ù„Ù€ checkbox

            if (!email || !password) {
                showMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.');
                return;
            }

            toggleButtonState(true);

            try {
                if (isRegisterMode) {
                    // --- 1. ÙˆØ¶Ø¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Register) ---
                    
                    if (!name || !phone) {
                        showMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù„ØªØ³Ø¬ÙŠÙ„.');
                        toggleButtonState(false);
                        return;
                    }
                    
                    // ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± Ù…Ø³Ø¬Ù„
                    const phoneDocSnap = await getDoc(doc(db, "phoneNumbers", phone));
                    if (phoneDocSnap.exists()) {
                         showMessage('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù‡Ø°Ø§ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ø¢Ø®Ø± Ø£Ùˆ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.');
                         toggleButtonState(false);
                         return;
                    }

                    // ğŸ’¡ Ù‡Ù†Ø§ Ù†Ø³ØªØ®Ø¯Ù… persistence Ù…Ø¤Ù‚ØªØ© Ù„Ù„Ø¬Ù„Ø³Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                    await setPersistence(auth, browserSessionPersistence);

                    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ ÙÙŠ Firebase Auth
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const newUser = userCredential.user;
                    const batch = writeBatch(db);

                    // Ø§Ù„Ø¹Ù…Ù„ÙŠØ© 1: Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firestore
                    const userDocRef = doc(db, "users", newUser.uid);
                    batch.set(userDocRef, {
                        displayName: name,
                        email: email,
                        phone: phone, 
                        createdAt: Timestamp.now(),
                        purchaseHistory: [], 
                        loyaltyPoints: 0,
                        referralCode: null, 
                        referredBy: referralCode || null,
                        referralProcessed: false
                    });

                    // Ø§Ù„Ø¹Ù…Ù„ÙŠØ© 2: Ø­Ø¬Ø² Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙÙŠ 'phoneNumbers'
                    const phoneDocRef = doc(db, "phoneNumbers", phone);
                    batch.set(phoneDocRef, {
                        uid: newUser.uid,
                        registeredAt: Timestamp.now()
                    });
                    
                    await batch.commit();

                    showMessage('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­! ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡Ùƒ Ø§Ù„Ø¢Ù†...', 'success', 2000);
                    // Ù‡Ù†Ø§ Ø³Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ onAuthStateChanged Ù„Ù„ØªÙˆØ¬ÙŠÙ‡
                    // ÙˆÙ„ÙƒÙ† ÙŠÙØ¶Ù„ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙÙŠ Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ù€ batch.commit
                    setTimeout(redirectToNextPage, 2000); 

                } else {
                    // --- 2. ÙˆØ¶Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Login) ---
                    
                    // ğŸ’¡ ØªØ­Ø¯ÙŠØ¯ ÙˆØ¶Ø¹ Persistence Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø®Ø§ØµÙŠØ© "ØªØ°ÙƒØ±Ù†ÙŠ"
                    const persistenceMode = rememberMe ? browserLocalPersistence : browserSessionPersistence;
                    await setPersistence(auth, persistenceMode);
                    
                    // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    await signInWithEmailAndPassword(auth, email, password);
                    
                    showMessage('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­! ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡Ùƒ...', 'success', 1000);
                    // Ù‡Ù†Ø§ Ø³Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ onAuthStateChanged Ù„Ù„ØªÙˆØ¬ÙŠÙ‡
                    setTimeout(redirectToNextPage, 1000);
                }

            } catch (error) {
                console.error("Auth Error:", error.code, error.message);
                let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';

                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.';
                } else if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'ØµÙŠØºØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹ (ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„).';
                }

                showMessage(errorMessage);
            } finally {
                toggleButtonState(false);
            }
        });

        // --- Ù…Ø¹Ø§Ù„Ø¬Ø© Ù†Ø³ÙŠØ§Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ---
        resetPasswordBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            const email = emailInput.value.trim();
            if (!email) {
                showMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£ÙˆÙ„Ø§Ù‹ ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù„ØªÙ„Ù‚ÙŠ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†.');
                return;
            }

            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ù„Ù‰: ${email}ØŸ`)) {
                return;
            }

            toggleButtonState(true);
            try {
                await sendPasswordResetEmail(auth, email);
                showMessage(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: ${email}`, 'success', 5000);
            } catch (error) {
                console.error("Password Reset Error:", error.code, error.message);
                showMessage('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.');
            } finally {
                toggleButtonState(false);
            }
        });


        // --- Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ (Login/Register) ---
        toggleModeBtn.addEventListener('click', toggleMode);

        // --- Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹) ---
        onAuthStateChanged(auth, (user) => {
            // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù…Ø¬Ø±Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Firebase
            submitButton.disabled = false;
            if (user) {
                // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ù‡ Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ù‚Ù… Ø¨ØªÙˆØ¬ÙŠÙ‡Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹
                redirectToNextPage();
            }
        });

        // --- (Ø¬Ø¯ÙŠØ¯) Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ ÙˆØ¶Ø¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¥Ø°Ø§ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø¯Ø¹ÙˆØ© ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· ---
        if (new URLSearchParams(window.location.search).has('referral')) {
            toggleMode();
        }

    </script>
</body>
</html>