<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEXMEX - ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙˆØµÙŠÙ„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #111827; color: #f3f4f6; }
        .spinner-dark { width: 48px; height: 48px; border: 5px solid rgba(255, 255, 255, 0.2); border-top-color: #f97316; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .time-badge { padding: 4px 12px; border-radius: 9999px; font-weight: bold; font-size: 0.9rem; min-width: 70px; text-align: center; }
        .time-badge.new { background-color: #10b981; color: white; }
        .time-badge.medium { background-color: #f59e0b; color: white; }
        .time-badge.old { background-color: #ef4444; color: white; }
    </style>
</head>
<body>

    <header class="bg-gray-900 shadow-md p-4 flex justify-between items-center sticky top-0 z-30">
        <div class="flex items-center gap-3">
            <h1 class="text-xl font-bold">TEX<span class="text-orange-500">MEX</span> Driver</h1>
            <span id="connection-status" class="h-3 w-3 bg-green-500 rounded-full animate-pulse"></span>
        </div>
        <button id="logout-btn" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬" class="text-red-400 hover:text-red-500 text-xl">
            <i class="fas fa-sign-out-alt"></i>
        </button>
    </header>

    <main class="p-4">
        <div class="mb-4">
            <h2 class="text-2xl font-bold">Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ <span id="driver-name" class="text-orange-400">...</span></h2>
            <p class="text-gray-400">Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙŠ ØªÙ… ØªØ¹ÙŠÙŠÙ†Ù‡Ø§ Ù„Ùƒ.</p>
        </div>

        <div id="orders-list" class="space-y-4">
            </div>

        <div id="loader" class="text-center py-20">
            <div class="spinner-dark mx-auto"></div>
            <p class="mt-4 text-gray-400">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©...</p>
        </div>

        <div id="no-orders-msg" class="hidden text-center py-20">
            <i class="fas fa-box-open text-6xl text-gray-600"></i>
            <p class="mt-4 text-2xl font-bold text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹ÙŠÙ†Ø© Ù„Ùƒ Ø­Ø§Ù„ÙŠÙ‹Ø§.</p>
            <p class="text-gray-500">Ø§Ù†ØªØ¸Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠØ±.</p>
        </div>
    </main>
    
    <audio id="notification-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-notification-947.mp3" preload="auto"></audio>

<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, updateDoc, doc, where, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAsG-85oNZq8kzWPHIDpsifkQ7rhua_oPk",
            authDomain: "texmexfoodannaba23.firebaseapp.com",
            projectId: "texmexfoodannaba23",
            storageBucket: "texmexfoodannaba23.appspot.com",
            messagingSenderId: "712480664933",
            appId: "1:712480664933:web:a5310190bf63115ac9058c",
            measurementId: "G-38D210X1EG"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const driverId = localStorage.getItem('driver_id');
        const driverName = localStorage.getItem('driver_name');

        const loader = document.getElementById('loader');
        const noOrdersMsg = document.getElementById('no-orders-msg');
        const ordersList = document.getElementById('orders-list');
        const notificationSound = document.getElementById('notification-sound');

        // --- 1. Ø­Ø§Ø±Ø³ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ---
        if (!driverId) {
            window.location.href = 'driver_login.html';
        } else {
            document.getElementById('driver-name').textContent = driverName || 'Ø¹Ø§Ù…Ù„ Ø§Ù„ØªÙˆØµÙŠÙ„';
            initializeDriverView();
        }

        // --- 2. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ---
        document.getElementById('logout-btn').onclick = () => {
            localStorage.removeItem('driver_id');
            localStorage.removeItem('driver_name');
            window.location.href = 'driver_login.html';
        };

        function initializeDriverView() {
            loadAssignedOrders();
        }

        function loadAssignedOrders() {
            const statusIndicator = document.getElementById('connection-status');
            
            // ğŸ’¡ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹ÙŠÙ†Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø³Ø§Ø¦Ù‚ + Ø§Ù„ØªÙŠ Ù‡ÙŠ Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ± Ø£Ùˆ Ø¬Ø¯ÙŠØ¯Ø©
            // (Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠØ¹ÙŠÙ† Ø§Ù„Ø¹Ø§Ù…Ù„ ÙˆØ§Ù„Ø·Ù„Ø¨ 'Ø¬Ø¯ÙŠØ¯' Ø£Ùˆ 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±')
            const q = query(
                collection(db, "orders"), 
                where("deliveryPersonId", "==", driverId),
                where("status", "in", ["new", "preparing"]),
                orderBy("createdAt", "desc")
            );

            onSnapshot(q, (snapshot) => {
                statusIndicator.classList.remove('bg-red-500'); 
                statusIndicator.classList.add('bg-green-500', 'animate-pulse');
                
                loader.classList.add('hidden');
                ordersList.innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©

                if (snapshot.empty) {
                    noOrdersMsg.classList.remove('hidden');
                    return;
                }

                noOrdersMsg.classList.add('hidden');
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                if (snapshot.docChanges().some(c => c.type === "added")) {
                    notificationSound.play().catch(e => console.warn("Audio play blocked by browser."));
                }

                snapshot.docs.forEach(doc => {
                    const order = { id: doc.id, ...doc.data() };
                    const card = createOrderCard(order);
                    ordersList.appendChild(card);
                });

                attachActionListeners();

            }, (error) => {
                console.error("Firestore snapshot error: ", error);
                statusIndicator.classList.remove('bg-green-500', 'animate-pulse'); 
                statusIndicator.classList.add('bg-red-500');
                loader.innerHTML = '<p class="text-red-400">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„. Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.</p>';
            });
        }
        
        function calculateTimeSince(timestamp) {
            if (!timestamp?.toDate) return { text: '...', class: 'new' };
            const diffMinutes = Math.floor((new Date() - timestamp.toDate()) / 60000);
            if (diffMinutes < 5) return { text: `Ù…Ù†Ø° ${diffMinutes} Ø¯`, class: 'new' };
            if (diffMinutes < 15) return { text: `Ù…Ù†Ø° ${diffMinutes} Ø¯`, class: 'medium' };
            return { text: `Ù…Ù†Ø° ${diffMinutes} Ø¯`, class: 'old' };
        }

        function createOrderCard(order) {
            const card = document.createElement('div');
            card.className = `bg-gray-800 rounded-xl shadow-lg border-l-4 ${order.status === 'new' ? 'border-blue-500' : 'border-yellow-500'}`;
            
            const timeSince = calculateTimeSince(order.createdAt);
            const formattedPrice = (order.totalPrice || 0).toLocaleString('fr-DZ');

            const itemsHtml = (order.items || []).map(item => {
                let addons = (item.selectedAddons || []).map(a => `<li class="text-xs text-gray-400 mr-2">+ ${a.name}</li>`).join('');
                if(addons) addons = `<ul class="pr-4">${addons}</ul>`;
                return `<div class="mb-1">
                            <span class="font-semibold text-gray-100">${item.quantity} x ${item.name}</span>
                            ${addons}
                        </div>`;
            }).join('');
            
            // ğŸ’¡ Ø²Ø± Ù„ÙØªØ­ Ø®Ø±Ø§Ø¦Ø· Ø¬ÙˆØ¬Ù„
            // (Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ø§ Ø³ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø£ÙØ¶Ù„ Ø¨Ø¹Ø¯ ØªØ·Ø¨ÙŠÙ‚ Ù†Ø¸Ø§Ù… Ø§Ù„Ø®Ø±Ø§Ø¦Ø· ÙÙŠ index.html)
            const locationLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(order.customerLocation)}`;

            card.innerHTML = `
                <div class="p-4">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-2xl font-bold text-white">${order.customerName}</span>
                        <span class="time-badge ${timeSince.class}">${timeSince.text}</span>
                    </div>
                    
                    <div class="space-y-2 mb-4">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-phone-alt text-cyan-400 w-4 text-center"></i>
                            <a href="tel:${order.customerContact}" class="text-lg font-semibold text-cyan-400" dir="ltr">${order.customerContact}</a>
                        </div>
                        <div class="flex items-center gap-3">
                            <i class="fas fa-map-marker-alt text-red-400 w-4 text-center"></i>
                            <span class="text-md text-gray-200">${order.customerLocation}</span>
                        </div>
                    </div>
                    
                    <div class="bg-gray-900 p-3 rounded-md mb-4">
                        <h4 class="font-bold mb-2 text-orange-400">Ø§Ù„Ø·Ù„Ø¨ÙŠØ©:</h4>
                        ${itemsHtml}
                    </div>
                    
                    <div class="text-left">
                        <span class="text-3xl font-extrabold text-orange-400">${formattedPrice} Ø¯.Ø¬</span>
                    </div>
                </div>
                
                <div classs="bg-gray-900 p-3 grid grid-cols-2 gap-2 rounded-b-xl">
                    <a href="${locationLink}" target="_blank" class="col-span-2 text-center w-full p-3 font-bold rounded-lg bg-blue-600 hover:bg-blue-700 text-white flex items-center justify-center gap-2">
                        <i class="fas fa-map-signs"></i>
                        <span>ÙØªØ­ Ø§Ù„Ø®Ø±ÙŠØ·Ø© (Google Maps)</span>
                    </a>
                    <button class="action-btn w-full p-3 font-bold rounded-lg bg-yellow-500 hover:bg-yellow-600 text-black" data-id="${order.id}" data-status="preparing">
                        <i class="fas fa-motorcycle"></i> Ø§Ø³ØªÙ„Ù…Øª (ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚)
                    </button>
                    <button class="action-btn w-full p-3 font-bold rounded-lg bg-green-600 hover:bg-green-700 text-white" data-id="${order.id}" data-status="completed">
                        <i class="fas fa-check-circle"></i> ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…
                    </button>
                </div>
            `;
            return card;
        }

        function attachActionListeners() {
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.onclick = async (e) => {
                    const btn = e.currentTarget;
                    const orderId = btn.dataset.id;
                    const newStatus = btn.dataset.status;

                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...Ø¬Ø§Ø±ÙŠ';

                    try {
                        await updateDoc(doc(db, "orders", orderId), { 
                            status: newStatus 
                        });
                        // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
                        // Ø¨Ù…Ø¬Ø±Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©ØŒ onSnapshot Ø³ÙŠØ¹ÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                        // ÙˆØ³ÙŠØ®ØªÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©.
                    } catch (error) {
                        console.error("Error updating status: ", error);
                        btn.disabled = false;
                        btn.innerHTML = newStatus === 'preparing' ? 'Ø§Ø³ØªÙ„Ù…Øª (ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚)' : 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…';
                        alert("Ø­Ø¯Ø« Ø®Ø·Ø£. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
                    }
                };
            });
        }

    </script>
</body>
</html>